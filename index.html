<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <meta name="theme-color" content="#F5F5F7">
    <title>Study Spark | Ultimate Workspace</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <style>
.btn-danger {
    background: rgba(255, 59, 48, 0.08); /* Very subtle red background */
    color: var(--accent-red);
    padding: 10px 24px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-danger:hover {
    background: var(--accent-red);
    color: white;
    box-shadow: 0 8px 20px -6px rgba(255, 59, 48, 0.4);
    transform: translateY(-2px);
    border-color: transparent;
}

.btn-danger:active {
    transform: scale(0.96);
}

/* UPDATE: Ensure Sidebar Transition is smooth for PC */
.app-layout {
    display: grid;
    /* We change this to allow animating the grid column */
    grid-template-columns: var(--sidebar-width) 1fr;
    height: 100vh;
    width: 100vw;
    overflow: hidden;
    transition: grid-template-columns 0.4s var(--ease-spring);
}

.app-layout.collapsed {
    /* When collapsed on PC, sidebar takes 0 width */
    grid-template-columns: 0px 1fr;
}

/* Ensure sidebar content disappears smoothly when collapsed */
.app-layout.collapsed .sidebar {
    opacity: 0;
    transform: translateX(-20px);
    pointer-events: none;
}
        /* -------------------------------------------------------------------------- */
        /* VARIABLES                                                                  */
        /* -------------------------------------------------------------------------- */
        :root {
            /* Light Mode (Standard) */
            --bg-body: #F5F5F7;
            --bg-sidebar: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-glass: rgba(255, 255, 255, 0.75);
            --bg-glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --bg-input: rgba(0, 0, 0, 0.04);
            --bg-hover: rgba(0, 0, 0, 0.03);
            
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --text-tertiary: #B0B0B5;
            
            --border-color: rgba(0,0,0,0.06);

            /* Accents */
            --accent-blue: #0071e3;
            --accent-blue-soft: rgba(0, 113, 227, 0.15);
            --accent-purple: #5e5ce6;
            --accent-green: #34c759;
            --accent-green-soft: rgba(52, 199, 89, 0.15);
            --accent-orange: #ff9f0a;
            --accent-red: #ff3b30;

            /* Shadows & Effects */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.12);
            --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.05);
            
            /* Dimensions */
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --header-height: 80px;
            --sidebar-width: 400px;
            
            /* Animations */
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-smooth: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* -------------------------------------------------------------------------- */
        /* DARK MODE (HIGH CONTRAST OLED)                                     */
        /* -------------------------------------------------------------------------- */
        body.dark-mode {
            /* Backgrounds: Deep, rich blacks for high contrast */
            --bg-body: #000000; 
            --bg-sidebar: #121212;
            --bg-card: #1C1C1E;
            --bg-glass: rgba(20, 20, 20, 0.85);
            --bg-glass-border: 1px solid rgba(255, 255, 255, 0.15);
            
            /* Inputs */
            --bg-input: #2C2C2E;
            --bg-hover: #3A3A3C;
            
            /* Text */
            --text-primary: #FFFFFF;
            --text-secondary: #E5E5E5;
            --text-tertiary: #8E8E93;
            
            /* Borders */
            --border-color: #38383A;
            
            /* Accents */
            --accent-blue: #0A84FF;
            --accent-blue-soft: rgba(10, 132, 255, 0.25);
            --accent-purple: #BF5AF2;
            --accent-green: #30D158;
            --accent-green-soft: rgba(48, 209, 88, 0.25);
            --accent-orange: #FF9F0A;
            --accent-red: #FF453A;
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.7);
        }

        /* -------------------------------------------------------------------------- */
        /* RESET                                                                  */
        /* -------------------------------------------------------------------------- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden;
        }

        input, button, textarea { font-family: inherit; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; padding: 0; margin: 0; }
        h1, h2, h3, h4, h5, h6, p { margin: 0; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Input Number Reset */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        /* -------------------------------------------------------------------------- */
        /* TYPOGRAPHY                                                                 */
        /* -------------------------------------------------------------------------- */
        .text-h1 { font-size: 2.5rem; font-weight: 800; letter-spacing: -0.03em; line-height: 1.1; }
        .text-h2 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; }
        .text-h3 { font-size: 1.2rem; font-weight: 600; letter-spacing: -0.01em; }
        .text-body { font-size: 1rem; line-height: 1.5; color: var(--text-secondary); }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; }
        
        /* -------------------------------------------------------------------------- */
        /* ANIMATIONS                                                                 */
        /* -------------------------------------------------------------------------- */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes expandHeight { from { max-height: 0; opacity: 0; } to { max-height: 600px; opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes highlightPulse { 
            0% { box-shadow: 0 0 0 0 var(--accent-blue-soft); transform: scale(1); } 
            50% { box-shadow: 0 0 0 6px var(--accent-blue-soft); transform: scale(1.02); border-color: var(--accent-blue); } 
            100% { box-shadow: 0 0 0 0 transparent; transform: scale(1); } 
        }

        .animate-in { animation: fadeInUp 0.5s var(--ease-spring) forwards; }
        .animate-spin { animation: spin 1s linear infinite; }
        .highlight-task { animation: highlightPulse 0.8s ease-in-out; border-color: var(--accent-blue) !important; }
        
        /* -------------------------------------------------------------------------- */
        /* LAYOUT                                                                     */
        /* -------------------------------------------------------------------------- */
        .app-layout {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            transition: grid-template-columns 0.4s var(--ease-spring);
        }

        .app-layout.collapsed { grid-template-columns: 0px 1fr; }

        /* -------------------------------------------------------------------------- */
        /* SIDEBAR                                                                    */
        /* -------------------------------------------------------------------------- */
        .sidebar {
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 32px;
            z-index: 50;
            transition: transform 0.4s var(--ease-spring), opacity 0.3s;
            position: relative;
            overflow: hidden;
        }

        .app-layout.collapsed .sidebar {
            transform: translateX(-50px);
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px;
        }

        /* Random Task Button */
        .btn-random {
            background: var(--bg-input); color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 6px 12px; border-radius: 8px; font-size: 0.8rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-random:hover { background: var(--text-primary); color: var(--bg-body); border-color: var(--text-primary); }

        /* Task Input Area */
        .task-input-container {
            background: var(--bg-body);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
        }

        .task-input-container:focus-within {
            background: var(--bg-card);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px var(--accent-blue-soft);
        }

        .task-main-input {
            width: 100%; border: none; background: transparent;
            font-size: 1rem; color: var(--text-primary);
            padding: 8px 0; margin-bottom: 12px;
        }
        .task-main-input::placeholder { color: var(--text-tertiary); }

        .task-meta-row { display: flex; justify-content: space-between; align-items: center; }

        .days-input-wrapper {
            display: flex; align-items: center; gap: 8px;
            background: var(--bg-input);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
        }

        .days-input {
            width: 40px; background: transparent; border: none;
            text-align: center; font-weight: 600; color: var(--text-primary);
        }

        /* Color Dots */
        .color-picker { display: flex; gap: 8px; margin-top: 12px; }
        .color-dot {
            width: 24px; height: 24px; border-radius: 50%;
            cursor: pointer; transition: transform 0.3s var(--ease-spring);
            border: 2px solid transparent; position: relative;
        }
        .color-dot:hover { transform: scale(1.2); }
        .color-dot.active { transform: scale(1.25); border-color: var(--text-primary); }
        .color-dot::after {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            background: inherit; opacity: 0.5; filter: blur(4px); z-index: -1;
        }

        /* Task List */
        .task-list-wrapper { flex: 1; overflow-y: auto; padding-right: 4px; }
        
        /* UPDATED TASK TAB STYLE */
        .task-item {
            display: flex; align-items: center; gap: 14px;
            background: var(--bg-card);
            padding: 18px; margin-bottom: 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: grab; position: relative;
            overflow: hidden;
            min-height: 64px; /* Better for touch */
        }
        .task-item:hover { transform: translateX(4px) scale(1.005); box-shadow: var(--shadow-md); border-color: var(--accent-blue); }
        .task-item:active { cursor: grabbing; transform: scale(0.98); }

        .task-item::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px;
            background: var(--task-color, var(--accent-blue));
            transition: width 0.2s;
        }
        .task-item:hover::before { width: 8px; }

        .checkbox {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid var(--text-tertiary);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s var(--ease-spring);
            flex-shrink: 0; color: white;
        }
        .checkbox:hover { border-color: var(--accent-green); background: var(--accent-green-soft); }
        .checkbox.checked { background: var(--accent-green); border-color: var(--accent-green); }
        
        .task-content { flex: 1; min-width: 0; }
        
        /* HOVER TO SHOW ALL TEXT */
        .task-text { 
            font-weight: 500; 
            margin-bottom: 2px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            transition: all 0.2s ease;
        }
        
        .task-item:hover .task-text {
            white-space: normal;
            overflow: visible;
            word-break: break-word;
        }

        .task-meta { font-size: 0.75rem; color: var(--text-tertiary); display: flex; align-items: center; gap: 6px; }

        /* Completed Section */
        .completed-section {
            margin-top: 20px; border-top: 1px solid var(--border-color);
            padding-top: 16px;
        }
        .completed-header {
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; padding: 8px 0; color: var(--text-secondary);
        }
        .completed-header:hover { color: var(--text-primary); }

        /* Reduce Glare on Completed Tasks */
        #completedList { opacity: 0.6; transition: opacity 0.3s; }
        body.dark-mode #completedList { opacity: 0.3; }
        #completedList:hover { opacity: 1; }

        /* -------------------------------------------------------------------------- */
        /* MAIN CONTENT                                                               */
        /* -------------------------------------------------------------------------- */
        .main-content {
            background: var(--bg-body);
            overflow-y: auto;
            padding: 48px 64px;
            position: relative;
        }

        /* Top Header */
        .top-bar {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 48px;
        }

        .toggle-sidebar-btn {
            background: var(--bg-sidebar); border: 1px solid var(--border-color);
            width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; margin-right: 20px;
            color: var(--text-primary);
        }
        .toggle-sidebar-btn:hover { background: var(--text-primary); color: var(--bg-body); transform: scale(1.05); }

        .auth-btn {
            background: var(--text-primary); color: var(--bg-body);
            padding: 10px 24px; border-radius: 50px;
            font-weight: 600; font-size: 0.9rem;
            border: none; cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); opacity: 0.9; }

        /* -------------------------------------------------------------------------- */
        /* FOCUS HERO                                                                 */
        /* -------------------------------------------------------------------------- */
        .focus-hero {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: var(--bg-glass-border);
            border-radius: var(--radius-lg);
            padding: 40px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-glass);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 220px;
            transition: transform 0.3s;
        }
        .focus-hero:hover { transform: translateY(-4px); }

        .focus-progress-bar {
            position: absolute; top: 0; left: 0; height: 4px;
            background: var(--accent-green); transition: width 1s ease;
            box-shadow: 0 2px 10px rgba(52, 199, 89, 0.4);
        }

        .focus-label { font-size: 0.85rem; font-weight: 700; letter-spacing: 0.1em; color: var(--accent-blue); margin-bottom: 16px; opacity: 0.8; }
        .focus-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 8px; line-height: 1.2; }
        .focus-subtitle { font-size: 1.1rem; color: var(--text-secondary); max-width: 600px; }

        /* -------------------------------------------------------------------------- */
        /* BENTO GRID                                                                 */
        /* -------------------------------------------------------------------------- */
        .bento-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px; margin-bottom: 48px;
        }

        .bento-card {
            background: var(--bg-sidebar);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; justify-content: center;
            transition: all 0.3s;
        }
        .bento-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--text-tertiary); }

        /* Timer Specifics */
        .timer-display {
            font-size: 3.5rem; font-weight: 800; font-variant-numeric: tabular-nums;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 16px 0;
        }

        .timer-controls { display: flex; gap: 12px; justify-content: center; }
        
        /* Pomodoro Presets */
        .timer-presets {
            display: flex; gap: 8px; justify-content: center; margin-top: 10px;
        }
        
        .btn-icon-circle {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--bg-hover); border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; color: var(--text-secondary);
        }
        .btn-icon-circle:hover { background: var(--text-primary); color: var(--bg-body); transform: rotate(90deg); }

        /* -------------------------------------------------------------------------- */
        /* COURSES CARDS (NEW STYLE)                                                 */
        /* -------------------------------------------------------------------------- */
        .courses-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 24px; padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .btn-new-course {
            background: transparent; border: 2px dashed var(--border-color);
            color: var(--text-secondary); padding: 12px 24px;
            border-radius: var(--radius-md); font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-new-course:hover { border-color: var(--accent-blue); color: var(--accent-blue); background: var(--accent-blue-soft); }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .course-card-compact {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .course-card-compact::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            background: var(--course-color, var(--accent-blue));
            transition: width 0.3s;
        }

        .course-card-compact:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--course-color);
        }

        .course-card-compact:hover::before {
            width: 12px;
        }

        .course-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .course-card-stats {
            display: flex;
            gap: 16px;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 12px;
        }

        .course-card-progress {
            width: 100%;
            height: 6px;
            background: var(--bg-input);
            border-radius: 10px;
            overflow: hidden;
        }

        .course-card-progress-fill {
            height: 100%;
            background: var(--course-color);
            transition: width 0.8s ease;
        }

        /* -------------------------------------------------------------------------- */
        /* COURSE MODAL (RESTRUCTURED)                                               */
        /* -------------------------------------------------------------------------- */
        .course-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            padding: 20px;
        }

        .course-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .course-modal {
            background: var(--bg-card);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            transform: scale(0.95);
            transition: transform 0.3s var(--ease-spring);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .course-modal-overlay.active .course-modal {
            transform: scale(1);
        }

        .course-modal-header {
            padding: 24px 32px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 10;
        }

        .course-modal-title-input {
            font-size: 1.8rem;
            font-weight: 800;
            border: none;
            background: transparent;
            width: 100%;
            color: var(--text-primary);
            padding: 4px 0;
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
        }
        
        .course-modal-title-input:focus {
            outline: none;
            border-bottom: 2px solid var(--accent-blue);
        }

        .course-modal-close {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--bg-input);
            border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            flex-shrink: 0;
            margin-left: 20px;
        }

        .course-modal-close:hover {
            background: var(--accent-red);
            color: white;
            transform: rotate(90deg);
        }

        .course-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            background: var(--bg-body); /* Contrast background */
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .course-modal-footer {
            padding: 20px 32px;
            background: var(--bg-card);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 10;
        }

        /* Structured Category Section */
        .category-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .category-section:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--text-tertiary);
        }
        
        /* Colored accent line for categories */
        .category-section::before {
            content: ''; position: absolute; left: 0; top: 20px; bottom: 20px; width: 4px;
            background: var(--course-color); border-radius: 0 4px 4px 0;
            opacity: 0.5;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--bg-input);
            padding-left: 12px;
        }

        .category-title {
            font-size: 0.9rem;
            font-weight: 800;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .btn-add-goal {
            background: var(--bg-input);
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-add-goal:hover { background: var(--accent-blue); color: white; }

        /* Enhanced Goal Item */
        .goal-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            transition: all 0.2s;
            position: relative;
            border: 1px solid transparent;
            background: var(--bg-body); /* Nested contrast */
            margin-bottom: 10px;
        }

        .goal-item:hover {
            background: var(--bg-hover);
        }
        
        .goal-item:focus-within {
            background: var(--bg-card);
            border-color: var(--accent-blue);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateX(4px);
        }

        .goal-inputs {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .goal-main-input {
            font-size: 1rem;
            font-weight: 600;
            border: none;
            background: transparent;
            width: 100%;
            color: var(--text-primary);
            padding: 2px 0;
        }
        
        .goal-sub-input {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            border: none;
            background: transparent;
            width: 100%;
        }

        .goal-main-input:focus, .goal-sub-input:focus {
            color: var(--accent-blue);
        }

        .goal-actions {
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .goal-item:hover .goal-actions, .goal-item:focus-within .goal-actions {
            opacity: 1;
        }

        /* Course Footer Colors */
        .course-colors {
            display: flex;
            gap: 8px;
            background: var(--bg-input);
            padding: 6px;
            border-radius: 50px;
        }

        .cc-dot {
            width: 20px; height: 20px;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .cc-dot:hover { opacity: 1; transform: scale(1.1); }
        .cc-dot.active { opacity: 1; border-color: var(--bg-card); box-shadow: 0 0 0 2px var(--text-primary); transform: scale(1.1); }

        /* -------------------------------------------------------------------------- */
        /* MODALS                                                                     */
        /* -------------------------------------------------------------------------- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);
            z-index: 200; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal {
            background: var(--bg-card); width: 400px; padding: 32px;
            border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);
            transform: scale(0.95); transition: transform 0.3s var(--ease-spring);
            border: 1px solid var(--border-color);
        }
        .modal-overlay.active .modal { transform: scale(1); }

        /* -------------------------------------------------------------------------- */
        /* UTILITY                                                                    */
        /* -------------------------------------------------------------------------- */
        .btn-primary { background: var(--text-primary); color: var(--bg-body); padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; }
        .btn-ghost { background: transparent; color: var(--text-secondary); padding: 8px 16px; border-radius: 8px; font-weight: 500; cursor: pointer; border: 1px solid transparent; }
        .btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }
        .hidden { display: none !important; }
        
        /* Toast Notification */
        #toast {
            position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--text-primary); color: var(--bg-body);
            padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-weight: 500; z-index: 300;
            transition: transform 0.4s var(--ease-spring);
            display: flex; align-items: center; gap: 12px;
        }
        #toast.active { transform: translateX(-50%) translateY(0); }

        /* Mobile Styles */
        @media (max-width: 900px) {
            body, html {
                overflow: auto; /* Enable scrolling on mobile */
            }

            .app-layout {
                grid-template-columns: 1fr;
                height: auto;
                min-height: 100vh;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                width: 85%;
                max-width: 320px;
                height: 100vh;
                transform: translateX(-100%);
                box-shadow: none;
                z-index: 1000;
            }

            .sidebar.open {
                transform: translateX(0);
                box-shadow: var(--shadow-lg);
            }

            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s;
            }

            .sidebar-overlay.active {
                opacity: 1;
                pointer-events: auto;
            }

            #sidebarClose {
                display: block !important;
            }

            .main-content {
                padding: 24px;
                overflow-y: visible;
                height: auto;
            }

            .toggle-sidebar-btn {
                display: flex !important;
            }

            .app-layout.collapsed .sidebar {
                transform: translateX(-100%);
            }

            .courses-grid {
                grid-template-columns: 1fr;
            }

            .course-modal {
                max-height: 85vh;
            }

            .text-h1 {
                font-size: 2rem;
            }

            .focus-title {
                font-size: 1.8rem;
            }
            
            /* TOUCH OPTIMIZATIONS */
            .checkbox { width: 28px; height: 28px; }
            .btn-icon, .btn-ghost, .btn-primary { min-height: 44px; }
            .btn-new-course { min-height: 48px; }
            .task-item { padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="loader" style="position:fixed; inset:0; background:var(--bg-body); z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div class="animate-spin" style="width:50px; height:50px; border:4px solid var(--bg-input); border-top-color:var(--accent-blue); border-radius:50%;"></div>
        <h3 style="margin-top:20px; font-weight:600;">Igniting Spark...</h3>
    </div>

    <div id="toast">
        <span id="toastMsg">Action Completed</span>
        <button id="toastUndo" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem;">UNDO</button>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-layout" id="appLayout">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center; gap:12px;">
                    <h2 class="text-h2">Tasks</h2>
                    <button type="button" class="btn-random" id="btnRandomTask" title="Pick Random Task">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 8h.01"></path><path d="M8 8h.01"></path><path d="M8 16h.01"></path><path d="M16 16h.01"></path><path d="M12 12h.01"></path></svg>
                        Pick Random
                    </button>
                </div>
                <button class="btn-ghost" id="sidebarClose">✕</button>
            </div>

            <div class="task-input-container">
                <form id="addTaskForm">
                    <input type="text" id="taskInput" class="task-main-input" placeholder="What needs focusing?" autocomplete="off">
                    
                    <div class="task-meta-row">
                        <div class="days-input-wrapper">
                            <span class="text-xs" style="color:var(--text-tertiary)">DUE IN</span>
                            <input type="number" id="taskDays" class="days-input" placeholder="0">
                            <span class="text-xs" style="color:var(--text-tertiary)">DAYS</span>
                        </div>
                        <button type="submit" class="btn-primary" style="padding: 8px 16px; font-size:0.85rem;">Add</button>
                    </div>

                    <div class="color-picker">
                        <div class="color-dot active" style="background: var(--accent-blue);" data-color="blue"></div>
                        <div class="color-dot" style="background: var(--accent-purple);" data-color="purple"></div>
                        <div class="color-dot" style="background: var(--accent-green);" data-color="green"></div>
                        <div class="color-dot" style="background: var(--accent-orange);" data-color="orange"></div>
                        <div class="color-dot" style="background: var(--accent-red);" data-color="red"></div>
                    </div>
                </form>
            </div>

            <div class="task-list-wrapper" id="taskScroll">
                <div id="taskList"></div>
                
                <div id="emptyState" class="hidden" style="text-align:center; padding:40px 0; opacity:0.5;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:16px;">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    <p>All caught up!</p>
                </div>

                <div class="completed-section" id="completedSection">
                    <div class="completed-header" onclick="toggleCompleted()">
                        <span class="text-xs">COMPLETED HISTORY</span>
                        <span id="completedArrow">▼</span>
                    </div>
                    <div id="completedList" style="display:none; margin-top:12px;"></div>
                </div>
            </div>

            <div style="margin-top:auto; padding-top:20px; border-top:1px solid var(--border-color); display:flex; justify-content:center;">
                <button type="button" class="btn-ghost" id="themeToggle">◐ Switch Theme</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div style="display:flex; align-items:center;">
                    <button type="button" class="toggle-sidebar-btn" id="sidebarToggle">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
                    </button>
                    <div>
                        <p class="text-xs" style="color:var(--text-tertiary); margin-bottom:4px;" id="currentDate">FRIDAY, OCTOBER 24</p>
                        <h1 class="text-h1" id="greeting">Good Morning</h1>
                    </div>
                </div>
                <button type="button" class="auth-btn" id="loginBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                    Sign In
                </button>
            </header>

            <section class="focus-hero" id="focusHero">
            </section>

            <div class="bento-grid">
                <div class="bento-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="text-xs" style="color:var(--text-tertiary)">POMODORO TIMER</span>
                        <button type="button" class="btn-icon-circle" onclick="toggleModal('timerModal')">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        </button>
                    </div>
                    
                    <div class="timer-presets" style="margin-top: 10px; display:flex; gap:8px; justify-content:center;">
                       <button type="button" class="btn-ghost" onclick="setTimer(25)" style="font-size:0.8rem; padding:4px 10px; border:1px solid var(--border-color);">Focus 25</button>
                       <button type="button" class="btn-ghost" onclick="setTimer(5)" style="font-size:0.8rem; padding:4px 10px; border:1px solid var(--border-color);">Short 5</button>
                       <button type="button" class="btn-ghost" onclick="setTimer(15)" style="font-size:0.8rem; padding:4px 10px; border:1px solid var(--border-color);">Long 15</button>
                    </div>

                    <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                        <div class="timer-display" id="timerDisplay">25:00</div>
                        <div class="timer-controls">
                            <button type="button" id="startTimerBtn" class="btn-primary">Start Focus</button>
                            <button type="button" id="resetTimerBtn" class="btn-ghost">Reset</button>
                        </div>
                    </div>
                </div>

                <div class="bento-card">
                    <span class="text-xs" style="color:var(--text-tertiary)">TODAY'S MOMENTUM</span>
                    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; gap:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                            <span class="text-h1" id="progressPercent">0%</span>
                            <span class="text-body" id="progressText">0/0 Tasks</span>
                        </div>
                        <div style="width:100%; height:8px; background:var(--bg-input); border-radius:10px; overflow:hidden;">
                            <div id="progressBar" style="width:0%; height:100%; background:var(--accent-green); transition: width 0.8s var(--ease-spring);"></div>
                        </div>
                        <p class="text-sm" style="color:var(--text-secondary);" id="progressQuote">Start small, achieve big.</p>
                    </div>
                </div>
            </div>

            <section>
                <div class="courses-header">
                    <div>
                        <h2 class="text-h2">Courses & Projects</h2>
                        <p class="text-body">Manage lectures, labs, and deadlines.</p>
                    </div>
                    <button type="button" class="btn-new-course" onclick="addCourse()">+ New Course</button>
                </div>

                <div class="courses-grid" id="coursesContainer"></div>
                
                <div id="emptyCourses" class="hidden" style="text-align:center; padding: 60px; color:var(--text-tertiary); border:2px dashed var(--bg-input); border-radius:var(--radius-lg);">
                    <p class="text-h3" style="margin-bottom:8px;">No courses yet</p>
                    <p>Click "New Course" to start organizing your studies.</p>
                </div>
            </section>

        </main>
    </div>

    <div class="course-modal-overlay" id="courseModal">
        <div class="course-modal">
            <div class="course-modal-header">
                <input type="text" class="course-modal-title-input" id="modalCourseTitle" placeholder="Course Name">
                <button type="button" class="course-modal-close" onclick="closeCourseModal()">✕</button>
            </div>
            <div class="course-modal-body" id="courseModalBody">
                </div>
            <div class="course-modal-footer">
                <div class="course-colors" id="modalCourseColors">
                    </div>
                        <button type="button" class="btn-danger" id="modalDeleteBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="timerModal">
        <div class="modal">
            <h3 class="text-h3" style="margin-bottom:24px;">Timer Settings</h3>
            <div style="margin-bottom:20px;">
                <label class="text-xs" style="color:var(--text-secondary); display:block; margin-bottom:8px;">FOCUS DURATION (MIN)</label>
                <input type="number" id="customWorkDur" value="25" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--bg-input); background:var(--bg-body); color:var(--text-primary); font-size:1.1rem;">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:12px;">
                <button type="button" class="btn-ghost" onclick="toggleModal('timerModal')">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveTimerSettings()">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyCu6cbaEw4BzXvF8rGx94h6WHarEFH9Z-k",
          authDomain: "coursesprogress-5658f.firebaseapp.com",
          projectId: "coursesprogress-5658f",
          storageBucket: "coursesprogress-5658f.firebasestorage.app",
          messagingSenderId: "572695866101",
          appId: "1:572695866101:web:bb6dc8058387358b7773bc",
          measurementId: "G-XD8W9V1XPE"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        /* -------------------------------------------------------------------------- */
        /* STATE                                                                      */
        /* -------------------------------------------------------------------------- */
        let state = {
            user: null,
            todos: [],
            courses: [],
            focusId: null,
            timer: { isRunning: false, timeLeft: 1500, duration: 25 },
            lastUndo: null,
            isLocalUpdate: false,
            currentCourseId: null
        };

        const colors = {
            blue: '#0071e3', purple: '#5e5ce6', green: '#34c759',
            orange: '#ff9f0a', red: '#ff3b30', gray: '#8e8e93'
        };

        let activeColor = 'blue';
        let focusTarget = null;

        /* -------------------------------------------------------------------------- */
        /* HELPERS                                                                    */
        /* -------------------------------------------------------------------------- */
        const getEl = (id) => document.getElementById(id);
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        /* -------------------------------------------------------------------------- */
        /* CORE                                                                       */
        /* -------------------------------------------------------------------------- */
        function init() {
            setTimeout(() => getEl('loader').style.display = 'none', 800);

            const updateTime = () => {
                const now = new Date();
                getEl('currentDate').innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }).toUpperCase();
                const hr = now.getHours();
                getEl('greeting').innerText = hr < 12 ? 'Good Morning' : hr < 18 ? 'Good Afternoon' : 'Good Evening';
            };
            updateTime(); setInterval(updateTime, 60000);

            setupEventListeners();
            
            new Sortable(getEl('taskList'), {
                animation: 150, ghostClass: 'sortable-ghost', delay: 100,
                onEnd: (evt) => reorderTasks(evt.oldIndex, evt.newIndex)
            });

            if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        }

        const toggleSidebar = () => {
            // Check if we are on Mobile or PC based on window width
            if (window.innerWidth > 900) {
                // PC MODE: Toggle the grid layout class
                getEl('appLayout').classList.toggle('collapsed');
                
                // Optional: Rotate the toggle icon when collapsed
                const btn = getEl('sidebarToggle');
                if (getEl('appLayout').classList.contains('collapsed')) {
                    btn.style.transform = "rotate(180deg)";
                } else {
                    btn.style.transform = "rotate(0deg)";
                }
            } else {
                // MOBILE MODE: Use existing overlay logic
                const sidebar = getEl('sidebar');
                const overlay = getEl('sidebarOverlay');
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        };

        function setupEventListeners() {
            getEl('sidebarToggle').onclick = toggleSidebar;
            getEl('sidebarClose').onclick = toggleSidebar;
            getEl('sidebarOverlay').onclick = toggleSidebar;

            getEl('themeToggle').onclick = () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            };

            getEl('addTaskForm').onsubmit = (e) => {
                e.preventDefault();
                const text = getEl('taskInput').value.trim();
                const days = parseInt(getEl('taskDays').value) || 0;
                if(text) addTask(text, days);
            };

            getEl('btnRandomTask').onclick = () => {
                const active = state.todos.filter(t => !t.completed);
                if(active.length === 0) {
                    showToast("No tasks to pick from!");
                    return;
                }
                const randomTask = active[Math.floor(Math.random() * active.length)];
                setFocus(randomTask.id);
                setTimeout(() => {
                    const items = document.querySelectorAll('.task-item');
                    items.forEach(item => {
                        if(item.innerHTML.includes(randomTask.text)) {
                            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            item.classList.add('highlight-task');
                            setTimeout(() => item.classList.remove('highlight-task'), 1000);
                        }
                    });
                }, 100);
                showToast("Random task picked!");
            };

            document.querySelectorAll('.color-dot').forEach(dot => {
                dot.onclick = () => {
                    document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                    dot.classList.add('active');
                    activeColor = dot.dataset.color;
                };
            });

            getEl('startTimerBtn').onclick = toggleTimer;
            getEl('resetTimerBtn').onclick = resetTimer;
            
            getEl('toastUndo').onclick = () => {
                if(state.lastUndo) {
                    if(state.lastUndo.type === 'task') state.todos.push(state.lastUndo.data);
                    saveData(); renderTasks(); hideToast();
                }
            };
        }

        /* -------------------------------------------------------------------------- */
        /* DATA LOGIC                                                                 */
        /* -------------------------------------------------------------------------- */
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                getEl('loginBtn').innerHTML = `<img src="${user.photoURL}" style="width:20px; height:20px; border-radius:50%; margin-right:8px;"> Sign Out`;
                getEl('loginBtn').onclick = () => signOut(auth);
                
                onSnapshot(doc(db, 'users', user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        if (state.isLocalUpdate) { 
                            state.isLocalUpdate = false; 
                            return; 
                        }
                        const d = docSnap.data();
                        state.todos = d.todos || [];
                        state.courses = d.courses || [];
                        state.focusId = d.focusId || null;
                        renderAll();
                    } else {
                        state.todos = [];
                        state.courses = [];
                        state.focusId = null;
                        renderAll();
                    }
                });
            } else {
                getEl('loginBtn').innerHTML = 'Sign In';
                getEl('loginBtn').onclick = () => signInWithPopup(auth, provider);
                renderAll();
            }
        });

        function saveData(shouldRender = true) {
            if (shouldRender) renderAll();

            if (state.user) {
                state.isLocalUpdate = true;
                
                setDoc(doc(db, 'users', state.user.uid), {
                    todos: state.todos,
                    courses: state.courses,
                    focusId: state.focusId,
                    lastUpdated: new Date().toISOString()
                }, { merge: true }).catch(error => {
                    console.error("Cloud save failed:", error);
                });
            }
        }

        /* -------------------------------------------------------------------------- */
        /* RENDERING                                                                  */
        /* -------------------------------------------------------------------------- */
        function renderAll() {
            renderTasks();
            renderFocus();
            renderCourses();
            renderStats();
            
            // Re-render modal if open
            if(state.currentCourseId) {
                window.openCourseModal(state.currentCourseId);
            }
        }

        function renderTasks() {
            const list = getEl('taskList');
            list.innerHTML = '';
            
            const active = state.todos.filter(t => !t.completed);
            
            if(active.length === 0) getEl('emptyState').classList.remove('hidden');
            else getEl('emptyState').classList.add('hidden');

            active.forEach(t => {
                const el = document.createElement('div');
                el.className = 'task-item animate-in';
                el.style.setProperty('--task-color', colors[t.color] || colors.blue);
                const daysLeft = t.days ? `<span style="background:var(--bg-input); padding:2px 6px; border-radius:4px;">${t.days}d left</span>` : '';
                
                el.innerHTML = `
                    <div class="checkbox"></div>
                    <div class="task-content">
                        <div class="task-text">${t.text}</div>
                        <div class="task-meta">${daysLeft}</div>
                    </div>
                    <button type="button" class="btn-icon" style="opacity:0.5; border:none; background:transparent;">✕</button>
                `;

                el.onclick = (e) => {
                    if(!e.target.closest('.checkbox') && !e.target.closest('button')) setFocus(t.id);
                };
                el.querySelector('.checkbox').onclick = (e) => { e.stopPropagation(); toggleTask(t.id); };
                el.querySelector('button').onclick = (e) => { e.stopPropagation(); deleteTask(t.id); };

                list.appendChild(el);
            });

            const compList = getEl('completedList');
            compList.innerHTML = '';
            state.todos.filter(t => t.completed).forEach(t => {
                const div = document.createElement('div');
                div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.gap='8px'; div.style.marginBottom='8px'; 
                div.innerHTML = `<div class="checkbox checked" style="width:18px;height:18px;font-size:10px;">✓</div><div style="text-decoration:line-through; font-size:0.9rem;">${t.text}</div>`;
                div.querySelector('.checkbox').onclick = () => toggleTask(t.id);
                compList.appendChild(div);
            });
        }

        function renderFocus() {
            const hero = getEl('focusHero');
            const task = state.todos.find(t => t.id === state.focusId && !t.completed);
            
            if(!task) {
                hero.innerHTML = `
                    <div style="opacity:0.5;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    </div>
                    <h2 class="text-h2" style="margin-top:16px;">No Active Focus</h2>
                    <p class="text-body" style="margin-top:8px;">Select a task from the sidebar to begin.</p>
                `;
                return;
            }

            const color = colors[task.color] || colors.blue;
            hero.innerHTML = `
                <div class="focus-progress-bar" style="background:${color}; width:100%;"></div>
                <div class="focus-label" style="color:${color};">CURRENT PRIORITY</div>
                <h2 class="focus-title animate-in">${task.text}</h2>
                <div class="focus-subtitle">Stay strictly on this task until completion.</div>
                <button type="button" class="btn-primary" style="margin-top:32px; background:${color}; box-shadow:0 8px 20px -4px ${color}80;">
                    Complete Task
                </button>
            `;
            hero.querySelector('button').onclick = () => {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                toggleTask(task.id);
            };
        }

        function renderStats() {
            const total = state.todos.length;
            const done = state.todos.filter(t => t.completed).length;
            const pct = total === 0 ? 0 : Math.round((done/total)*100);
            
            getEl('progressPercent').innerText = `${pct}%`;
            getEl('progressText').innerText = `${done}/${total} Tasks`;
            getEl('progressBar').style.width = `${pct}%`;
            
            const quotes = ["Keep pushing.", "Momentum is key.", "One step at a time.", "You're doing great."];
            if(pct === 100) getEl('progressQuote').innerText = "All done! Amazing work.";
            else getEl('progressQuote').innerText = quotes[Math.floor(Math.random()*quotes.length)];
        }

        function renderCourses() {
            const container = getEl('coursesContainer');
            container.innerHTML = '';

            if(state.courses.length === 0) {
                getEl('emptyCourses').classList.remove('hidden');
            } else {
                getEl('emptyCourses').classList.add('hidden');
            }

            state.courses.forEach(course => {
                const totalG = course.categories.reduce((acc, c) => acc + c.goals.length, 0);
                const doneG = course.categories.reduce((acc, c) => acc + c.goals.filter(g => g.completed).length, 0);
                const progress = totalG === 0 ? 0 : (doneG/totalG)*100;
                const cColor = colors[course.color] || colors.blue;

                const card = document.createElement('div');
                card.className = 'course-card-compact';
                card.style.setProperty('--course-color', cColor);
                
                card.innerHTML = `
                    <div class="course-card-title">${course.name}</div>
                    <div class="course-card-stats">
                        <span>${doneG}/${totalG} Goals</span>
                        <span>${Math.round(progress)}% Done</span>
                    </div>
                    <div class="course-card-progress">
                        <div class="course-card-progress-fill" style="width:${progress}%; background:${cColor};"></div>
                    </div>
                `;

                card.onclick = () => window.openCourseModal(course.id);
                container.appendChild(card);
            });
        }

        /* -------------------------------------------------------------------------- */
        /* COURSE MODAL                                                               */
        /* -------------------------------------------------------------------------- */
        window.openCourseModal = (courseId) => {
            state.currentCourseId = courseId;
            const course = state.courses.find(c => c.id === courseId);
            if (!course) return;

            const modal = getEl('courseModal');
            const titleInput = getEl('modalCourseTitle');
            const body = getEl('courseModalBody');
            const colorsDiv = getEl('modalCourseColors');
            
            titleInput.value = course.name;
            titleInput.onblur = () => {
                updateCourse(courseId, { name: titleInput.value }, false);
            };

            // Render categories and goals
            body.innerHTML = '';
            
            course.categories.forEach(cat => {
                const section = document.createElement('div');
                section.className = 'category-section';
                section.style.setProperty('--course-color', colors[course.color]);
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">${cat.name}</div>
                        <div style="display:flex; gap:8px;">
                            <button type="button" class="btn-add-goal" data-action="add-goal">+ Goal</button>
                            <button type="button" class="btn-icon" style="opacity:0.5; width:24px; height:24px; color:var(--text-tertiary); border:none; background:transparent;" data-action="delete-cat">✕</button>
                        </div>
                    </div>
                    <div class="goals-container"></div>
                `;

                section.querySelector('[data-action="add-goal"]').onclick = () => {
                    addGoal(courseId, cat.id);
                };

                section.querySelector('[data-action="delete-cat"]').onclick = () => {
                    deleteCategory(courseId, cat.id);
                };

                const goalsCont = section.querySelector('.goals-container');
                cat.goals.forEach(goal => {
                    const gItem = document.createElement('div');
                    gItem.className = 'goal-item';
                    gItem.innerHTML = `
                        <div class="checkbox ${goal.completed ? 'checked' : ''}" style="margin-top:4px;">${goal.completed ? '✓' : ''}</div>
                        <div class="goal-inputs">
                            <input class="goal-main-input" value="${goal.title}" placeholder="New Goal...">
                            <input class="goal-sub-input" value="${goal.subtitle || ''}" placeholder="Add details...">
                        </div>
                        <div class="goal-actions">
                            <button type="button" class="btn-icon" style="width:24px; height:24px; border:none; background:transparent;" title="Convert to Task">➔</button>
                            <button type="button" class="btn-icon" style="width:24px; height:24px; color:var(--accent-red); border:none; background:transparent;" title="Delete">✕</button>
                        </div>
                    `;

                    gItem.querySelector('.checkbox').onclick = () => {
                        toggleGoal(courseId, cat.id, goal.id);
                    };
                    
                    const mainIn = gItem.querySelector('.goal-main-input');
                    mainIn.onblur = () => updateGoal(courseId, cat.id, goal.id, { title: mainIn.value }, false);
                    mainIn.onkeydown = (e) => {
                        if(e.key === 'Enter') {
                            e.preventDefault();
                            e.target.blur(); // Triggers save before adding new
                            addGoal(courseId, cat.id);
                        }
                    };

                    const subIn = gItem.querySelector('.goal-sub-input');
                    subIn.onblur = () => updateGoal(courseId, cat.id, goal.id, { subtitle: subIn.value }, false);

                    gItem.querySelector('[title="Convert to Task"]').onclick = () => {
                        convertGoal(courseId, cat.id, goal.id);
                    };

                    gItem.querySelector('[title="Delete"]').onclick = () => {
                        deleteGoal(courseId, cat.id, goal.id);
                    };

                    goalsCont.appendChild(gItem);

                    // Autofocus logic for new goals
                    if(focusTarget && goal.id === focusTarget.id) {
                         setTimeout(() => mainIn.focus(), 50);
                         focusTarget = null;
                    }
                });

                body.appendChild(section);
            });

            // Add category button
            const addCatDiv = document.createElement('div');
            addCatDiv.style.textAlign = "center";
            addCatDiv.innerHTML = `<button type="button" class="btn-ghost" style="width:100%; border:1px dashed var(--border-color);">+ Add Category</button>`;
            addCatDiv.onclick = () => {
                const name = prompt("Category Name (e.g., Labs, Exams):");
                if(name) {
                    addCategory(courseId, name);
                }
            };
            body.appendChild(addCatDiv);

            // Color picker
            colorsDiv.innerHTML = '';
            Object.keys(colors).forEach(k => {
                const dot = document.createElement('div');
                dot.className = `cc-dot ${course.color === k ? 'active' : ''}`;
                dot.style.background = colors[k];
                dot.onclick = () => {
                    setCourseColor(courseId, k);
                };
                colorsDiv.appendChild(dot);
            });

            // Delete button
            getEl('modalDeleteBtn').onclick = () => {
                if(confirm("Delete this course and all goals?")) {
                    delCourse(courseId);
                    window.closeCourseModal();
                }
            };

            modal.classList.add('active');
        };

        window.closeCourseModal = () => {
            getEl('courseModal').classList.remove('active');
            state.currentCourseId = null;
        };

        /* -------------------------------------------------------------------------- */
        /* ACTIONS                                                                    */
        /* -------------------------------------------------------------------------- */
        
        function addTask(text, days) {
            state.todos.push({
                id: generateId(), text, days, color: activeColor,
                completed: false, createdAt: new Date().toISOString()
            });
            getEl('taskInput').value = '';
            getEl('taskDays').value = '';
            if(!state.focusId) state.focusId = state.todos[state.todos.length-1].id;
            saveData();
        }

        function toggleTask(id) {
            const t = state.todos.find(x => x.id === id);
            if(t) {
                t.completed = !t.completed;
                if(t.completed) {
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                    if(state.focusId === id) state.focusId = null;
                }
                saveData();
            }
        }

        function deleteTask(id) {
            const idx = state.todos.findIndex(x => x.id === id);
            if(idx > -1) {
                state.lastUndo = { type: 'task', data: state.todos[idx] };
                state.todos.splice(idx, 1);
                if(state.focusId === id) state.focusId = null;
                showToast("Task deleted");
                saveData();
            }
        }

        window.setFocus = (id) => {
            state.focusId = id;
            saveData();
            if(window.innerWidth < 900) {
                getEl('sidebar').classList.remove('open');
                getEl('sidebarOverlay').classList.remove('active');
            }
        };

        function reorderTasks(oldIdx, newIdx) {
            const active = state.todos.filter(t => !t.completed);
            const item = active.splice(oldIdx, 1)[0];
            active.splice(newIdx, 0, item);
            state.todos = [...active, ...state.todos.filter(t => t.completed)];
            saveData();
        }

        window.addCourse = () => {
            const id = generateId();
            state.courses.push({
                id, name: 'New Course', color: 'blue',
                categories: [
                    { id: generateId(), name: 'Lectures', goals: [] },
                    { id: generateId(), name: 'Assignments', goals: [] }
                ]
            });
            saveData();
            setTimeout(() => window.openCourseModal(id), 100);
        };

        function updateCourse(id, updates, shouldRender = true) {
            const c = state.courses.find(x => x.id === id);
            if(c) { Object.assign(c, updates); saveData(shouldRender); }
        }

        window.setCourseColor = (id, color) => {
            updateCourse(id, { color });
        };

        window.delCourse = (id) => {
            state.courses = state.courses.filter(x => x.id !== id);
            saveData();
        };

        function addCategory(cid, name) {
            const c = state.courses.find(x => x.id === cid);
            c.categories.push({ id: generateId(), name, goals: [] });
            saveData();
        }

        function deleteCategory(cid, catId) {
            const c = state.courses.find(x => x.id === cid);
            c.categories = c.categories.filter(x => x.id !== catId);
            saveData();
        }

        function addGoal(cid, catId) {
            const c = state.courses.find(x => x.id === cid);
            const cat = c.categories.find(x => x.id === catId);
            const newId = generateId();
            cat.goals.push({ id: newId, title: '', completed: false });
            focusTarget = { id: newId };
            saveData();
        }

        function updateGoal(cid, catId, gid, updates, shouldRender = true) {
            const c = state.courses.find(x => x.id === cid);
            const cat = c.categories.find(x => x.id === catId);
            const g = cat.goals.find(x => x.id === gid);
            if(g) {
                Object.assign(g, updates);
                saveData(shouldRender);
            }
        }

        function toggleGoal(cid, catId, gid) {
            const c = state.courses.find(x => x.id === cid);
            const cat = c.categories.find(x => x.id === catId);
            const g = cat.goals.find(x => x.id === gid);
            if(g) {
                g.completed = !g.completed;
                if(g.completed) confetti({ particleCount: 30, spread: 40, origin: { x: 0.5, y: 0.5 } });
                saveData();
            }
        }

        function deleteGoal(cid, catId, gid) {
            const c = state.courses.find(x => x.id === cid);
            const cat = c.categories.find(x => x.id === catId);
            cat.goals = cat.goals.filter(x => x.id !== gid);
            saveData();
        }

        function convertGoal(cid, catId, gid) {
            const c = state.courses.find(x => x.id === cid);
            const cat = c.categories.find(x => x.id === catId);
            const g = cat.goals.find(x => x.id === gid);
            
            // Add task directly to avoid double save
            state.todos.push({
                id: generateId(), text: `[${c.name}] ${g.title}`, days: 0, color: activeColor,
                completed: false, createdAt: new Date().toISOString()
            });

            // Delete goal logic directly
            cat.goals = cat.goals.filter(x => x.id !== gid);
            
            showToast("Converted to Task");
            saveData(); // Single save
        }

        /* -------------------------------------------------------------------------- */
        /* TIMER & UTILS                                                              */
        /* -------------------------------------------------------------------------- */
        window.toggleModal = (id) => getEl(id).classList.toggle('active');

        window.toggleCompleted = () => {
            const list = getEl('completedList');
            const arrow = getEl('completedArrow');
            if(list.style.display === 'none') {
                list.style.display = 'block';
                arrow.innerText = '▲';
            } else {
                list.style.display = 'none';
                arrow.innerText = '▼';
            }
        };
        
        // NEW: PRESET TIMER FUNCTION
        window.setTimer = (min) => {
            state.timer.duration = min;
            resetTimer();
        }

        window.saveTimerSettings = () => {
            const d = parseInt(getEl('customWorkDur').value);
            if(d > 0) state.timer.duration = d;
            resetTimer();
            window.toggleModal('timerModal');
        };

        let timerInterval;
        function toggleTimer() {
            const btn = getEl('startTimerBtn');
            if(state.timer.isRunning) {
                clearInterval(timerInterval);
                state.timer.isRunning = false;
                btn.innerText = "Resume";
                btn.style.background = "var(--accent-green)";
            } else {
                if(state.timer.timeLeft === undefined) state.timer.timeLeft = state.timer.duration * 60;
                state.timer.isRunning = true;
                btn.innerText = "Pause";
                btn.style.background = "var(--accent-orange)";
                
                timerInterval = setInterval(() => {
                    if(state.timer.timeLeft > 0) {
                        state.timer.timeLeft--;
                        getEl('timerDisplay').innerText = formatTime(state.timer.timeLeft);
                    } else {
                        clearInterval(timerInterval);
                        state.timer.isRunning = false;
                        
                        // NEW: PLAY SOUND
                        new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                        
                        alert("Focus Session Complete!");
                        resetTimer();
                    }
                }, 1000);
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            state.timer.isRunning = false;
            state.timer.timeLeft = state.timer.duration * 60;
            getEl('timerDisplay').innerText = formatTime(state.timer.timeLeft);
            const btn = getEl('startTimerBtn');
            btn.innerText = "Start Focus";
            btn.style.background = "var(--text-primary)";
        }

        function showToast(msg) {
            getEl('toastMsg').innerText = msg;
            getEl('toast').classList.add('active');
            setTimeout(hideToast, 4000);
        }

        function hideToast() {
            getEl('toast').classList.remove('active');
            setTimeout(() => { state.lastUndo = null; }, 500);
        }

        init();

    </script>
</body>
</html>
