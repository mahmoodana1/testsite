<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <meta name="theme-color" content="#F5F5F7">
    <title>Study Spark | Ultimate Workspace</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <style>
        /* -------------------------------------------------------------------------- */
        /* VARIABLES                                                                  */
        /* -------------------------------------------------------------------------- */
        :root {
            /* Light Mode (Standard) */
            --bg-body: #F5F5F7;
            --bg-sidebar: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-glass: rgba(255, 255, 255, 0.75);
            --bg-glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --bg-input: rgba(0, 0, 0, 0.04);
            --bg-hover: rgba(0, 0, 0, 0.03);
            
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --text-tertiary: #B0B0B5;
            
            --border-color: rgba(0,0,0,0.06);

            /* Accents */
            --accent-blue: #0071e3;
            --accent-blue-soft: rgba(0, 113, 227, 0.15);
            --accent-purple: #5e5ce6;
            --accent-green: #34c759;
            --accent-green-soft: rgba(52, 199, 89, 0.15);
            --accent-orange: #ff9f0a;
            --accent-red: #ff3b30;

            /* Shadows & Effects */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.12);
            --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.05);
            
            /* Dimensions */
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --header-height: 80px;
            --sidebar-width: 400px;
            
            /* Animations */
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-smooth: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* -------------------------------------------------------------------------- */
        /* DARK MODE (HIGH CONTRAST OLED)                                             */
        /* -------------------------------------------------------------------------- */
        body.dark-mode {
            /* Backgrounds: Deep, rich blacks for high contrast */
            --bg-body: #050505; 
            --bg-sidebar: #121212;
            --bg-card: #18181A;
            --bg-glass: rgba(20, 20, 20, 0.85);
            --bg-glass-border: 1px solid rgba(255, 255, 255, 0.15);
            
            /* Inputs */
            --bg-input: #262626;
            --bg-hover: #333333;
            
            /* Text: All White/Bright to avoid visibility issues */
            --text-primary: #FFFFFF;
            --text-secondary: #E5E5E5; /* Almost white */
            --text-tertiary: #A0A0A0; /* Distinctly visible gray */
            
            /* Borders: More visible in dark mode to define shapes */
            --border-color: #333333;
            
            /* Accents: Slightly brighter */
            --accent-blue: #409CFF;
            --accent-blue-soft: rgba(64, 156, 255, 0.25);
            --accent-purple: #BF5AF2;
            --accent-green: #30D158;
            --accent-green-soft: rgba(48, 209, 88, 0.25);
            --accent-orange: #FF9F0A;
            --accent-red: #FF453A;
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.7);
        }

        /* -------------------------------------------------------------------------- */
        /* RESET                                                                      */
        /* -------------------------------------------------------------------------- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden;
        }

        input, button, textarea { font-family: inherit; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; padding: 0; margin: 0; }
        h1, h2, h3, h4, h5, h6, p { margin: 0; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Input Number Reset */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        /* -------------------------------------------------------------------------- */
        /* TYPOGRAPHY                                                                 */
        /* -------------------------------------------------------------------------- */
        .text-h1 { font-size: 2.5rem; font-weight: 800; letter-spacing: -0.03em; line-height: 1.1; }
        .text-h2 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; }
        .text-h3 { font-size: 1.2rem; font-weight: 600; letter-spacing: -0.01em; }
        .text-body { font-size: 1rem; line-height: 1.5; color: var(--text-secondary); }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; }
        
        /* -------------------------------------------------------------------------- */
        /* ANIMATIONS                                                                 */
        /* -------------------------------------------------------------------------- */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes expandHeight { from { max-height: 0; opacity: 0; } to { max-height: 600px; opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes highlightPulse { 
            0% { box-shadow: 0 0 0 0 var(--accent-blue-soft); transform: scale(1); } 
            50% { box-shadow: 0 0 0 6px var(--accent-blue-soft); transform: scale(1.02); border-color: var(--accent-blue); } 
            100% { box-shadow: 0 0 0 0 transparent; transform: scale(1); } 
        }

        .animate-in { animation: fadeInUp 0.5s var(--ease-spring) forwards; }
        .animate-spin { animation: spin 1s linear infinite; }
        .highlight-task { animation: highlightPulse 0.8s ease-in-out; border-color: var(--accent-blue) !important; }
        
        /* -------------------------------------------------------------------------- */
        /* LAYOUT                                                                     */
        /* -------------------------------------------------------------------------- */
        .app-layout {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            transition: grid-template-columns 0.4s var(--ease-spring);
        }

        .app-layout.collapsed { grid-template-columns: 0px 1fr; }

        /* -------------------------------------------------------------------------- */
        /* SIDEBAR                                                                    */
        /* -------------------------------------------------------------------------- */
        .sidebar {
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 32px;
            z-index: 50;
            transition: transform 0.4s var(--ease-spring), opacity 0.3s;
            position: relative;
            overflow: hidden;
        }

        .app-layout.collapsed .sidebar {
            transform: translateX(-50px);
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px;
        }

        /* Random Task Button */
        .btn-random {
            background: var(--bg-input); color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 6px 12px; border-radius: 8px; font-size: 0.8rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-random:hover { background: var(--text-primary); color: var(--bg-body); border-color: var(--text-primary); }

        /* Task Input Area */
        .task-input-container {
            background: var(--bg-body);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
        }

        .task-input-container:focus-within {
            background: var(--bg-card);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px var(--accent-blue-soft);
        }

        .task-main-input {
            width: 100%; border: none; background: transparent;
            font-size: 1rem; color: var(--text-primary);
            padding: 8px 0; margin-bottom: 12px;
        }
        .task-main-input::placeholder { color: var(--text-tertiary); }

        .task-meta-row { display: flex; justify-content: space-between; align-items: center; }

        .days-input-wrapper {
            display: flex; align-items: center; gap: 8px;
            background: var(--bg-input);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
        }

        .days-input {
            width: 40px; background: transparent; border: none;
            text-align: center; font-weight: 600; color: var(--text-primary);
        }

        /* Color Dots */
        .color-picker { display: flex; gap: 8px; margin-top: 12px; }
        .color-dot {
            width: 24px; height: 24px; border-radius: 50%;
            cursor: pointer; transition: transform 0.3s var(--ease-spring);
            border: 2px solid transparent; position: relative;
        }
        .color-dot:hover { transform: scale(1.2); }
        .color-dot.active { transform: scale(1.25); border-color: var(--text-primary); }
        .color-dot::after {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            background: inherit; opacity: 0.5; filter: blur(4px); z-index: -1;
        }

        /* Task List */
        .task-list-wrapper { flex: 1; overflow-y: auto; padding-right: 4px; }
        
        .task-item {
            display: flex; align-items: center; gap: 12px;
            background: var(--bg-card);
            padding: 16px; margin-bottom: 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            cursor: grab; position: relative;
            overflow: hidden;
        }
        .task-item:hover { transform: translateX(4px) scale(1.01); box-shadow: var(--shadow-md); border-color: var(--text-tertiary); }
        .task-item:active { cursor: grabbing; transform: scale(0.98); }

        .task-item::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: var(--task-color, var(--accent-blue));
        }

        .checkbox {
            width: 22px; height: 22px; border-radius: 50%;
            border: 2px solid var(--text-tertiary);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s var(--ease-spring);
            flex-shrink: 0; color: white;
        }
        .checkbox:hover { border-color: var(--accent-green); background: var(--accent-green-soft); }
        .checkbox.checked { background: var(--accent-green); border-color: var(--accent-green); }
        
        .task-content { flex: 1; min-width: 0; }
        .task-text { font-weight: 500; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-meta { font-size: 0.75rem; color: var(--text-tertiary); display: flex; align-items: center; gap: 6px; }

        /* Completed Section */
        .completed-section {
            margin-top: 20px; border-top: 1px solid var(--border-color);
            padding-top: 16px;
        }
        .completed-header {
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; padding: 8px 0; color: var(--text-secondary);
        }
        .completed-header:hover { color: var(--text-primary); }

        /* Reduce Glare on Completed Tasks */
        #completedList { opacity: 0.6; transition: opacity 0.3s; }
        body.dark-mode #completedList { opacity: 0.3; } /* Significantly reduced glare */
        #completedList:hover { opacity: 1; }

        /* -------------------------------------------------------------------------- */
        /* MAIN CONTENT                                                               */
        /* -------------------------------------------------------------------------- */
        .main-content {
            background: var(--bg-body);
            overflow-y: auto;
            padding: 48px 64px;
            position: relative;
        }

        /* Top Header */
        .top-bar {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 48px;
        }

        .toggle-sidebar-btn {
            background: var(--bg-sidebar); border: 1px solid var(--border-color);
            width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; margin-right: 20px;
            color: var(--text-primary);
        }
        .toggle-sidebar-btn:hover { background: var(--text-primary); color: var(--bg-body); transform: scale(1.05); }

        .auth-btn {
            background: var(--text-primary); color: var(--bg-body);
            padding: 10px 24px; border-radius: 50px;
            font-weight: 600; font-size: 0.9rem;
            border: none; cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); opacity: 0.9; }

        /* -------------------------------------------------------------------------- */
        /* FOCUS HERO                                                                 */
        /* -------------------------------------------------------------------------- */
        .focus-hero {
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border: var(--bg-glass-border);
            border-radius: var(--radius-lg);
            padding: 40px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-glass);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 220px;
            transition: transform 0.3s;
        }
        .focus-hero:hover { transform: translateY(-4px); }

        .focus-progress-bar {
            position: absolute; top: 0; left: 0; height: 4px;
            background: var(--accent-green); transition: width 1s ease;
            box-shadow: 0 2px 10px rgba(52, 199, 89, 0.4);
        }

        .focus-label { font-size: 0.85rem; font-weight: 700; letter-spacing: 0.1em; color: var(--accent-blue); margin-bottom: 16px; opacity: 0.8; }
        .focus-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 8px; line-height: 1.2; }
        .focus-subtitle { font-size: 1.1rem; color: var(--text-secondary); max-width: 600px; }

        /* -------------------------------------------------------------------------- */
        /* BENTO GRID                                                                 */
        /* -------------------------------------------------------------------------- */
        .bento-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px; margin-bottom: 48px;
        }

        .bento-card {
            background: var(--bg-sidebar);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; justify-content: center;
            transition: all 0.3s;
        }
        .bento-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--text-tertiary); }

        /* Timer Specifics */
        .timer-display {
            font-size: 3.5rem; font-weight: 800; font-variant-numeric: tabular-nums;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 16px 0;
        }

        .timer-controls { display: flex; gap: 12px; justify-content: center; }
        
        .btn-icon-circle {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--bg-hover); border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; color: var(--text-secondary);
        }
        .btn-icon-circle:hover { background: var(--text-primary); color: var(--bg-body); transform: rotate(90deg); }

        /* -------------------------------------------------------------------------- */
        /* COURSES                                                                    */
        /* -------------------------------------------------------------------------- */
        .courses-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 24px; padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .btn-new-course {
            background: transparent; border: 2px dashed var(--border-color);
            color: var(--text-secondary); padding: 12px 24px;
            border-radius: var(--radius-md); font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-new-course:hover { border-color: var(--accent-blue); color: var(--accent-blue); background: var(--accent-blue-soft); }

        .course-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }
        
        .course-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            background: var(--course-color, var(--accent-blue));
            transition: background 0.3s;
        }

        .course-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); border-color: var(--text-tertiary); }
        .course-card.active { border-color: var(--course-color); }

        .course-header {
            padding: 20px 24px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; background: linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,0));
            transition: background 0.3s;
        }
        .course-header:hover { background: var(--bg-hover); }

        .course-input-lg {
            font-size: 1.25rem; font-weight: 700;
            border: none; background: transparent;
            width: 100%; color: var(--text-primary);
            padding: 4px; border-radius: 4px; margin-left: 8px;
        }
        .course-input-lg:focus { background: var(--bg-input); }

        .course-progress-track {
            position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: transparent;
        }
        .course-progress-fill { height: 100%; transition: width 0.8s ease; opacity: 0.5; }

        .course-body {
            display: none;
            border-top: 1px solid var(--border-color);
            background: var(--bg-body);
            animation: expandHeight 0.4s ease forwards;
            max-height: 500px;
            overflow-y: auto;
        }
        .course-card.open .course-body { display: block; }

        /* Category Section */
        .category-section { padding: 24px; border-bottom: 1px dashed var(--border-color); }
        .category-header { display: flex; justify-content: space-between; margin-bottom: 16px; align-items: center; }
        
        .category-title {
            font-size: 0.85rem; font-weight: 800; letter-spacing: 0.08em; text-transform: uppercase;
            color: var(--text-tertiary); display: flex; align-items: center; gap: 8px;
        }
        .category-title::before { content: '•'; font-size: 1.5rem; line-height: 0; color: var(--course-color); }

        /* Goal/Lecture Items */
        .goal-item {
            display: flex; align-items: flex-start; gap: 16px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
            position: relative;
            border: 1px solid transparent;
        }
        .goal-item:hover { background: var(--bg-card); box-shadow: var(--shadow-sm); border-color: var(--border-color); }
        
        .goal-inputs { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .goal-main-input { font-size: 1rem; font-weight: 600; border: none; background: transparent; width: 100%; color: var(--text-primary); }
        .goal-sub-input { font-size: 0.85rem; color: var(--text-secondary); border: none; background: transparent; width: 100%; }
        .goal-main-input:focus, .goal-sub-input:focus { background: var(--bg-input); border-radius: 4px; }

        .goal-actions { 
            opacity: 0; transition: opacity 0.2s; display: flex; gap: 4px; 
            position: absolute; right: 10px; top: 10px;
        }
        .goal-item:hover .goal-actions { opacity: 1; }

        /* Course Footer (Color Picker) */
        .course-footer {
            padding: 16px 24px; background: var(--bg-card);
            display: flex; justify-content: space-between; align-items: center;
        }

        .course-colors { display: flex; gap: 6px; }
        .cc-dot {
            width: 18px; height: 18px; border-radius: 4px; cursor: pointer;
            opacity: 0.4; transition: all 0.2s; border: 2px solid transparent;
        }
        .cc-dot:hover { opacity: 1; transform: scale(1.1); }
        .cc-dot.active { opacity: 1; border-color: var(--text-primary); transform: scale(1.15); }

        /* -------------------------------------------------------------------------- */
        /* MODALS                                                                     */
        /* -------------------------------------------------------------------------- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);
            z-index: 200; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal {
            background: var(--bg-card); width: 400px; padding: 32px;
            border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);
            transform: scale(0.95); transition: transform 0.3s var(--ease-spring);
            border: 1px solid var(--border-color);
        }
        .modal-overlay.active .modal { transform: scale(1); }

        /* -------------------------------------------------------------------------- */
        /* UTILITY                                                                    */
        /* -------------------------------------------------------------------------- */
        .btn-primary { background: var(--text-primary); color: var(--bg-body); padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; }
        .btn-ghost { background: transparent; color: var(--text-secondary); padding: 8px 16px; border-radius: 8px; font-weight: 500; cursor: pointer; border: 1px solid transparent; }
        .btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }
        .hidden { display: none !important; }
        
        /* Toast Notification */
        #toast {
            position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--text-primary); color: var(--bg-body);
            padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-weight: 500; z-index: 300;
            transition: transform 0.4s var(--ease-spring);
            display: flex; align-items: center; gap: 12px;
        }
        #toast.active { transform: translateX(-50%) translateY(0); }

        @media (max-width: 900px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { position: fixed; transform: translateX(-100%); width: 85%; }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 24px; }
            .toggle-sidebar-btn { display: flex !important; }
        }
    </style>
</head>
<body>

    <div id="loader" style="position:fixed; inset:0; background:var(--bg-body); z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div class="animate-spin" style="width:50px; height:50px; border:4px solid var(--bg-input); border-top-color:var(--accent-blue); border-radius:50%;"></div>
        <h3 style="margin-top:20px; font-weight:600;">Igniting Spark...</h3>
    </div>

    <div id="toast">
        <span id="toastMsg">Action Completed</span>
        <button id="toastUndo" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem;">UNDO</button>
    </div>

    <div class="app-layout" id="appLayout">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center; gap:12px;">
                    <h2 class="text-h2">Tasks</h2>
                    <button type="button" class="btn-random" id="btnRandomTask" title="Pick Random Task">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 8h.01"></path><path d="M8 8h.01"></path><path d="M8 16h.01"></path><path d="M16 16h.01"></path><path d="M12 12h.01"></path></svg>
                        Pick
                    </button>
                </div>
                <button class="btn-ghost" id="sidebarClose" style="display:none;">✕</button>
            </div>

            <div class="task-input-container">
                <form id="addTaskForm">
                    <input type="text" id="taskInput" class="task-main-input" placeholder="What needs focusing?" autocomplete="off">
                    
                    <div class="task-meta-row">
                        <div class="days-input-wrapper">
                            <span class="text-xs" style="color:var(--text-tertiary)">DUE IN</span>
                            <input type="number" id="taskDays" class="days-input" placeholder="0">
                            <span class="text-xs" style="color:var(--text-tertiary)">DAYS</span>
                        </div>
                        <button type="submit" class="btn-primary" style="padding: 8px 16px; font-size:0.85rem;">Add</button>
                    </div>

                    <div class="color-picker">
                        <div class="color-dot active" style="background: var(--accent-blue);" data-color="blue"></div>
                        <div class="color-dot" style="background: var(--accent-purple);" data-color="purple"></div>
                        <div class="color-dot" style="background: var(--accent-green);" data-color="green"></div>
                        <div class="color-dot" style="background: var(--accent-orange);" data-color="orange"></div>
                        <div class="color-dot" style="background: var(--accent-red);" data-color="red"></div>
                    </div>
                </form>
            </div>

            <div class="task-list-wrapper" id="taskScroll">
                <div id="taskList"></div>
                
                <div id="emptyState" class="hidden" style="text-align:center; padding:40px 0; opacity:0.5;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:16px;">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    <p>All caught up!</p>
                </div>

                <div class="completed-section" id="completedSection">
                    <div class="completed-header" onclick="toggleCompleted()">
                        <span class="text-xs">COMPLETED HISTORY</span>
                        <span id="completedArrow">▼</span>
                    </div>
                    <div id="completedList" style="display:none; margin-top:12px;"></div>
                </div>
            </div>

            <div style="margin-top:auto; padding-top:20px; border-top:1px solid var(--border-color); display:flex; justify-content:center;">
                <button type="button" class="btn-ghost" id="themeToggle">◐ Switch Theme</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="sidebar-overlay" id="sidebarOverlay"></div>

            <header class="top-bar">
                <div style="display:flex; align-items:center;">
                    <button type="button" class="toggle-sidebar-btn" id="sidebarToggle">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
                    </button>
                    <div>
                        <p class="text-xs" style="color:var(--text-tertiary); margin-bottom:4px;" id="currentDate">FRIDAY, OCTOBER 24</p>
                        <h1 class="text-h1" id="greeting">Good Morning</h1>
                    </div>
                </div>
                <button type="button" class="auth-btn" id="loginBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                    Sign In
                </button>
            </header>

            <section class="focus-hero" id="focusHero">
                </section>

            <div class="bento-grid">
                <div class="bento-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="text-xs" style="color:var(--text-tertiary)">POMODORO TIMER</span>
                        <button type="button" class="btn-icon-circle" onclick="toggleModal('timerModal')">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        </button>
                    </div>
                    <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                        <div class="timer-display" id="timerDisplay">25:00</div>
                        <div class="timer-controls">
                            <button type="button" id="startTimerBtn" class="btn-primary">Start Focus</button>
                            <button type="button" id="resetTimerBtn" class="btn-ghost">Reset</button>
                        </div>
                    </div>
                </div>

                <div class="bento-card">
                    <span class="text-xs" style="color:var(--text-tertiary)">TODAY'S MOMENTUM</span>
                    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; gap:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                            <span class="text-h1" id="progressPercent">0%</span>
                            <span class="text-body" id="progressText">0/0 Tasks</span>
                        </div>
                        <div style="width:100%; height:8px; background:var(--bg-input); border-radius:10px; overflow:hidden;">
                            <div id="progressBar" style="width:0%; height:100%; background:var(--accent-green); transition: width 0.8s var(--ease-spring);"></div>
                        </div>
                        <p class="text-sm" style="color:var(--text-secondary);" id="progressQuote">Start small, achieve big.</p>
                    </div>
                </div>
            </div>

            <section>
                <div class="courses-header">
                    <div>
                        <h2 class="text-h2">Courses & Projects</h2>
                        <p class="text-body">Manage lectures, labs, and deadlines.</p>
                    </div>
                    <button type="button" class="btn-new-course" onclick="addCourse()">+ New Course</button>
                </div>

                <div id="coursesContainer"></div>
                
                <div id="emptyCourses" class="hidden" style="text-align:center; padding: 60px; color:var(--text-tertiary); border:2px dashed var(--bg-input); border-radius:var(--radius-lg);">
                    <p class="text-h3" style="margin-bottom:8px;">No courses yet</p>
                    <p>Click "New Course" to start organizing your studies.</p>
                </div>
            </section>

        </main>
    </div>

    <div class="modal-overlay" id="timerModal">
        <div class="modal">
            <h3 class="text-h3" style="margin-bottom:24px;">Timer Settings</h3>
            <div style="margin-bottom:20px;">
                <label class="text-xs" style="color:var(--text-secondary); display:block; margin-bottom:8px;">FOCUS DURATION (MIN)</label>
                <input type="number" id="customWorkDur" value="25" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--bg-input); background:var(--bg-body); color:var(--text-primary); font-size:1.1rem;">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:12px;">
                <button type="button" class="btn-ghost" onclick="toggleModal('timerModal')">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveTimerSettings()">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Firebase Config (Placeholder)
        const firebaseConfig = {
          apiKey: "AIzaSyCu6cbaEw4BzXvF8rGx94h6WHarEFH9Z-k",
          authDomain: "coursesprogress-5658f.firebaseapp.com",
          projectId: "coursesprogress-5658f",
          storageBucket: "coursesprogress-5658f.firebasestorage.app",
          messagingSenderId: "572695866101",
          appId: "1:572695866101:web:bb6dc8058387358b7773bc",
          measurementId: "G-XD8W9V1XPE"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        /* -------------------------------------------------------------------------- */
        /* STATE                                                                      */
        /* -------------------------------------------------------------------------- */
        let state = {
            user: null,
            todos: [],
            courses: [],
            focusId: null,
            timer: { isRunning: false, timeLeft: 1500, duration: 25 },
            lastUndo: null,
            isLocalUpdate: false
        };

        const colors = {
            blue: '#0071e3', purple: '#5e5ce6', green: '#34c759',
            orange: '#ff9f0a', red: '#ff3b30', gray: '#8e8e93'
        };

        let activeColor = 'blue';
        let focusTarget = null; 

        /* -------------------------------------------------------------------------- */
        /* HELPERS                                                                    */
        /* -------------------------------------------------------------------------- */
        const getEl = (id) => document.getElementById(id);
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        /* -------------------------------------------------------------------------- */
        /* CORE                                                                       */
        /* -------------------------------------------------------------------------- */
        function init() {
            setTimeout(() => getEl('loader').style.display = 'none', 800);

            const updateTime = () => {
                const now = new Date();
                getEl('currentDate').innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }).toUpperCase();
                const hr = now.getHours();
                getEl('greeting').innerText = hr < 12 ? 'Good Morning' : hr < 18 ? 'Good Afternoon' : 'Good Evening';
            };
            updateTime(); setInterval(updateTime, 60000);

            setupEventListeners();
            
            new Sortable(getEl('taskList'), {
                animation: 150, ghostClass: 'sortable-ghost', delay: 100,
                onEnd: (evt) => reorderTasks(evt.oldIndex, evt.newIndex)
            });

            if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        }

        function setupEventListeners() {
            const toggleSidebar = () => {
                getEl('appLayout').classList.toggle('collapsed');
                getEl('sidebar').classList.toggle('open');
                getEl('sidebarOverlay').classList.toggle('active');
            };
            getEl('sidebarToggle').onclick = toggleSidebar;
            getEl('sidebarClose').onclick = toggleSidebar;
            getEl('sidebarOverlay').onclick = toggleSidebar;

            getEl('themeToggle').onclick = () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            };

            getEl('addTaskForm').onsubmit = (e) => {
                e.preventDefault();
                const text = getEl('taskInput').value.trim();
                const days = parseInt(getEl('taskDays').value) || 0;
                if(text) addTask(text, days);
            };

            // Random Task Button
            getEl('btnRandomTask').onclick = () => {
                const active = state.todos.filter(t => !t.completed);
                if(active.length === 0) {
                    showToast("No tasks to pick from!");
                    return;
                }
                const randomTask = active[Math.floor(Math.random() * active.length)];
                setFocus(randomTask.id);
                // Highlight logic
                setTimeout(() => {
                    const items = document.querySelectorAll('.task-item');
                    items.forEach(item => {
                        // Very simple match. In production, use data-id attributes.
                        if(item.innerHTML.includes(randomTask.text)) {
                            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            item.classList.add('highlight-task');
                            setTimeout(() => item.classList.remove('highlight-task'), 1000);
                        }
                    });
                }, 100);
                showToast("Random task picked!");
            };

            document.querySelectorAll('.color-dot').forEach(dot => {
                dot.onclick = () => {
                    document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                    dot.classList.add('active');
                    activeColor = dot.dataset.color;
                };
            });

            getEl('startTimerBtn').onclick = toggleTimer;
            getEl('resetTimerBtn').onclick = resetTimer;
            
            getEl('toastUndo').onclick = () => {
                if(state.lastUndo) {
                    if(state.lastUndo.type === 'task') state.todos.push(state.lastUndo.data);
                    saveData(); renderTasks(); hideToast();
                }
            };
        }

        /* -------------------------------------------------------------------------- */
        /* DATA LOGIC (OPTIMISTIC UI)                                             */
        /* -------------------------------------------------------------------------- */
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                getEl('loginBtn').innerHTML = `<img src="${user.photoURL}" style="width:20px; height:20px; border-radius:50%; margin-right:8px;"> Sign Out`;
                getEl('loginBtn').onclick = () => signOut(auth);
                
                onSnapshot(doc(db, 'users', user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        // If we just made a local update, ignore the immediate echo from server
                        if (state.isLocalUpdate) { 
                            state.isLocalUpdate = false; 
                            return; 
                        }
                        const d = docSnap.data();
                        state.todos = d.todos || [];
                        state.courses = d.courses || [];
                        state.focusId = d.focusId || null;
                        renderAll();
                    } else {
                        // New user: init empty state
                        state.todos = [];
                        state.courses = [];
                        state.focusId = null;
                        renderAll();
                    }
                });
            } else {
                getEl('loginBtn').innerHTML = 'Sign In';
                getEl('loginBtn').onclick = () => signInWithPopup(auth, provider);
                renderAll();
            }
        });

        // OPTIMISTIC SAVE: Render first, write later.
        function saveData(shouldRender = true) {
            // 1. Render immediately so user sees changes instantly
            if (shouldRender) renderAll();

            // 2. Sync to cloud in background
            if (state.user) {
                state.isLocalUpdate = true; // Mark as local to skip next snapshot echo
                
                // Fire and forget (don't await) to prevent UI blocking
                setDoc(doc(db, 'users', state.user.uid), {
                    todos: state.todos,
                    courses: state.courses,
                    focusId: state.focusId,
                    lastUpdated: new Date().toISOString()
                }, { merge: true }).catch(error => {
                    console.error("Cloud save failed:", error);
                    // Optional: Show toast "Offline mode" or similar
                });
            }
        }

        /* -------------------------------------------------------------------------- */
        /* RENDERING                                                              */
        /* -------------------------------------------------------------------------- */
        function renderAll() {
            renderTasks();
            renderFocus();
            renderCourses();
            renderStats();
        }

        function renderTasks() {
            const list = getEl('taskList');
            list.innerHTML = '';
            
            const active = state.todos.filter(t => !t.completed);
            
            if(active.length === 0) getEl('emptyState').classList.remove('hidden');
            else getEl('emptyState').classList.add('hidden');

            active.forEach(t => {
                const el = document.createElement('div');
                el.className = 'task-item animate-in';
                el.style.setProperty('--task-color', colors[t.color] || colors.blue);
                const daysLeft = t.days ? `<span style="background:var(--bg-input); padding:2px 6px; border-radius:4px;">${t.days}d left</span>` : '';
                
                el.innerHTML = `
                    <div class="checkbox"></div>
                    <div class="task-content">
                        <div class="task-text">${t.text}</div>
                        <div class="task-meta">${daysLeft}</div>
                    </div>
                    <button type="button" class="btn-icon" style="opacity:0.5; border:none; background:transparent;">✕</button>
                `;

                el.onclick = (e) => {
                    if(!e.target.closest('.checkbox') && !e.target.closest('button')) setFocus(t.id);
                };
                el.querySelector('.checkbox').onclick = (e) => { e.stopPropagation(); toggleTask(t.id); };
                el.querySelector('button').onclick = (e) => { e.stopPropagation(); deleteTask(t.id); };

                list.appendChild(el);
            });

            const compList = getEl('completedList');
            compList.innerHTML = '';
            state.todos.filter(t => t.completed).forEach(t => {
                const div = document.createElement('div');
                div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.gap='8px'; div.style.marginBottom='8px'; 
                div.innerHTML = `<div class="checkbox checked" style="width:18px;height:18px;font-size:10px;">✓</div><div style="text-decoration:line-through; font-size:0.9rem;">${t.text}</div>`;
                div.querySelector('.checkbox').onclick = () => toggleTask(t.id);
                compList.appendChild(div);
            });
        }

        function renderFocus() {
            const hero = getEl('focusHero');
            const task = state.todos.find(t => t.id === state.focusId && !t.completed);
            
            if(!task) {
                hero.innerHTML = `
                    <div style="opacity:0.5;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    </div>
                    <h2 class="text-h2" style="margin-top:16px;">No Active Focus</h2>
                    <p class="text-body" style="margin-top:8px;">Select a task from the sidebar to begin.</p>
                `;
                return;
            }

            const color = colors[task.color] || colors.blue;
            hero.innerHTML = `
                <div class="focus-progress-bar" style="background:${color}; width:100%;"></div>
                <div class="focus-label" style="color:${color};">CURRENT PRIORITY</div>
                <h2 class="focus-title animate-in">${task.text}</h2>
                <div class="focus-subtitle">Stay strictly on this task until completion.</div>
                <button type="button" class="btn-primary" style="margin-top:32px; background:${color}; box-shadow:0 8px 20px -4px ${color}80;">
                    Complete Task
                </button>
            `;
            hero.querySelector('button').onclick = () => {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                toggleTask(task.id);
            };
        }

        function renderStats() {
            const total = state.todos.length;
            const done = state.todos.filter(t => t.completed).length;
            const pct = total === 0 ? 0 : Math.round((done/total)*100);
            
            getEl('progressPercent').innerText = `${pct}%`;
            getEl('progressText').innerText = `${done}/${total} Tasks`;
            getEl('progressBar').style.width = `${pct}%`;
            
            const quotes = ["Keep pushing.", "Momentum is key.", "One step at a time.", "You're doing great."];
            if(pct === 100) getEl('progressQuote').innerText = "All done! Amazing work.";
            else getEl('progressQuote').innerText = quotes[Math.floor(Math.random()*quotes.length)];
        }

        function renderCourses() {
            // --- SCROLL & HEIGHT PRESERVATION ---
            const mainContent = document.querySelector('.main-content');
            const savedMainScroll = mainContent ? mainContent.scrollTop : 0;
            const savedCourseScrolls = {};
            
            // Lock height to prevent jump
            const container = getEl('coursesContainer');
            const prevHeight = container.offsetHeight;
            // Force current height before clear
            if(prevHeight > 0) container.style.minHeight = prevHeight + 'px';

            // Save inner scrolls
            state.courses.forEach(c => {
               const el = document.getElementById(`c-body-${c.id}`);
               if(el) savedCourseScrolls[c.id] = el.scrollTop;
            });
            // ---------------------------------

            container.innerHTML = '';

            if(state.courses.length === 0) getEl('emptyCourses').classList.remove('hidden');
            else getEl('emptyCourses').classList.add('hidden');

            state.courses.forEach(course => {
                const totalG = course.categories.reduce((acc, c) => acc + c.goals.length, 0);
                const doneG = course.categories.reduce((acc, c) => acc + c.goals.filter(g => g.completed).length, 0);
                const progress = totalG === 0 ? 0 : (doneG/totalG)*100;
                const cColor = colors[course.color] || colors.blue;

                const card = document.createElement('div');
                card.className = `course-card ${course.isOpen ? 'open active' : ''}`;
                card.style.setProperty('--course-color', cColor);

                // Header
                const header = document.createElement('div');
                header.className = 'course-header';
                header.innerHTML = `
                    <div class="course-progress-track"><div class="course-progress-fill" style="width:${progress}%; background:${cColor}30;"></div></div>
                    <div style="flex:1; z-index:2;">
                        <input class="course-input-lg" value="${course.name}" placeholder="Course Name">
                        <div class="text-xs" style="margin-left:8px; margin-top:4px; color:var(--text-tertiary); display:flex; gap:12px;">
                            <span>${doneG}/${totalG} GOALS</span>
                            <span>${Math.round(progress)}% DONE</span>
                        </div>
                    </div>
                    <div class="btn-icon" style="transform:${course.isOpen ? 'rotate(180deg)' : 'rotate(0)'}; transition:transform 0.3s;">▼</div>
                `;

                const titleInput = header.querySelector('input');
                titleInput.onblur = () => updateCourse(course.id, { name: titleInput.value }, false);
                titleInput.onclick = (e) => e.stopPropagation();
                titleInput.onkeydown = (e) => {
                    if(e.key === 'Enter') {
                        e.preventDefault();
                        if(!course.isOpen) { course.isOpen = true; saveData(); }
                        if(course.categories.length === 0) addCategory(course.id, "Lectures");
                        else addGoal(course.id, course.categories[0].id);
                    }
                };

                header.onclick = (e) => {
                    if(e.target !== titleInput) updateCourse(course.id, { isOpen: !course.isOpen });
                };

                // Body
                const body = document.createElement('div');
                body.className = 'course-body';
                body.id = `c-body-${course.id}`;

                // Categories
                course.categories.forEach(cat => {
                    const section = document.createElement('div');
                    section.className = 'category-section';
                    
                    section.innerHTML = `
                        <div class="category-header">
                            <div class="category-title">${cat.name}</div>
                            <div style="display:flex; gap:8px;">
                                <button type="button" class="btn-ghost" style="padding:4px 8px; font-size:0.75rem;" title="Add Goal">+ Goal</button>
                                <button type="button" class="btn-ghost" style="padding:4px 8px; font-size:0.75rem; color:var(--accent-red);" title="Remove Category">✕</button>
                            </div>
                        </div>
                        <div class="goals-container"></div>
                    `;

                    section.querySelector('button[title="Add Goal"]').onclick = () => addGoal(course.id, cat.id);
                    section.querySelector('button[title="Remove Category"]').onclick = () => deleteCategory(course.id, cat.id);

                    const goalsCont = section.querySelector('.goals-container');
                    cat.goals.forEach(goal => {
                        const gItem = document.createElement('div');
                        gItem.className = 'goal-item';
                        gItem.innerHTML = `
                            <div class="checkbox ${goal.completed ? 'checked' : ''}" style="margin-top:4px;">${goal.completed ? '✓' : ''}</div>
                            <div class="goal-inputs">
                                <input class="goal-main-input" value="${goal.title}" placeholder="Goal Title">
                                <input class="goal-sub-input" value="${goal.subtitle || ''}" placeholder="Details...">
                            </div>
                            <div class="goal-actions">
                                <button type="button" class="btn-icon" style="width:24px; height:24px; border:none; background:transparent;" title="Convert to Task">➔</button>
                                <button type="button" class="btn-icon" style="width:24px; height:24px; color:var(--accent-red); border:none; background:transparent;" title="Delete">✕</button>
                            </div>
                        `;

                        gItem.querySelector('.checkbox').onclick = () => toggleGoal(course.id, cat.id, goal.id);
                        
                        const mainIn = gItem.querySelector('.goal-main-input');
                        mainIn.onblur = () => updateGoal(course.id, cat.id, goal.id, { title: mainIn.value }, false);
                        mainIn.onkeydown = (e) => {
                            if(e.key === 'Enter') {
                                e.preventDefault(); // Stop form submit
                                addGoal(course.id, cat.id);
                            }
                        };

                        const subIn = gItem.querySelector('.goal-sub-input');
                        subIn.onblur = () => updateGoal(course.id, cat.id, goal.id, { subtitle: subIn.value }, false);

                        gItem.querySelector('button[title="Convert to Task"]').onclick = () => convertGoal(course.id, cat.id, goal.id);
                        gItem.querySelector('button[title="Delete"]').onclick = () => deleteGoal(course.id, cat.id, goal.id);

                        if(focusTarget && focusTarget.id === goal.id) {
                            setTimeout(() => mainIn.focus({ preventScroll: true }), 50);
                        }

                        goalsCont.appendChild(gItem);
                    });

                    body.appendChild(section);
                });

                const addCatDiv = document.createElement('div');
                addCatDiv.style.padding = "20px 24px";
                addCatDiv.innerHTML = `<button type="button" class="btn-ghost" style="width:100%; border:1px dashed var(--border-color);">+ Add Category</button>`;
                addCatDiv.onclick = () => {
                    const name = prompt("Category Name (e.g., Labs, Exams):");
                    if(name) addCategory(course.id, name);
                };
                body.appendChild(addCatDiv);

                const footer = document.createElement('div');
                footer.className = 'course-footer';
                
                let colorHtml = `<div class="course-colors">`;
                Object.keys(colors).forEach(k => {
                    colorHtml += `<div class="cc-dot ${course.color === k ? 'active' : ''}" style="background:${colors[k]}" onclick="window.setCourseColor('${course.id}', '${k}')"></div>`;
                });
                colorHtml += `</div>`;
                
                footer.innerHTML = `
                    ${colorHtml}
                    <button type="button" class="btn-ghost" style="color:var(--accent-red); font-size:0.8rem;" onclick="window.delCourse('${course.id}')">Delete Course</button>
                `;
                
                body.appendChild(footer);

                card.appendChild(header);
                card.appendChild(body);
                container.appendChild(card);
            });
            focusTarget = null;

            // --- RESTORE SCROLL ---
            if(mainContent) mainContent.scrollTop = savedMainScroll;
            state.courses.forEach(c => {
                if(savedCourseScrolls[c.id]) {
                    const el = document.getElementById(`c-body-${c.id}`);
                    if(el) el.scrollTop = savedCourseScrolls[c.id];
                }
            });
            
            // Unlock height after a brief moment to allow content to settle
            setTimeout(() => { container.style.minHeight = '0px'; }, 50);
        }

        /* -------------------------------------------------------------------------- */
        /* ACTIONS                                                                    */
        /* -------------------------------------------------------------------------- */
        
        // --- TASKS ---
        function addTask(text, days) {
            state.todos.push({
                id: generateId(), text, days, color: activeColor,
                completed: false, createdAt: new Date().toISOString()
            });
            getEl('taskInput').value = '';
            getEl('taskDays').value = '';
            if(!state.focusId) state.focusId = state.todos[state.todos.length-1].id;
            saveData();
        }

        function toggleTask(id) {
            const t = state.todos.find(x => x.id === id);
            if(t) {
                t.completed = !t.completed;
                if(t.completed) {
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                    if(state.focusId === id) state.focusId = null;
                }
                saveData();
            }
        }

        function deleteTask(id) {
            const idx = state.todos.findIndex(x => x.id === id);
            if(idx > -1) {
                state.lastUndo = { type: 'task', data: state.todos[idx] };
                state.todos.splice(idx, 1);
                if(state.focusId === id) state.focusId = null;
                showToast("Task deleted");
                saveData();
            }
        }

        window.setFocus = (id) => {
            state.focusId = id;
            saveData();
            if(window.innerWidth < 900) {
                getEl('appLayout').classList.add('collapsed');
            }
        };

        function reorderTasks(oldIdx, newIdx) {
            const active = state.todos.filter(t => !t.completed);
            const item = active.splice(oldIdx, 1)[0];
            active.splice(newIdx, 0, item);
            state.todos = [...active, ...state.todos.filter(t => t.completed)];
            saveData();
        }

        // --- COURSES ---
        window.addCourse = () => {
            const id = generateId();
            state.courses.push({
                id, name: 'New Course', color: 'blue', isOpen: true,
                categories: [
                    { id: generateId(), name: 'Lectures', goals: [] },
                    { id: generateId(), name: 'Assignments', goals: [] }
                ]
            });
            saveData();
        };

        function updateCourse(id, updates, shouldRender = true) {
            const c = state.courses.find(x => x.id === id);
            if(c) { Object.assign(c, updates); saveData(shouldRender); }
        }

        window.setCourseColor = (id, color) => {
            updateCourse(id, { color });
        };

        window.delCourse = (id) => {
            if(confirm("Delete this course and all goals?")) {
                state.courses = state.courses.filter(x => x.id !== id);
                saveData();
            }
        };

        // --- CATEGORIES & GOALS ---
        function addCategory(cid, name) {
            const c = state.courses.find(x => x.id === cid);
            c.categories.push({ id: generateId(), name, goals: [] });
            saveData();
        }

        function deleteCategory(cid, catId) {
            const c = state.courses.find(x => x.id === cid);
            c.categories = c.categories.filter(x => x.id !== catId);
            saveData();
        }

        function addGoal(cid, catId) {
            const c = state.courses.find(x => x.id === cid);
            const cat = c.categories.find(x => x.id === catId);
            const newId = generateId();
            cat.goals.push({ id: newId, title: '', completed: false });
            focusTarget = { id: newId };
            saveData();
        }

        function updateGoal(cid, catId, gid, updates, shouldRender = true) {
            const c = state.courses.find(x => x.id === cid);
            const cat = c.categories.find(x => x.id === catId);
            const g = cat.goals.find(x => x.id === gid);
            Object.assign(g, updates);
            saveData(shouldRender);
        }

        function toggleGoal(cid, catId, gid) {
            const c = state.courses.find(x => x.id === cid);
            const cat = c.categories.find(x => x.id === catId);
            const g = cat.goals.find(x => x.id === gid);
            g.completed = !g.completed;
            if(g.completed) confetti({ particleCount: 30, spread: 40, origin: { x: 0.5, y: 0.5 } });
            saveData();
        }

        function deleteGoal(cid, catId, gid) {
            const c = state.courses.find(x => x.id === cid);
            const cat = c.categories.find(x => x.id === catId);
            cat.goals = cat.goals.filter(x => x.id !== gid);
            saveData();
        }

        function convertGoal(cid, catId, gid) {
            const c = state.courses.find(x => x.id === cid);
            const cat = c.categories.find(x => x.id === catId);
            const g = cat.goals.find(x => x.id === gid);
            
            addTask(`[${c.name}] ${g.title}`, null);
            deleteGoal(cid, catId, gid);
            showToast("Converted to Task");
        }

        /* -------------------------------------------------------------------------- */
        /* TIMER & UTILS                                                              */
        /* -------------------------------------------------------------------------- */
        window.toggleModal = (id) => getEl(id).classList.toggle('active');

        window.toggleCompleted = () => {
            const list = getEl('completedList');
            const arrow = getEl('completedArrow');
            if(list.style.display === 'none') {
                list.style.display = 'block';
                arrow.innerText = '▲';
            } else {
                list.style.display = 'none';
                arrow.innerText = '▼';
            }
        };

        window.saveTimerSettings = () => {
            const d = parseInt(getEl('customWorkDur').value);
            if(d > 0) state.timer.duration = d;
            resetTimer();
            window.toggleModal('timerModal');
        };

        let timerInterval;
        function toggleTimer() {
            const btn = getEl('startTimerBtn');
            if(state.timer.isRunning) {
                clearInterval(timerInterval);
                state.timer.isRunning = false;
                btn.innerText = "Resume";
                btn.style.background = "var(--accent-green)";
            } else {
                if(state.timer.timeLeft === undefined) state.timer.timeLeft = state.timer.duration * 60;
                state.timer.isRunning = true;
                btn.innerText = "Pause";
                btn.style.background = "var(--accent-orange)";
                
                timerInterval = setInterval(() => {
                    if(state.timer.timeLeft > 0) {
                        state.timer.timeLeft--;
                        getEl('timerDisplay').innerText = formatTime(state.timer.timeLeft);
                    } else {
                        clearInterval(timerInterval);
                        state.timer.isRunning = false;
                        alert("Focus Session Complete!");
                        resetTimer();
                    }
                }, 1000);
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            state.timer.isRunning = false;
            state.timer.timeLeft = state.timer.duration * 60;
            getEl('timerDisplay').innerText = formatTime(state.timer.timeLeft);
            const btn = getEl('startTimerBtn');
            btn.innerText = "Start Focus";
            btn.style.background = "var(--text-primary)";
        }

        function showToast(msg) {
            getEl('toastMsg').innerText = msg;
            getEl('toast').classList.add('active');
            setTimeout(hideToast, 4000);
        }

        function hideToast() {
            getEl('toast').classList.remove('active');
            setTimeout(() => { state.lastUndo = null; }, 500);
        }

        // Initialize
        init();

    </script>
</body>
</html>
