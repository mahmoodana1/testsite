<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#F2F2F7">
  <title>Study Spark | Ultimate Workspace</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

  <style>
    /* -------------------------------------------------------------------------- */
    /* VARIABLES                                                                  */
    /* -------------------------------------------------------------------------- */
    :root {
      /* LIGHT MODE: CLEAN MINIMAL AESTHETIC (IKEA/APPLE INSPIRED) */
      --bg-body: #FAFAFA;
      /* Clean light gray, not pure white */
      --bg-sidebar: rgba(255, 255, 255, 0.98);
      /* Solid white for sidebar */
      --bg-card: #FFFFFF;
      /* Pure white cards */
      --bg-glass: rgba(255, 255, 255, 0.95);

      /* Subtle borders for clean look */
      --bg-glass-border: 1px solid rgba(0, 0, 0, 0.06);
      --border-color: rgba(0, 0, 0, 0.08);

      --bg-input: rgba(0, 0, 0, 0.03);
      --bg-hover: rgba(0, 0, 0, 0.05);

      /* Monochrome text hierarchy */
      --text-primary: #111111;
      --text-secondary: #666666;
      --text-tertiary: #999999;

      /* Minimal Monochrome Accents - subtle and refined */
      /* Muted blue-gray - primary accent */
      --accent-blue: #5B7C99;
      --accent-blue-soft: rgba(91, 124, 153, 0.08);

      /* Warm gray-purple */
      --accent-purple: #8B7E9E;

      /* Soft sage green */
      --accent-green: #7A9B7E;
      --accent-green-soft: rgba(122, 155, 126, 0.08);

      /* Warm amber */
      --accent-orange: #B89968;

      /* Muted terracotta */
      --accent-red: #B87E7E;

      /* Clean Shadows - very subtle */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.04), 0 3px 6px rgba(0, 0, 0, 0.03);
      --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.04), 0 6px 12px rgba(0, 0, 0, 0.03);
      --shadow-glass: 0 4px 16px rgba(0, 0, 0, 0.04);

      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --sidebar-width: 400px;

      --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      --blur-amt: 20px;
      /* Glass strength */
    }

    /* THEME SYSTEM - Multiple themes support */
    /* Theme: Catppuccin (default dark) */
    body.theme-catppuccin {
      --bg-body: #1e1e2e;
      --bg-sidebar: #181825;
      --bg-card: #11111b;
      --bg-glass: rgba(30, 30, 46, 0.85);
      --bg-glass-border: 1px solid rgba(255, 255, 255, 0.08);
      --bg-input: #313244;
      --bg-hover: #45475a;
      --text-primary: #cdd6f4;
      --text-secondary: #a6adc8;
      --text-tertiary: #6c7086;
      --border-color: #313244;
      --accent-blue: #89b4fa;
      --accent-blue-soft: rgba(137, 180, 250, 0.15);
      --accent-purple: #cba6f7;
      --accent-green: #a6e3a1;
      --accent-green-soft: rgba(166, 227, 161, 0.15);
      --accent-orange: #fab387;
      --accent-red: #f38ba8;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.6);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.8);
      --blur-amt: 0px;
    }

    /* Theme: Nord */
    body.theme-nord {
      --bg-body: #2e3440;
      --bg-sidebar: #3b4252;
      --bg-card: #434c5e;
      --bg-glass: rgba(46, 52, 64, 0.85);
      --bg-glass-border: 1px solid rgba(236, 239, 244, 0.1);
      --bg-input: #4c566a;
      --bg-hover: #5e81ac;
      --text-primary: #eceff4;
      --text-secondary: #d8dee9;
      --text-tertiary: #88c0d0;
      --border-color: #4c566a;
      --accent-blue: #88c0d0;
      --accent-blue-soft: rgba(136, 192, 208, 0.15);
      --accent-purple: #b48ead;
      --accent-green: #a3be8c;
      --accent-green-soft: rgba(163, 190, 140, 0.15);
      --accent-orange: #d08770;
      --accent-red: #bf616a;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.6);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.8);
      --blur-amt: 0px;
    }

    /* Theme: Dracula */
    body.theme-dracula {
      --bg-body: #282a36;
      --bg-sidebar: #21222c;
      --bg-card: #1e1f29;
      --bg-glass: rgba(40, 42, 54, 0.85);
      --bg-glass-border: 1px solid rgba(248, 248, 242, 0.1);
      --bg-input: #44475a;
      --bg-hover: #6272a4;
      --text-primary: #f8f8f2;
      --text-secondary: #bfbfbf;
      --text-tertiary: #6272a4;
      --border-color: #44475a;
      --accent-blue: #8be9fd;
      --accent-blue-soft: rgba(139, 233, 253, 0.15);
      --accent-purple: #bd93f9;
      --accent-green: #50fa7b;
      --accent-green-soft: rgba(80, 250, 123, 0.15);
      --accent-orange: #ffb86c;
      --accent-red: #ff5555;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.7);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.9);
      --blur-amt: 0px;
    }

    /* Theme: Gruvbox */
    body.theme-gruvbox {
      --bg-body: #282828;
      --bg-sidebar: #1d2021;
      --bg-card: #32302f;
      --bg-glass: rgba(40, 40, 40, 0.85);
      --bg-glass-border: 1px solid rgba(235, 219, 178, 0.1);
      --bg-input: #3c3836;
      --bg-hover: #504945;
      --text-primary: #ebdbb2;
      --text-secondary: #d5c4a1;
      --text-tertiary: #a89984;
      --border-color: #504945;
      --accent-blue: #83a598;
      --accent-blue-soft: rgba(131, 165, 152, 0.15);
      --accent-purple: #d3869b;
      --accent-green: #b8bb26;
      --accent-green-soft: rgba(184, 187, 38, 0.15);
      --accent-orange: #fe8019;
      --accent-red: #fb4934;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.7);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.9);
      --blur-amt: 0px;
    }

    /* Theme: Solarized Dark */
    body.theme-solarized-dark {
      --bg-body: #002b36;
      --bg-sidebar: #073642;
      --bg-card: #002b36;
      --bg-glass: rgba(0, 43, 54, 0.85);
      --bg-glass-border: 1px solid rgba(131, 148, 150, 0.1);
      --bg-input: #073642;
      --bg-hover: #586e75;
      --text-primary: #839496;
      --text-secondary: #93a1a1;
      --text-tertiary: #657b83;
      --border-color: #073642;
      --accent-blue: #268bd2;
      --accent-blue-soft: rgba(38, 139, 210, 0.15);
      --accent-purple: #6c71c4;
      --accent-green: #859900;
      --accent-green-soft: rgba(133, 153, 0, 0.15);
      --accent-orange: #cb4b16;
      --accent-red: #dc322f;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.7);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.9);
      --blur-amt: 0px;
    }

    /* Theme: Solarized Light */
    body.theme-solarized-light {
      --bg-body: #fdf6e3;
      --bg-sidebar: rgba(255, 255, 255, 0.98);
      --bg-card: #eee8d5;
      --bg-glass: rgba(253, 246, 227, 0.95);
      --bg-glass-border: 1px solid rgba(0, 0, 0, 0.06);
      --bg-input: #eee8d5;
      --bg-hover: #93a1a1;
      --text-primary: #657b83;
      --text-secondary: #586e75;
      --text-tertiary: #93a1a1;
      --border-color: rgba(0, 0, 0, 0.08);
      --accent-blue: #268bd2;
      --accent-blue-soft: rgba(38, 139, 210, 0.08);
      --accent-purple: #6c71c4;
      --accent-green: #859900;
      --accent-green-soft: rgba(133, 153, 0, 0.08);
      --accent-orange: #cb4b16;
      --accent-red: #dc322f;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.04), 0 3px 6px rgba(0, 0, 0, 0.03);
      --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.04), 0 6px 12px rgba(0, 0, 0, 0.03);
      --blur-amt: 20px;
    }

    /* Theme: Monokai */
    body.theme-monokai {
      --bg-body: #272822;
      --bg-sidebar: #1e1f1c;
      --bg-card: #2e2e2e;
      --bg-glass: rgba(39, 40, 34, 0.85);
      --bg-glass-border: 1px solid rgba(248, 248, 240, 0.1);
      --bg-input: #3e3d32;
      --bg-hover: #49483e;
      --text-primary: #f8f8f2;
      --text-secondary: #cfcfc2;
      --text-tertiary: #75715e;
      --border-color: #49483e;
      --accent-blue: #66d9ef;
      --accent-blue-soft: rgba(102, 217, 239, 0.15);
      --accent-purple: #ae81ff;
      --accent-green: #a6e22e;
      --accent-green-soft: rgba(166, 226, 46, 0.15);
      --accent-orange: #fd971f;
      --accent-red: #f92672;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.7);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.9);
      --blur-amt: 0px;
    }

    /* Theme: One Dark */
    body.theme-onedark {
      --bg-body: #282c34;
      --bg-sidebar: #21252b;
      --bg-card: #2c313a;
      --bg-glass: rgba(40, 44, 52, 0.85);
      --bg-glass-border: 1px solid rgba(171, 178, 191, 0.1);
      --bg-input: #3e4451;
      --bg-hover: #4b5263;
      --text-primary: #abb2bf;
      --text-secondary: #828997;
      --text-tertiary: #5c6370;
      --border-color: #3e4451;
      --accent-blue: #61afef;
      --accent-blue-soft: rgba(97, 175, 239, 0.15);
      --accent-purple: #c678dd;
      --accent-green: #98c379;
      --accent-green-soft: rgba(152, 195, 121, 0.15);
      --accent-orange: #d19a66;
      --accent-red: #e06c75;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.6);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.8);
      --blur-amt: 0px;
    }

    /* Theme: Tokyo Night */
    body.theme-tokyonight {
      --bg-body: #1a1b26;
      --bg-sidebar: #16161e;
      --bg-card: #24283b;
      --bg-glass: rgba(26, 27, 38, 0.85);
      --bg-glass-border: 1px solid rgba(169, 177, 214, 0.1);
      --bg-input: #292e42;
      --bg-hover: #3b4261;
      --text-primary: #c0caf5;
      --text-secondary: #a9b1d6;
      --text-tertiary: #565f89;
      --border-color: #292e42;
      --accent-blue: #7aa2f7;
      --accent-blue-soft: rgba(122, 162, 247, 0.15);
      --accent-purple: #bb9af7;
      --accent-green: #9ece6a;
      --accent-green-soft: rgba(158, 206, 106, 0.15);
      --accent-orange: #ff9e64;
      --accent-red: #f7768e;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.6);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.8);
      --blur-amt: 0px;
    }

    /* Backwards compatibility: keep dark-mode class for existing functionality */
    body.dark-mode {
      --bg-body: #1e1e2e;
      --bg-sidebar: #181825;
      --bg-card: #11111b;
      --bg-glass: rgba(30, 30, 46, 0.85);
      --bg-glass-border: 1px solid rgba(255, 255, 255, 0.08);
      --bg-input: #313244;
      --bg-hover: #45475a;
      --text-primary: #cdd6f4;
      --text-secondary: #a6adc8;
      --text-tertiary: #6c7086;
      --border-color: #313244;
      --accent-blue: #89b4fa;
      --accent-blue-soft: rgba(137, 180, 250, 0.15);
      --accent-purple: #cba6f7;
      --accent-green: #a6e3a1;
      --accent-green-soft: rgba(166, 227, 161, 0.15);
      --accent-orange: #fab387;
      --accent-red: #f38ba8;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.6);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.8);
      --blur-amt: 0px;
    }

    /* -------------------------------------------------------------------------- */
    /* RESET                                                                      */
    /* -------------------------------------------------------------------------- */
    * {
      box-sizing: border-box;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-body);
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
      overflow: hidden;
    }

    input,
    button,
    textarea {
      font-family: inherit;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    ul,
    li {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p {
      margin: 0;
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-tertiary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* -------------------------------------------------------------------------- */
    /* TYPOGRAPHY                                                                 */
    /* -------------------------------------------------------------------------- */
    .text-h1 {
      font-size: 2.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.1;
    }

    .text-h2 {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .text-h3 {
      font-size: 1.2rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .text-body {
      font-size: 1rem;
      line-height: 1.5;
      color: var(--text-secondary);
    }

    .text-sm {
      font-size: 0.875rem;
    }

    .text-xs {
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    /* -------------------------------------------------------------------------- */
    /* LAYOUT & ANIMATIONS                                                        */
    /* -------------------------------------------------------------------------- */
    .app-layout {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      transition: grid-template-columns 0.4s var(--ease-spring);
    }

    .app-layout.collapsed {
      grid-template-columns: 0px 1fr;
    }

    .app-layout.collapsed .sidebar {
      opacity: 0;
      transform: translateX(-20px);
      pointer-events: none;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(90deg);
      }
    }

    @keyframes highlightPulse {
      0% {
        box-shadow: 0 0 0 0 var(--accent-blue-soft);
        transform: scale(1);
      }

      50% {
        box-shadow: 0 0 0 6px var(--accent-blue-soft);
        transform: scale(1.02);
        border-color: var(--accent-blue);
      }

      100% {
        box-shadow: 0 0 0 0 transparent;
        transform: scale(1);
      }
    }

    .animate-in {
      animation: fadeInUp 0.5s var(--ease-spring) forwards;
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    .highlight-task {
      animation: highlightPulse 0.8s ease-in-out;
      border-color: var(--accent-blue) !important;
    }

    /* -------------------------------------------------------------------------- */
    /* SIDEBAR (GLASSY)                                                           */
    /* -------------------------------------------------------------------------- */
    .sidebar {
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-color);
      /* GLASS EFFECT */
      backdrop-filter: blur(var(--blur-amt));
      -webkit-backdrop-filter: blur(var(--blur-amt));

      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 32px;
      z-index: 50;
      transition: transform 0.4s var(--ease-spring), opacity 0.3s;
      position: relative;
      overflow: hidden;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .btn-random {
      background: var(--bg-input);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-random:hover {
      background: var(--text-primary);
      color: var(--bg-body);
      border-color: var(--text-primary);
    }

    .task-input-container {
      background: var(--bg-card);
      /* Use card bg for glass effect */
      backdrop-filter: blur(var(--blur-amt));
      border-radius: var(--radius-md);
      padding: 16px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
    }

    .task-input-container:focus-within {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 4px var(--accent-blue-soft);
    }

    .task-main-input {
      width: 100%;
      border: none;
      background: transparent;
      font-size: 1rem;
      color: var(--text-primary);
      padding: 8px 0;
      margin-bottom: 12px;
    }

    .task-main-input::placeholder {
      color: var(--text-tertiary);
    }

    .task-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .days-input-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-input);
      padding: 6px 12px;
      border-radius: var(--radius-sm);
    }

    .days-input {
      width: 40px;
      background: transparent;
      border: none;
      text-align: center;
      font-weight: 600;
      color: var(--text-primary);
    }

    .color-picker {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .color-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.3s var(--ease-spring);
      border: 2px solid transparent;
      position: relative;
    }

    .color-dot:hover {
      transform: scale(1.2);
    }

    .color-dot.active {
      transform: scale(1.25);
      border-color: var(--text-primary);
    }

    .task-list-wrapper {
      flex: 1;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #taskList,
    #completedList {
      overflow-y: auto;
      padding-right: 4px;
    }

    #taskList {
      max-height: 380px;
    }

    #completedList {
      max-height: 380px;
      margin-top: 12px;
      display: none;
    }

    /* GLASSY TASK ITEM */
    .task-item {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--bg-card);
      backdrop-filter: blur(var(--blur-amt));

      padding: 18px;
      margin-bottom: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor: grab;
      position: relative;
      overflow: hidden;
      min-height: 64px;
    }

    .task-item:hover {
      transform: translateX(4px) scale(1.005);
      box-shadow: var(--shadow-md);
      border-color: var(--accent-blue);
    }

    .task-item:active {
      cursor: grabbing;
      transform: scale(0.98);
    }

    .task-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      background: var(--task-color, var(--accent-blue));
      transition: width 0.2s;
    }

    .task-item:hover::before {
      width: 8px;
    }

    .checkbox {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--text-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s var(--ease-spring);
      flex-shrink: 0;
      color: white;
    }

    .checkbox:hover {
      border-color: var(--accent-green);
      background: var(--accent-green-soft);
    }

    .checkbox.checked {
      background: var(--accent-green);
      border-color: var(--accent-green);
    }

    .task-content {
      flex: 1;
      min-width: 0;
    }

    .task-text {
      font-weight: 500;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: all 0.2s ease;
    }

    .task-item:hover .task-text {
      white-space: normal;
      overflow: visible;
      word-break: break-word;
    }

    .task-meta {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-delete-task {
      opacity: 0.6;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-delete-task:hover {
      opacity: 1;
      background: rgba(255, 59, 48, 0.1);
      color: var(--accent-red);
    }

    .completed-section {
      margin-top: 20px;
      border-top: 1px solid var(--border-color);
      padding-top: 16px;
    }

    .completed-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 8px 0;
      color: var(--text-secondary);
    }

    .completed-header:hover {
      color: var(--text-primary);
    }

    #completedList {
      opacity: 0.6;
      transition: opacity 0.3s;
    }

    body.dark-mode #completedList {
      opacity: 0.5;
    }

    #completedList:hover {
      opacity: 1;
    }

    /* -------------------------------------------------------------------------- */
    /* MAIN CONTENT                                                               */
    /* -------------------------------------------------------------------------- */
    .main-content {
      background: var(--bg-body);
      overflow-y: auto;
      padding: 48px 64px;
      position: relative;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 48px;
    }

    .toggle-sidebar-btn {
      background: var(--bg-sidebar);
      border: 1px solid var(--border-color);
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 20px;
      color: var(--text-primary);
    }

    .toggle-sidebar-btn:hover {
      background: var(--text-primary);
      color: var(--bg-body);
      transform: scale(1.05);
    }

    .auth-btn {
      background: var(--text-primary);
      color: var(--bg-body);
      padding: 10px 24px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      height: 42px;
    }

    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      opacity: 0.9;
    }

    .focus-hero {
      background: var(--bg-glass);
      backdrop-filter: blur(40px);
      border: var(--bg-glass-border);
      border-radius: var(--radius-lg);
      padding: 40px;
      margin-bottom: 32px;
      box-shadow: var(--shadow-glass);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 220px;
      transition: transform 0.3s;
    }

    .focus-hero:hover {
      transform: translateY(-4px);
    }

    .focus-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 4px;
      background: var(--accent-green);
      transition: width 1s ease;
      box-shadow: 0 2px 10px rgba(52, 199, 89, 0.4);
    }

    .focus-label {
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--accent-blue);
      margin-bottom: 16px;
      opacity: 0.8;
    }

    .focus-title {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 8px;
      line-height: 1.2;
    }

    .focus-subtitle {
      font-size: 1.1rem;
      color: var(--text-secondary);
      max-width: 600px;
    }

    /* GLASSY CARDS */
    .bento-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-bottom: 48px;
    }

    .bento-card {
      background: var(--bg-card);
      backdrop-filter: blur(var(--blur-amt));

      border-radius: var(--radius-lg);
      padding: 24px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: all 0.3s;
    }

    .bento-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: var(--text-tertiary);
    }

    .timer-display {
      font-size: 3.5rem;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
      background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 16px 0;
    }

    .timer-controls,
    .timer-presets {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .timer-presets {
      margin-top: 10px;
    }

    .btn-icon-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg-hover);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-secondary);
    }

    .btn-icon-circle:hover {
      background: var(--text-primary);
      color: var(--bg-body);
      transform: rotate(90deg);
    }

    .courses-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .btn-new-course {
      background: transparent;
      border: 2px dashed var(--border-color);
      color: var(--text-secondary);
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-new-course:hover {
      border-color: var(--accent-blue);
      color: var(--accent-blue);
      background: var(--accent-blue-soft);
    }

    .courses-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .course-card-compact {
      background: var(--bg-card);
      backdrop-filter: blur(var(--blur-amt));

      border-radius: var(--radius-md);
      padding: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
    }

    .course-card-compact::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 6px;
      background: var(--course-color, var(--accent-blue));
      transition: width 0.3s;
    }

    .course-card-compact:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--course-color);
    }

    .course-card-compact:hover::before {
      width: 12px;
    }

    .course-card-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .course-card-stats {
      display: flex;
      gap: 16px;
      font-size: 0.8rem;
      color: var(--text-tertiary);
      margin-bottom: 12px;
    }

    .course-card-progress {
      width: 100%;
      height: 6px;
      background: var(--bg-input);
      border-radius: 10px;
      overflow: hidden;
    }

    .course-card-progress-fill {
      height: 100%;
      background: var(--course-color);
      transition: width 0.8s ease;
    }

    /* MODALS */
    .course-modal-overlay,
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 300;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      padding: 20px;
    }

    .active {
      opacity: 1;
      pointer-events: auto;
    }

    .course-modal {
      background: var(--bg-card);
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      transform: scale(0.95);
      transition: transform 0.3s var(--ease-spring);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .modal {
      background: var(--bg-card);
      width: 400px;
      padding: 32px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      transform: scale(0.95);
      transition: transform 0.3s var(--ease-spring);
      border: 1px solid var(--border-color);
    }

    .active .course-modal,
    .active .modal {
      transform: scale(1);
    }

    .course-modal-header {
      padding: 24px 32px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      z-index: 10;
    }

    .course-modal-title-input {
      font-size: 1.8rem;
      font-weight: 800;
      border: none;
      background: transparent;
      width: 100%;
      color: var(--text-primary);
      padding: 4px 0;
      border-radius: 4px;
      font-family: 'Inter', sans-serif;
    }

    .course-modal-title-input:focus {
      outline: none;
      border-bottom: 2px solid var(--accent-blue);
    }

    .course-modal-close {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-input);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-secondary);
      flex-shrink: 0;
      margin-left: 20px;
    }

    .course-modal-close:hover {
      background: var(--accent-red);
      color: white;
      transform: rotate(90deg);
    }

    .course-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
      background: var(--bg-body);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .course-modal-footer {
      padding: 20px 32px;
      background: var(--bg-card);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
      z-index: 10;
    }

    .category-section {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
    }

    .category-section:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--text-tertiary);
    }

    .category-section::before {
      content: '';
      position: absolute;
      left: 0;
      top: 20px;
      bottom: 20px;
      width: 4px;
      background: var(--course-color);
      border-radius: 0 4px 4px 0;
      opacity: 0.9;
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      align-items: center;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--bg-input);
      padding-left: 12px;
    }

    .category-title {
      font-size: 0.9rem;
      font-weight: 800;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .btn-add-goal {
      background: var(--bg-input);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-add-goal:hover {
      background: var(--accent-blue);
      color: white;
    }

    .goal-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 12px 16px;
      border-radius: 12px;
      transition: all 0.2s;
      position: relative;
      border: 1px solid transparent;
      background: var(--bg-body);
      margin-bottom: 10px;
    }

    .goal-item:hover {
      background: var(--bg-hover);
    }

    .goal-item:focus-within {
      background: var(--bg-card);
      border-color: var(--accent-blue);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transform: translateX(4px);
    }

    .goal-inputs {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .goal-main-input {
      font-size: 1rem;
      font-weight: 600;
      border: none;
      background: transparent;
      width: 100%;
      color: var(--text-primary);
      padding: 2px 0;
    }

    .goal-sub-input {
      font-size: 0.85rem;
      color: var(--text-tertiary);
      border: none;
      background: transparent;
      width: 100%;
    }

    .goal-main-input:focus,
    .goal-sub-input:focus {
      color: var(--accent-blue);
    }

    .goal-actions {
      opacity: 0;
      transition: opacity 0.2s;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .goal-item:hover .goal-actions,
    .goal-item:focus-within .goal-actions {
      opacity: 1;
    }

    .course-colors {
      display: flex;
      gap: 8px;
      background: var(--bg-input);
      padding: 6px;
      border-radius: 50px;
    }

    .cc-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      opacity: 0.5;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .cc-dot:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .cc-dot.active {
      opacity: 1;
      border-color: var(--bg-card);
      box-shadow: 0 0 0 2px var(--text-primary);
      transform: scale(1.1);
    }

    /* UTILITY */
    .btn-primary {
      background: var(--text-primary);
      color: var(--bg-body);
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .btn-danger {
      background: rgba(210, 15, 57, 0.1);
      color: var(--accent-red);
      padding: 10px 24px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-danger:hover {
      background: var(--accent-red);
      color: white;
    }

    .hidden {
      display: none !important;
    }

    #toast {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--text-primary);
      color: var(--bg-body);
      padding: 12px 24px;
      border-radius: 50px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      font-weight: 500;
      z-index: 300;
      transition: transform 0.4s var(--ease-spring);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #toast.active {
      transform: translateX(-50%) translateY(0);
    }

    /* MOBILE */
    @media (max-width: 900px) {

      body,
      html {
        overflow: auto;
      }

      .app-layout {
        grid-template-columns: 1fr;
        height: auto;
        min-height: 100vh;
      }

      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 85%;
        max-width: 320px;
        height: 100vh;
        transform: translateX(-100%);
        box-shadow: none;
        z-index: 1000;
      }

      .sidebar.open {
        transform: translateX(0);
        box-shadow: var(--shadow-lg);
      }

      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }

      .sidebar-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      #sidebarClose {
        display: block !important;
      }

      .main-content {
        padding: 24px;
        overflow-y: visible;
        height: auto;
      }

      .toggle-sidebar-btn {
        display: flex !important;
      }

      .app-layout.collapsed .sidebar {
        transform: translateX(-100%);
      }

      .courses-grid {
        grid-template-columns: 1fr;
      }

      .course-modal {
        max-height: 85vh;
      }

      .text-h1 {
        font-size: 2rem;
      }

      .focus-title {
        font-size: 1.8rem;
      }

      .checkbox {
        width: 28px;
        height: 28px;
      }

      .task-item {
        padding: 20px;
      }

      #taskList,
      #completedList {
        max-height: 230px;
      }
    }

    /* Theme Selector Dropdown */
    .theme-selector-container {
      position: relative;
    }

    .theme-selector-btn {
      padding: 10px;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .theme-selector-btn:hover {
      background: var(--bg-hover);
    }

    .theme-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      min-width: 220px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 1000;
      max-height: 400px;
      overflow-y: auto;
    }

    .theme-dropdown.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .theme-dropdown-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .theme-option {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .theme-option:hover {
      background: var(--bg-hover);
    }

    .theme-option.active {
      background: var(--accent-blue-soft);
      color: var(--accent-blue);
      font-weight: 600;
    }

    .theme-color-preview {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    .theme-divider {
      height: 1px;
      background: var(--border-color);
      margin: 4px 0;
    }

    /* Custom Theme Creator Modal */
    .custom-theme-modal {
      background: var(--bg-card);
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      transform: scale(0.95);
      transition: transform 0.3s var(--ease-spring);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .active .custom-theme-modal {
      transform: scale(1);
    }

    .custom-theme-header {
      padding: 24px 32px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .custom-theme-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .custom-theme-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px 32px;
      background: var(--bg-body);
    }

    .color-picker-group {
      margin-bottom: 24px;
    }

    .color-picker-label {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .color-picker-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .color-picker-input {
      width: 60px;
      height: 40px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      padding: 4px;
    }

    .color-picker-hex {
      flex: 1;
      padding: 10px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
    }

    .custom-theme-footer {
      padding: 20px 32px;
      background: var(--bg-card);
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .preview-box {
      padding: 20px;
      background: var(--bg-body);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      margin-bottom: 24px;
    }

    .preview-text {
      margin-bottom: 8px;
    }

    .preview-primary {
      color: var(--text-primary);
      font-weight: 600;
    }

    .preview-secondary {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .preview-accent {
      display: inline-block;
      padding: 4px 12px;
      background: var(--accent-blue-soft);
      color: var(--accent-blue);
      border-radius: 6px;
      font-size: 0.85rem;
      margin-top: 8px;
    }
  </style>
</head>

<body>

  <div id="loader"
    style="position:fixed; inset:0; background:var(--bg-body); z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div class="animate-spin"
      style="width:50px; height:50px; border:4px solid var(--bg-input); border-top-color:var(--accent-blue); border-radius:50%;">
    </div>
    <h3 style="margin-top:20px; font-weight:600;">Igniting Spark...</h3>
  </div>

  <div id="toast">
    <span id="toastMsg">Action Completed</span>
    <button id="toastUndo"
      style="background:rgba(255,255,255,0.2); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem;">UNDO</button>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="app-layout" id="appLayout">

    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div style="display:flex; align-items:center; gap:12px;">
          <h2 class="text-h2">Tasks</h2>
          <button type="button" class="btn-random" id="btnRandomTask" title="Pick Random Task">
            Pick Random
          </button>
        </div>
        <button class="btn-ghost" id="sidebarClose">✕</button>
      </div>

      <div class="task-input-container">
        <form id="addTaskForm">
          <input type="text" id="taskInput" class="task-main-input" placeholder="What needs focusing?"
            autocomplete="off">

          <div class="task-meta-row">
            <div class="days-input-wrapper">
              <span class="text-xs" style="color:var(--text-tertiary)">DUE IN</span>
              <input type="text" id="taskDays" class="days-input" placeholder="Due">
              <span class="text-xs" style="color:var(--text-tertiary)">DAYS</span>
            </div>
            <button type="submit" class="btn-primary" style="padding: 8px 16px; font-size:0.85rem;">Add</button>
          </div>

          <div class="color-picker">
            <div class="color-dot active" style="background: var(--accent-blue);" data-color="blue"></div>
            <div class="color-dot" style="background: var(--accent-purple);" data-color="purple"></div>
            <div class="color-dot" style="background: var(--accent-green);" data-color="green"></div>
            <div class="color-dot" style="background: var(--accent-orange);" data-color="orange"></div>
            <div class="color-dot" style="background: var(--accent-red);" data-color="red"></div>
          </div>
        </form>
      </div>

      <div class="task-list-wrapper" id="taskScroll">
        <div id="taskList"></div>

        <div id="emptyState" class="hidden" style="text-align:center; padding:40px 0; opacity:0.5;">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
            style="margin-bottom:16px;">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
          </svg>
          <p>All caught up!</p>
        </div>

        <div class="completed-section" id="completedSection">
          <div class="completed-header" onclick="toggleCompleted()">
            <span class="text-xs">COMPLETED HISTORY</span>
            <span id="completedArrow">▼</span>
          </div>
          <div id="completedList"></div>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <header class="top-bar">
        <div style="display:flex; align-items:center;">
          <button type="button" class="toggle-sidebar-btn" id="sidebarToggle">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
          </button>
          <div>
            <p class="text-xs" style="color:var(--text-tertiary); margin-bottom:4px;" id="currentDate">FRIDAY, OCTOBER
              24</p>
            <h1 class="text-h1" id="greeting">Good Morning</h1>
          </div>
        </div>

        <div style="display: flex; gap: 12px; align-items: center;">
          <!-- Theme Selector -->
          <div class="theme-selector-container">
            <button type="button" class="btn-ghost theme-selector-btn" id="themeSelectorBtn"
              style="padding: 10px; border-radius: 50%; width: 42px; height: 42px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path>
              </svg>
            </button>
            <div class="theme-dropdown" id="themeDropdown">
              <div class="theme-dropdown-header">Select Theme</div>
              <button class="theme-option" data-theme="cappuccino">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #FAFAFA 50%, #5B7C99 50%);"></div>
                <span>Cappuccino (Light)</span>
              </button>
              <button class="theme-option" data-theme="catppuccin">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #1e1e2e 50%, #89b4fa 50%);"></div>
                <span>Catppuccin (Dark)</span>
              </button>
              <button class="theme-option" data-theme="nord">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #2e3440 50%, #88c0d0 50%);"></div>
                <span>Nord</span>
              </button>
              <button class="theme-option" data-theme="dracula">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #282a36 50%, #8be9fd 50%);"></div>
                <span>Dracula</span>
              </button>
              <button class="theme-option" data-theme="gruvbox">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #282828 50%, #b8bb26 50%);"></div>
                <span>Gruvbox</span>
              </button>
              <button class="theme-option" data-theme="solarized-dark">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #002b36 50%, #268bd2 50%);"></div>
                <span>Solarized Dark</span>
              </button>
              <button class="theme-option" data-theme="solarized-light">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #fdf6e3 50%, #268bd2 50%);"></div>
                <span>Solarized Light</span>
              </button>
              <button class="theme-option" data-theme="monokai">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #272822 50%, #a6e22e 50%);"></div>
                <span>Monokai</span>
              </button>
              <button class="theme-option" data-theme="onedark">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #282c34 50%, #61afef 50%);"></div>
                <span>One Dark</span>
              </button>
              <button class="theme-option" data-theme="tokyonight">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #1a1b26 50%, #7aa2f7 50%);"></div>
                <span>Tokyo Night</span>
              </button>
              <div class="theme-divider"></div>
              <button class="theme-option" id="customThemeBtn">
                <div class="theme-color-preview" style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f7b731);"></div>
                <span>✨ Create Custom Theme</span>
              </button>
            </div>
          </div>
          <button type="button" class="auth-btn" id="loginBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
              <polyline points="10 17 15 12 10 7" />
              <line x1="15" y1="12" x2="3" y2="12" />
            </svg>
            Sign In
          </button>
        </div>
      </header>

      <section class="focus-hero" id="focusHero">
      </section>

      <div class="bento-grid">
        <div class="bento-card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span class="text-xs" style="color:var(--text-tertiary)">POMODORO TIMER</span>
            <button type="button" class="btn-icon-circle" onclick="toggleModal('timerModal')">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                  d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                </path>
              </svg>
            </button>
          </div>

          <div class="timer-presets" style="margin-top: 10px; display:flex; gap:8px; justify-content:center;">
            <button type="button" class="btn-ghost" onclick="setTimer(25)"
              style="font-size:0.8rem; padding:4px 10px; border:1px solid var(--border-color);">Focus 25</button>
            <button type="button" class="btn-ghost" onclick="setTimer(5)"
              style="font-size:0.8rem; padding:4px 10px; border:1px solid var(--border-color);">Short 5</button>
            <button type="button" class="btn-ghost" onclick="setTimer(15)"
              style="font-size:0.8rem; padding:4px 10px; border:1px solid var(--border-color);">Long 15</button>
          </div>

          <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div class="timer-display" id="timerDisplay">25:00</div>
            <div class="timer-controls">
              <button type="button" id="startTimerBtn" class="btn-primary">Start Focus</button>
              <button type="button" id="resetTimerBtn" class="btn-ghost">Reset</button>
            </div>
          </div>
        </div>

        <div class="bento-card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
            <span class="text-xs" style="color:var(--text-tertiary)">DAILY GOAL</span>
            <div style="display:flex; align-items:center; gap:8px;" role="status" aria-label="Streak indicator">
              <span class="text-xs" style="color:var(--text-tertiary)" aria-hidden="true">🔥</span>
              <span class="text-body" id="streakCount" style="font-weight:600; color:var(--accent-orange);">0</span>
              <span class="text-xs" style="color:var(--text-tertiary)">DAY STREAK</span>
            </div>
          </div>
          <div style="flex:1; display:flex; flex-direction:column; justify-content:center; gap:16px;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
              <div style="flex:1;">
                <div style="display:flex; align-items:baseline; gap:8px; margin-bottom:8px;">
                  <span class="text-h1" id="progressPercent">0%</span>
                  <span class="text-body" id="progressText">0/0 Tasks</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <span class="text-sm" style="color:var(--text-secondary);">Goal:</span>
                  <div id="dailyGoalDisplay" onclick="openDailyGoalModal()" role="button" tabindex="0" aria-label="Edit daily goal"
                    onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openDailyGoalModal();}"
                    style="padding:4px 12px; border-radius:6px; background:var(--bg-input); color:var(--text-primary); font-size:0.9rem; cursor:pointer; transition:all 0.2s; border:1px solid transparent;"
                    onmouseover="this.style.borderColor='var(--accent-blue)'; this.style.background='var(--accent-blue-soft)'"
                    onmouseout="this.style.borderColor='transparent'; this.style.background='var(--bg-input)'"
                    onfocus="this.style.borderColor='var(--accent-blue)'; this.style.background='var(--accent-blue-soft)'"
                    onblur="this.style.borderColor='transparent'; this.style.background='var(--bg-input)'">
                    <span id="dailyGoalValue">5</span> tasks/day
                  </div>
                </div>
              </div>
            </div>
            <div style="width:100%; height:10px; background:var(--bg-input); border-radius:10px; overflow:hidden; position:relative;">
              <div id="progressBar"
                style="width:0%; height:100%; background:linear-gradient(90deg, var(--accent-green), var(--accent-blue)); transition: width 0.8s var(--ease-spring); box-shadow: 0 0 10px rgba(6, 214, 160, 0.3);">
              </div>
            </div>
            <p class="text-sm" style="color:var(--text-secondary);" id="progressQuote">Set your daily goal and build your streak! 🚀</p>
          </div>
        </div>
      </div>

      <section>
        <div class="courses-header">
          <div>
            <h2 class="text-h2">Courses & Projects</h2>
            <p class="text-body">Manage lectures, labs, and deadlines.</p>
          </div>
          <button type="button" class="btn-new-course" onclick="addCourse()">+ New Course</button>
        </div>

        <div class="courses-grid" id="coursesContainer"></div>

        <div id="emptyCourses" class="hidden"
          style="text-align:center; padding: 60px; color:var(--text-tertiary); border:2px dashed var(--bg-input); border-radius:var(--radius-lg);">
          <p class="text-h3" style="margin-bottom:8px;">No courses yet</p>
          <p>Click "New Course" to start organizing your studies.</p>
        </div>
      </section>
    </main>
  </div>

  <div class="course-modal-overlay" id="courseModal">
    <div class="course-modal">
      <div class="course-modal-header">
        <input type="text" class="course-modal-title-input" id="modalCourseTitle" placeholder="Course Name">
        <button type="button" class="course-modal-close" onclick="closeCourseModal()">✕</button>
      </div>
      <div class="course-modal-body" id="courseModalBody">
      </div>
      <div class="course-modal-footer">
        <div class="course-colors" id="modalCourseColors">
        </div>
        <button type="button" class="btn-danger" id="modalDeleteBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="timerModal">
    <div class="modal">
      <h3 class="text-h3" style="margin-bottom:24px;">Timer Settings</h3>
      <div style="margin-bottom:20px;">
        <label class="text-xs" style="color:var(--text-secondary); display:block; margin-bottom:8px;">FOCUS DURATION
          (MIN)</label>
        <input type="number" id="customWorkDur" value="25"
          style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--bg-input); background:var(--bg-body); color:var(--text-primary); font-size:1.1rem;">
      </div>
      <div style="display:flex; justify-content:flex-end; gap:12px;">
        <button type="button" class="btn-ghost" onclick="toggleModal('timerModal')">Cancel</button>
        <button type="button" class="btn-primary" onclick="saveTimerSettings()">Save</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="dailyGoalModal">
    <div class="modal">
      <h3 class="text-h3" style="margin-bottom:24px;">Edit Daily Goal</h3>
      <div style="margin-bottom:20px;">
        <label class="text-xs" style="color:var(--text-secondary); display:block; margin-bottom:8px;">DAILY TASK GOAL</label>
        <input type="number" id="modalDailyGoalInput" min="1" max="50" value="5" aria-label="Daily task goal"
          style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--bg-input); background:var(--bg-body); color:var(--text-primary); font-size:1.1rem;">
        <p class="text-sm" style="color:var(--text-secondary); margin-top:8px;">Set how many tasks you want to complete each day</p>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:12px;">
        <button type="button" class="btn-ghost" onclick="toggleModal('dailyGoalModal')">Cancel</button>
        <button type="button" class="btn-primary" onclick="saveDailyGoal()">Save</button>
      </div>
    </div>
  </div>

  <!-- Custom Theme Creator Modal -->
  <div class="modal-overlay" id="customThemeModal">
    <div class="custom-theme-modal">
      <div class="custom-theme-header">
        <h3 class="custom-theme-title">Create Custom Theme</h3>
        <button type="button" class="course-modal-close" onclick="closeCustomThemeModal()">✕</button>
      </div>
      <div class="custom-theme-body">
        <div class="preview-box">
          <div class="preview-text preview-primary">Preview: Primary Text</div>
          <div class="preview-text preview-secondary">Preview: Secondary Text</div>
          <span class="preview-accent">Accent Preview</span>
        </div>
        
        <div class="color-picker-group">
          <label class="color-picker-label">Background Colors</label>
          <div class="color-picker-row">
            <input type="color" id="customBgBody" class="color-picker-input" value="#FAFAFA">
            <input type="text" id="customBgBodyHex" class="color-picker-hex" value="#FAFAFA" placeholder="Body Background">
          </div>
          <div class="color-picker-row">
            <input type="color" id="customBgCard" class="color-picker-input" value="#FFFFFF">
            <input type="text" id="customBgCardHex" class="color-picker-hex" value="#FFFFFF" placeholder="Card Background">
          </div>
          <div class="color-picker-row">
            <input type="color" id="customBgInput" class="color-picker-input" value="#F5F5F5">
            <input type="text" id="customBgInputHex" class="color-picker-hex" value="#F5F5F5" placeholder="Input Background">
          </div>
        </div>

        <div class="color-picker-group">
          <label class="color-picker-label">Text Colors</label>
          <div class="color-picker-row">
            <input type="color" id="customTextPrimary" class="color-picker-input" value="#111111">
            <input type="text" id="customTextPrimaryHex" class="color-picker-hex" value="#111111" placeholder="Primary Text">
          </div>
          <div class="color-picker-row">
            <input type="color" id="customTextSecondary" class="color-picker-input" value="#666666">
            <input type="text" id="customTextSecondaryHex" class="color-picker-hex" value="#666666" placeholder="Secondary Text">
          </div>
        </div>

        <div class="color-picker-group">
          <label class="color-picker-label">Accent Colors</label>
          <div class="color-picker-row">
            <input type="color" id="customAccentBlue" class="color-picker-input" value="#5B7C99">
            <input type="text" id="customAccentBlueHex" class="color-picker-hex" value="#5B7C99" placeholder="Blue Accent">
          </div>
          <div class="color-picker-row">
            <input type="color" id="customAccentGreen" class="color-picker-input" value="#7A9B7E">
            <input type="text" id="customAccentGreenHex" class="color-picker-hex" value="#7A9B7E" placeholder="Green Accent">
          </div>
          <div class="color-picker-row">
            <input type="color" id="customAccentOrange" class="color-picker-input" value="#B89968">
            <input type="text" id="customAccentOrangeHex" class="color-picker-hex" value="#B89968" placeholder="Orange Accent">
          </div>
          <div class="color-picker-row">
            <input type="color" id="customAccentRed" class="color-picker-input" value="#B87E7E">
            <input type="text" id="customAccentRedHex" class="color-picker-hex" value="#B87E7E" placeholder="Red Accent">
          </div>
        </div>
      </div>
      <div class="custom-theme-footer">
        <button type="button" class="btn-ghost" onclick="closeCustomThemeModal()">Cancel</button>
        <button type="button" class="btn-primary" id="applyCustomThemeBtn">Apply Theme</button>
      </div>
    </div>
  </div>

  <script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {getFirestore, doc, setDoc, onSnapshot} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCu6cbaEw4BzXvF8rGx94h6WHarEFH9Z-k",
      authDomain: "coursesprogress-5658f.firebaseapp.com",
      projectId: "coursesprogress-5658f",
      storageBucket: "coursesprogress-5658f.firebasestorage.app",
      messagingSenderId: "572695866101",
      appId: "1:572695866101:web:bb6dc8058387358b7773bc",
      measurementId: "G-XD8W9V1XPE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    /* STATE */
    let state = {
      user: null,
      todos: [],
      courses: [],
      focusId: null,
      timer: {isRunning: false, timeLeft: 1500, duration: 25},
      lastUndo: null,
      isLocalUpdate: false,
      currentCourseId: null,
      dailyGoal: 5,
      streak: 0,
      lastCompletionDate: null,
      todayCompletedCount: 0
    };

    const colors = {
      blue: 'var(--accent-blue)', purple: 'var(--accent-purple)', green: 'var(--accent-green)',
      orange: 'var(--accent-orange)', red: 'var(--accent-red)', gray: 'var(--text-tertiary)'
    };

    let activeColor = 'blue';
    let focusTarget = null;
    
    const MAX_DAILY_GOAL = 50;
    
    /* HELPER FUNCTIONS */
    function getTodayString() {
      return new Date().toDateString();
    }
    
    function getYesterdayString() {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      return yesterday.toDateString();
    }
    
    function getTodayCompletedCount() {
      const today = getTodayString();
      return state.todos.filter(t => {
        if (!t.completed || !t.completedAt) return false;
        const completedDate = new Date(t.completedAt).toDateString();
        return completedDate === today;
      }).length;
    }
    
    /* STREAK MANAGEMENT */
    function updateStreak() {
      const today = getTodayString();
      const todayCompleted = getTodayCompletedCount();
      
      // Check if daily goal is met
      if (todayCompleted >= state.dailyGoal) {
        const lastDate = state.lastCompletionDate ? new Date(state.lastCompletionDate).toDateString() : null;
        
        if (lastDate !== today) {
          // Check if this is a consecutive day
          if (lastDate) {
            const yesterdayStr = getYesterdayString();
            
            if (lastDate === yesterdayStr) {
              // Consecutive day - increment streak
              state.streak = (state.streak || 0) + 1;
            } else {
              // Streak broken - reset to 1
              state.streak = 1;
            }
          } else {
            // First time - start streak
            state.streak = 1;
          }
          
          state.lastCompletionDate = new Date().toISOString();
          
          if (state.streak > 1) {
            showToast(`🔥 ${state.streak} day streak! Keep it up!`);
          }
        }
      }
    }
    
    function checkStreakExpiration() {
      if (state.lastCompletionDate) {
        const lastDate = new Date(state.lastCompletionDate).toDateString();
        const today = getTodayString();
        const yesterdayStr = getYesterdayString();
        
        // If last completion was more than yesterday, reset streak
        if (lastDate !== today && lastDate !== yesterdayStr) {
          state.streak = 0;
        }
      }
    }

    /* HELPERS */
    const getEl = (id) => document.getElementById(id);
    const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2, '0');
      const s = (seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    /* CORE */
    function init() {
      setTimeout(() => getEl('loader').style.display = 'none', 800);
      const updateTime = () => {
        const now = new Date();
        getEl('currentDate').innerText = now.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric'}).toUpperCase();
        const hr = now.getHours();
        getEl('greeting').innerText = hr < 12 ? 'Good Morning' : hr < 18 ? 'Good Afternoon' : 'Good Evening';
      };
      updateTime(); setInterval(updateTime, 60000);
      
      // Check streak expiration
      checkStreakExpiration();
      
      setupEventListeners();
      new Sortable(getEl('taskList'), {
        animation: 150, ghostClass: 'sortable-ghost', delay: 100,
        onEnd: (evt) => reorderTasks(evt.oldIndex, evt.newIndex)
      });
      if (localStorage.getItem('theme')) {
        applyTheme(localStorage.getItem('theme'));
      } else {
        // Default to cappuccino (light) theme
        applyTheme('cappuccino');
      }
    }

    /* THEME SYSTEM */
    const themes = {
      'cappuccino': 'Cappuccino (Light)',
      'catppuccin': 'Catppuccin (Dark)', 
      'nord': 'Nord',
      'dracula': 'Dracula',
      'gruvbox': 'Gruvbox',
      'solarized-dark': 'Solarized Dark',
      'solarized-light': 'Solarized Light',
      'monokai': 'Monokai',
      'onedark': 'One Dark',
      'tokyonight': 'Tokyo Night'
    };

    function applyTheme(themeName) {
      // Remove all theme classes
      document.body.classList.remove('dark-mode');
      Object.keys(themes).forEach(theme => {
        document.body.classList.remove(`theme-${theme}`);
      });
      
      // Apply new theme and save to localStorage
      if (themeName === 'custom') {
        applyCustomTheme();
        localStorage.setItem('theme', 'custom');
      } else {
        document.body.classList.add(`theme-${themeName}`);
        localStorage.setItem('theme', themeName);
      }
      
      // Update active state in dropdown
      document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.remove('active');
        if (opt.dataset.theme === themeName) {
          opt.classList.add('active');
        }
      });
    }

    function applyCustomTheme() {
      const customTheme = localStorage.getItem('customTheme');
      if (!customTheme) return;
      
      const theme = JSON.parse(customTheme);
      const root = document.documentElement;
      
      // Apply custom CSS variables
      root.style.setProperty('--bg-body', theme.bgBody);
      root.style.setProperty('--bg-card', theme.bgCard);
      root.style.setProperty('--bg-input', theme.bgInput);
      root.style.setProperty('--bg-hover', adjustColorBrightness(theme.bgInput, 10));
      root.style.setProperty('--text-primary', theme.textPrimary);
      root.style.setProperty('--text-secondary', theme.textSecondary);
      root.style.setProperty('--text-tertiary', adjustColorBrightness(theme.textSecondary, -20));
      root.style.setProperty('--accent-blue', theme.accentBlue);
      root.style.setProperty('--accent-blue-soft', hexToRgba(theme.accentBlue, 0.15));
      root.style.setProperty('--accent-green', theme.accentGreen);
      root.style.setProperty('--accent-green-soft', hexToRgba(theme.accentGreen, 0.15));
      root.style.setProperty('--accent-orange', theme.accentOrange);
      root.style.setProperty('--accent-red', theme.accentRed);
      root.style.setProperty('--border-color', adjustColorBrightness(theme.bgInput, 5));
      root.style.setProperty('--bg-sidebar', theme.bgCard);
      root.style.setProperty('--bg-glass', hexToRgba(theme.bgBody, 0.85));
    }

    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function adjustColorBrightness(hex, percent) {
      const num = parseInt(hex.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const clamp = (val) => Math.max(0, Math.min(255, val));
      const R = clamp((num >> 16) + amt);
      const G = clamp((num >> 8 & 0x00FF) + amt);
      const B = clamp((num & 0x0000FF) + amt);
      return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
    }

    const toggleSidebar = () => {
      if (window.innerWidth > 900) {
        getEl('appLayout').classList.toggle('collapsed');
        const btn = getEl('sidebarToggle');
        btn.style.transform = getEl('appLayout').classList.contains('collapsed') ? "rotate(90deg)" : "rotate(0deg)";
      } else {
        getEl('sidebar').classList.toggle('open');
        getEl('sidebarOverlay').classList.toggle('active');
      }
    };

    function setupEventListeners() {
      getEl('sidebarToggle').onclick = toggleSidebar;
      getEl('sidebarClose').onclick = toggleSidebar;
      getEl('sidebarOverlay').onclick = toggleSidebar;

      // Theme selector dropdown
      const themeSelectorBtn = getEl('themeSelectorBtn');
      const themeDropdown = getEl('themeDropdown');
      
      themeSelectorBtn.onclick = (e) => {
        e.stopPropagation();
        themeDropdown.classList.toggle('active');
      };
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!themeSelectorBtn.contains(e.target) && !themeDropdown.contains(e.target)) {
          themeDropdown.classList.remove('active');
        }
      });
      
      // Theme selection
      document.querySelectorAll('.theme-option[data-theme]').forEach(option => {
        option.onclick = () => {
          const themeName = option.dataset.theme;
          applyTheme(themeName);
          themeDropdown.classList.remove('active');
        };
      });
      
      // Custom theme button
      getEl('customThemeBtn').onclick = () => {
        themeDropdown.classList.remove('active');
        openCustomThemeModal();
      };

      getEl('addTaskForm').onsubmit = (e) => {
        e.preventDefault();
        const text = getEl('taskInput').value.trim();
        const days = getEl('taskDays').value;
        if (text) addTask(text, days);
      };

      getEl('btnRandomTask').onclick = () => {
        const active = state.todos.filter(t => !t.completed);
        if (active.length === 0) {showToast("No tasks!"); return;}
        const randomTask = active[Math.floor(Math.random() * active.length)];
        setFocus(randomTask.id);
        setTimeout(() => {
          const items = document.querySelectorAll('.task-item');
          items.forEach(item => {
            if (item.innerHTML.includes(randomTask.text)) {
              item.scrollIntoView({behavior: 'smooth', block: 'center'});
              item.classList.add('highlight-task');
              setTimeout(() => item.classList.remove('highlight-task'), 1000);
            }
          });
        }, 100);
        showToast("Random task picked!");
      };

      document.querySelectorAll('.color-dot').forEach(dot => {
        dot.onclick = () => {
          document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
          dot.classList.add('active');
          activeColor = dot.dataset.color;
        };
      });

      getEl('startTimerBtn').onclick = toggleTimer;
      getEl('resetTimerBtn').onclick = resetTimer;

      getEl('toastUndo').onclick = () => {
        if (state.lastUndo) {
          if (state.lastUndo.type === 'task') state.todos.push(state.lastUndo.data);
          saveData(); renderTasks(); hideToast();
        }
      };
    }

    /* DATA LOGIC */
    onAuthStateChanged(auth, (user) => {
      state.user = user;
      if (user) {
        getEl('loginBtn').innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`;
        getEl('loginBtn').title = "Sign Out";
        getEl('loginBtn').onclick = () => signOut(auth);

        onSnapshot(doc(db, 'users', user.uid), (docSnap) => {
          if (docSnap.exists()) {
            if (state.isLocalUpdate) {state.isLocalUpdate = false; return;}
            const d = docSnap.data();
            state.todos = d.todos || [];
            state.courses = d.courses || [];
            state.focusId = d.focusId || null;
            state.dailyGoal = d.dailyGoal || 5;
            state.streak = d.streak || 0;
            state.lastCompletionDate = d.lastCompletionDate || null;
            getEl('dailyGoalValue').innerText = state.dailyGoal;
            checkStreakExpiration();
            renderAll();
          } else {
            state.todos = []; state.courses = []; state.focusId = null; 
            state.dailyGoal = 5; state.streak = 0; state.lastCompletionDate = null;
            getEl('dailyGoalValue').innerText = state.dailyGoal;
            renderAll();
          }
        });
      } else {
        getEl('loginBtn').innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg> Sign In`;
        getEl('loginBtn').onclick = () => signInWithPopup(auth, provider);
        renderAll();
      }
    });

    function saveData(shouldRender = true) {
      if (shouldRender) renderAll();
      if (state.user) {
        state.isLocalUpdate = true;
        setDoc(doc(db, 'users', state.user.uid), {
          todos: state.todos, 
          courses: state.courses, 
          focusId: state.focusId, 
          dailyGoal: state.dailyGoal,
          streak: state.streak,
          lastCompletionDate: state.lastCompletionDate,
          lastUpdated: new Date().toISOString()
        }, {merge: true}).catch(error => console.error("Cloud save failed:", error));
      }
    }

    /* RENDERING */
    function renderAll() {
      renderTasks(); renderFocus(); renderCourses(); renderStats();
      if (state.currentCourseId) window.openCourseModal(state.currentCourseId);
    }

    function renderTasks() {
      const list = getEl('taskList'); list.innerHTML = '';
      const active = state.todos.filter(t => !t.completed);
      if (active.length === 0) getEl('emptyState').classList.remove('hidden');
      else getEl('emptyState').classList.add('hidden');

      active.forEach(t => {
        const el = document.createElement('div');
        el.className = 'task-item animate-in';
        el.style.setProperty('--task-color', colors[t.color] || colors.blue);
        const daysLeft = t.days ? `<span style="background:var(--bg-input); padding:2px 6px; border-radius:4px;">${t.days}d left</span>` : '';

        el.innerHTML = `
                    <div class="checkbox"></div>
                    <div class="task-content">
                        <div class="task-text">${t.text}</div>
                        <div class="task-meta">${daysLeft}</div>
                    </div>
                    <button type="button" class="btn-delete-task">✕</button>
                `;
        el.onclick = (e) => {if (!e.target.closest('.checkbox') && !e.target.closest('button')) setFocus(t.id);};
        el.querySelector('.checkbox').onclick = (e) => {e.stopPropagation(); toggleTask(t.id);};
        el.querySelector('button').onclick = (e) => {e.stopPropagation(); deleteTask(t.id);};
        list.appendChild(el);
      });

      const compList = getEl('completedList'); compList.innerHTML = '';
      state.todos.filter(t => t.completed).forEach(t => {
        const div = document.createElement('div');
        div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.gap = '8px'; div.style.marginBottom = '8px';
        div.innerHTML = `<div class="checkbox checked" style="width:18px;height:18px;font-size:10px;">✓</div><div style="text-decoration:line-through; font-size:0.9rem;">${t.text}</div>`;
        div.querySelector('.checkbox').onclick = () => toggleTask(t.id);
        compList.appendChild(div);
      });
    }

    function renderFocus() {
      const hero = getEl('focusHero');
      const task = state.todos.find(t => t.id === state.focusId && !t.completed);
      if (!task) {
        hero.innerHTML = `
                    <div style="opacity:0.5;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    </div>
                    <h2 class="text-h2" style="margin-top:16px;">No Active Focus</h2>
                    <p class="text-body" style="margin-top:8px;">Select a task from the sidebar to begin.</p>
                `;
        return;
      }
      const color = colors[task.color] || colors.blue;
      const daysText = task.days ? ` • ${task.days} LEFT` : '';

      hero.innerHTML = `
    <div class="focus-progress-bar" style="background:${color}; width:100%;"></div>
    
    <div class="focus-label" style="color:${color};">CURRENT PRIORITY${daysText}</div>
    
    <h2 class="focus-title animate-in">${task.text}</h2>
    <div class="focus-subtitle">Stay strictly on this task until completion.</div>
    <button type="button" class="btn-primary" style="margin-top:32px; background:${color}; box-shadow:0 8px 20px -4px ${color}80;">
        Complete Task
    </button>
`;
      hero.querySelector('button').onclick = () => {
        confetti({particleCount: 100, spread: 70, origin: {y: 0.6}});
        toggleTask(task.id);
      };
    }

    function renderStats() {
      // Calculate today's completed tasks
      const todayCompleted = getTodayCompletedCount();
      
      state.todayCompletedCount = todayCompleted;
      const goal = state.dailyGoal || 5;
      const pct = Math.min(Math.round((todayCompleted / goal) * 100), 100);
      
      getEl('progressPercent').innerText = `${pct}%`;
      getEl('progressText').innerText = `${todayCompleted}/${goal}`;
      getEl('progressBar').style.width = `${pct}%`;
      getEl('streakCount').innerText = state.streak || 0;
      
      const quotes = [
        "Keep the momentum going! 💪",
        "One task at a time! ⭐",
        "You're making progress! 🎯",
        "Stay focused, stay strong! 🔥"
      ];
      
      if (pct >= 100) {
        getEl('progressQuote').innerText = "🎉 Daily goal achieved! Incredible work!";
      } else if (pct >= 75) {
        getEl('progressQuote').innerText = "Almost there! Keep pushing! 🚀";
      } else if (pct >= 50) {
        getEl('progressQuote').innerText = "You're halfway there! 💫";
      } else if (todayCompleted > 0) {
        getEl('progressQuote').innerText = "Great start! Keep going! ✨";
      } else {
        getEl('progressQuote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
      }
    }

    function renderCourses() {
      const container = getEl('coursesContainer'); container.innerHTML = '';
      if (state.courses.length === 0) getEl('emptyCourses').classList.remove('hidden');
      else getEl('emptyCourses').classList.add('hidden');

      state.courses.forEach(course => {
        const totalG = course.categories.reduce((acc, c) => acc + c.goals.length, 0);
        const doneG = course.categories.reduce((acc, c) => acc + c.goals.filter(g => g.completed).length, 0);
        const progress = totalG === 0 ? 0 : (doneG / totalG) * 100;
        const cColor = colors[course.color] || colors.blue;
        const card = document.createElement('div');
        card.className = 'course-card-compact';
        card.style.setProperty('--course-color', cColor);
        card.innerHTML = `
                    <div class="course-card-title">${course.name}</div>
                    <div class="course-card-stats"><span>${doneG}/${totalG} Goals</span><span>${Math.round(progress)}% Done</span></div>
                    <div class="course-card-progress"><div class="course-card-progress-fill" style="width:${progress}%; background:${cColor};"></div></div>
                `;
        card.onclick = () => window.openCourseModal(course.id);
        container.appendChild(card);
      });
    }

    /* COURSE MODAL */
    window.openCourseModal = (courseId) => {
      state.currentCourseId = courseId;
      const course = state.courses.find(c => c.id === courseId);
      if (!course) return;

      const modal = getEl('courseModal');
      const titleInput = getEl('modalCourseTitle');
      const body = getEl('courseModalBody');
      const colorsDiv = getEl('modalCourseColors');

      titleInput.value = course.name;
      titleInput.onblur = () => updateCourse(courseId, {name: titleInput.value}, false);

      body.innerHTML = '';
      course.categories.forEach(cat => {
        const section = document.createElement('div');
        section.className = 'category-section';
        section.style.setProperty('--course-color', colors[course.color]);

        section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">${cat.name}</div>
                        <div style="display:flex; gap:8px;">
                            <button type="button" class="btn-add-goal" data-action="add-goal">+ Goal</button>
                            <button type="button" class="btn-delete-task" style="width:24px; height:24px;" data-action="delete-cat">✕</button>
                        </div>
                    </div>
                    <div class="goals-container"></div>
                `;
        section.querySelector('[data-action="add-goal"]').onclick = () => addGoal(courseId, cat.id);
        section.querySelector('[data-action="delete-cat"]').onclick = () => {
          if (confirm("Are you sure you want to delete this category?")) deleteCategory(courseId, cat.id);
        };

        const goalsCont = section.querySelector('.goals-container');
        cat.goals.forEach(goal => {
          const gItem = document.createElement('div');
          gItem.className = 'goal-item';
          gItem.innerHTML = `
                        <div class="checkbox ${goal.completed ? 'checked' : ''}" style="margin-top:4px;">${goal.completed ? '✓' : ''}</div>
                        <div class="goal-inputs">
                            <input class="goal-main-input" value="${goal.title}" placeholder="New Goal...">
                            <input class="goal-sub-input" value="${goal.subtitle || ''}" placeholder="Add details...">
                        </div>
                        <div class="goal-actions">
                            <button type="button" class="btn-delete-task" title="Convert">➔</button>
                            <button type="button" class="btn-delete-task" style="color:var(--accent-red);" title="Delete">✕</button>
                        </div>
                    `;
          gItem.querySelector('.checkbox').onclick = () => toggleGoal(courseId, cat.id, goal.id);

          const mainIn = gItem.querySelector('.goal-main-input');
          mainIn.onblur = () => updateGoal(courseId, cat.id, goal.id, {title: mainIn.value}, false);
          mainIn.onkeydown = (e) => {
            if (e.key === 'Enter') {
              e.preventDefault(); e.target.blur();
              addGoal(courseId, cat.id); // Triggers re-render and focus on new input
            }
          };

          const subIn = gItem.querySelector('.goal-sub-input');
          subIn.onblur = () => updateGoal(courseId, cat.id, goal.id, {subtitle: subIn.value}, false);

          gItem.querySelector('[title="Convert"]').onclick = () => convertGoal(courseId, cat.id, goal.id);
          gItem.querySelector('[title="Delete"]').onclick = () => deleteGoal(courseId, cat.id, goal.id);
          goalsCont.appendChild(gItem);

          if (focusTarget && goal.id === focusTarget.id) {
            setTimeout(() => mainIn.focus(), 50);
            focusTarget = null;
          }
        });
        body.appendChild(section);
      });

      const addCatDiv = document.createElement('div');
      addCatDiv.style.textAlign = "center";
      addCatDiv.innerHTML = `<button type="button" class="btn-ghost" style="width:100%; border:1px dashed var(--border-color);">+ Add Category</button>`;
      addCatDiv.onclick = () => {const name = prompt("Category Name:"); if (name) addCategory(courseId, name);};
      body.appendChild(addCatDiv);

      colorsDiv.innerHTML = '';
      Object.keys(colors).forEach(k => {
        const dot = document.createElement('div');
        dot.className = `cc-dot ${course.color === k ? 'active' : ''}`;
        dot.style.background = colors[k];
        dot.onclick = () => setCourseColor(courseId, k);
        colorsDiv.appendChild(dot);
      });
      getEl('modalDeleteBtn').onclick = () => {if (confirm("Delete this course?")) {delCourse(courseId); window.closeCourseModal();} };
      modal.classList.add('active');
    };

    window.closeCourseModal = () => {getEl('courseModal').classList.remove('active'); state.currentCourseId = null;};

    /* ACTIONS */
    function addTask(text, days) {
      state.todos.push({id: generateId(), text, days, color: activeColor, completed: false, createdAt: new Date().toISOString()});
      getEl('taskInput').value = ''; getEl('taskDays').value = '';
      if (!state.focusId) state.focusId = state.todos[state.todos.length - 1].id;
      saveData();
    }
    function toggleTask(id) {
      const t = state.todos.find(x => x.id === id);
      if (t) {
        t.completed = !t.completed;
        if (t.completed) {
          t.completedAt = new Date().toISOString();
          confetti({particleCount: 50, spread: 60, origin: {y: 0.7}}); 
          if (state.focusId === id) state.focusId = null;
          
          // Update streak
          updateStreak();
        } else {
          t.completedAt = null;
        }
        
        // If this task is linked to a course goal, toggle that too
        if (t.linkedGoalId && t.linkedCourseId && t.linkedCategoryId) {
          const c = state.courses.find(x => x.id === t.linkedCourseId);
          if (c) {
            const cat = c.categories.find(x => x.id === t.linkedCategoryId);
            if (cat) {
              const g = cat.goals.find(x => x.id === t.linkedGoalId);
              if (g) {
                g.completed = t.completed;
              }
            }
          }
        }
        
        saveData();
      }
    }
    function deleteTask(id) {
      const idx = state.todos.findIndex(x => x.id === id);
      if (idx > -1) {
        state.lastUndo = {type: 'task', data: state.todos[idx]};
        state.todos.splice(idx, 1);
        if (state.focusId === id) state.focusId = null;
        showToast("Task deleted"); saveData();
      }
    }
    window.setFocus = (id) => {state.focusId = id; saveData(); if (window.innerWidth < 900) {getEl('sidebar').classList.remove('open'); getEl('sidebarOverlay').classList.remove('active');} };
    function reorderTasks(oldIdx, newIdx) {
      const active = state.todos.filter(t => !t.completed);
      const item = active.splice(oldIdx, 1)[0]; active.splice(newIdx, 0, item);
      state.todos = [...active, ...state.todos.filter(t => t.completed)];
      saveData();
    }
    window.addCourse = () => {
      const id = generateId();
      state.courses.push({id, name: 'New Course', color: 'blue', categories: [{id: generateId(), name: 'Lectures', goals: []}, {id: generateId(), name: 'Assignments', goals: []}]});
      saveData(); setTimeout(() => window.openCourseModal(id), 100);
    };
    function updateCourse(id, updates, shouldRender = true) {const c = state.courses.find(x => x.id === id); if (c) {Object.assign(c, updates); saveData(shouldRender);} }
    window.setCourseColor = (id, color) => updateCourse(id, {color});
    window.delCourse = (id) => {state.courses = state.courses.filter(x => x.id !== id); saveData();};
    function addCategory(cid, name) {const c = state.courses.find(x => x.id === cid); c.categories.push({id: generateId(), name, goals: []}); saveData();}
    function deleteCategory(cid, catId) {const c = state.courses.find(x => x.id === cid); c.categories = c.categories.filter(x => x.id !== catId); saveData();}

    function addGoal(cid, catId) {
      const c = state.courses.find(x => x.id === cid);
      const cat = c.categories.find(x => x.id === catId);
      const newId = generateId();
      cat.goals.push({id: newId, title: '', completed: false});
      focusTarget = {id: newId};
      saveData();
    }
    function updateGoal(cid, catId, gid, updates, shouldRender = true) {
      const c = state.courses.find(x => x.id === cid);
      const cat = c.categories.find(x => x.id === catId);
      const g = cat.goals.find(x => x.id === gid);
      if (g) {Object.assign(g, updates); saveData(shouldRender);}
    }
    function toggleGoal(cid, catId, gid) {
      const c = state.courses.find(x => x.id === cid);
      const cat = c.categories.find(x => x.id === catId);
      const g = cat.goals.find(x => x.id === gid);
      if (g) {
        g.completed = !g.completed; 
        if (g.completed) confetti({particleCount: 30, spread: 40, origin: {x: 0.5, y: 0.5}});
        
        // If this goal is linked to a task, toggle that too
        if (g.linkedTaskId) {
          const t = state.todos.find(x => x.id === g.linkedTaskId);
          if (t) {
            t.completed = g.completed;
            if (t.completed && state.focusId === t.id) state.focusId = null;
          }
        }
        
        saveData();
      }
    }
    function deleteGoal(cid, catId, gid) {
      const c = state.courses.find(x => x.id === cid);
      const cat = c.categories.find(x => x.id === catId);
      cat.goals = cat.goals.filter(x => x.id !== gid); saveData();
    }
    function convertGoal(cid, catId, gid) {
      const c = state.courses.find(x => x.id === cid);
      const cat = c.categories.find(x => x.id === catId);
      const g = cat.goals.find(x => x.id === gid);
      const taskId = generateId();
      // Use course color instead of activeColor and include category name in task text
      state.todos.push({id: taskId, text: `[${c.name} - ${cat.name}] ${g.title}`, days: 0, color: c.color, completed: g.completed, createdAt: new Date().toISOString(), linkedGoalId: gid, linkedCourseId: cid, linkedCategoryId: catId});
      g.linkedTaskId = taskId;
      showToast("Converted to Task"); saveData();
    }

    /* TIMER & UTILS */
    window.toggleModal = (id) => getEl(id).classList.toggle('active');
    window.toggleCompleted = () => {
      const list = getEl('completedList'); const arrow = getEl('completedArrow');
      if (list.style.display === 'none') {list.style.display = 'block'; arrow.innerText = '▲';}
      else {list.style.display = 'none'; arrow.innerText = '▼';}
    };
    window.setTimer = (min) => {state.timer.duration = min; resetTimer();}
    window.saveTimerSettings = () => {
      const d = parseInt(getEl('customWorkDur').value);
      if (d > 0) state.timer.duration = d;
      resetTimer(); window.toggleModal('timerModal');
    };
    window.openDailyGoalModal = () => {
      getEl('modalDailyGoalInput').value = state.dailyGoal;
      window.toggleModal('dailyGoalModal');
    };
    window.saveDailyGoal = () => {
      const value = parseInt(getEl('modalDailyGoalInput').value);
      if (value > 0 && value <= 50) {
        state.dailyGoal = value;
        getEl('dailyGoalValue').innerText = value;
        saveData();
        renderStats();
        window.toggleModal('dailyGoalModal');
      } else {
        alert('Please enter a valid goal between 1 and 50');
      }
    };

    /* CUSTOM THEME MODAL */
    window.openCustomThemeModal = () => {
      // Load current custom theme or defaults
      const customTheme = localStorage.getItem('customTheme');
      if (customTheme) {
        const theme = JSON.parse(customTheme);
        setColorPicker('customBgBody', theme.bgBody);
        setColorPicker('customBgCard', theme.bgCard);
        setColorPicker('customBgInput', theme.bgInput);
        setColorPicker('customTextPrimary', theme.textPrimary);
        setColorPicker('customTextSecondary', theme.textSecondary);
        setColorPicker('customAccentBlue', theme.accentBlue);
        setColorPicker('customAccentGreen', theme.accentGreen);
        setColorPicker('customAccentOrange', theme.accentOrange);
        setColorPicker('customAccentRed', theme.accentRed);
      } else {
        // Set defaults from current light theme
        setColorPicker('customBgBody', '#FAFAFA');
        setColorPicker('customBgCard', '#FFFFFF');
        setColorPicker('customBgInput', '#F5F5F5');
        setColorPicker('customTextPrimary', '#111111');
        setColorPicker('customTextSecondary', '#666666');
        setColorPicker('customAccentBlue', '#5B7C99');
        setColorPicker('customAccentGreen', '#7A9B7E');
        setColorPicker('customAccentOrange', '#B89968');
        setColorPicker('customAccentRed', '#B87E7E');
      }
      
      // Setup live preview
      setupColorPickerListeners();
      
      getEl('customThemeModal').classList.add('active');
    };
    
    window.closeCustomThemeModal = () => {
      getEl('customThemeModal').classList.remove('active');
      // Reapply current theme to reset any preview changes
      const currentTheme = localStorage.getItem('theme') || 'cappuccino';
      if (currentTheme !== 'custom') {
        applyTheme(currentTheme);
      }
    };
    
    function setColorPicker(id, color) {
      getEl(id).value = color;
      getEl(id + 'Hex').value = color;
    }
    
    function setupColorPickerListeners() {
      const colorFields = [
        'customBgBody', 'customBgCard', 'customBgInput',
        'customTextPrimary', 'customTextSecondary',
        'customAccentBlue', 'customAccentGreen', 'customAccentOrange', 'customAccentRed'
      ];
      
      const isValidHexColor = (value) => /^#[0-9A-F]{6}$/i.test(value);
      
      colorFields.forEach(fieldId => {
        const colorInput = getEl(fieldId);
        const hexInput = getEl(fieldId + 'Hex');
        
        // Update hex input when color picker changes
        colorInput.oninput = () => {
          hexInput.value = colorInput.value;
          previewCustomTheme();
        };
        
        // Update color picker when hex input changes
        hexInput.oninput = () => {
          if (isValidHexColor(hexInput.value)) {
            colorInput.value = hexInput.value;
            previewCustomTheme();
          }
        };
      });
      
      // Apply button
      getEl('applyCustomThemeBtn').onclick = () => {
        saveCustomTheme();
        getEl('customThemeModal').classList.remove('active');
      };
    }
    
    function previewCustomTheme() {
      const root = document.documentElement;
      const theme = {
        bgBody: getEl('customBgBody').value,
        bgCard: getEl('customBgCard').value,
        bgInput: getEl('customBgInput').value,
        textPrimary: getEl('customTextPrimary').value,
        textSecondary: getEl('customTextSecondary').value,
        accentBlue: getEl('customAccentBlue').value,
        accentGreen: getEl('customAccentGreen').value,
        accentOrange: getEl('customAccentOrange').value,
        accentRed: getEl('customAccentRed').value
      };
      
      // Apply preview
      root.style.setProperty('--bg-body', theme.bgBody);
      root.style.setProperty('--bg-card', theme.bgCard);
      root.style.setProperty('--bg-input', theme.bgInput);
      root.style.setProperty('--text-primary', theme.textPrimary);
      root.style.setProperty('--text-secondary', theme.textSecondary);
      root.style.setProperty('--accent-blue', theme.accentBlue);
      root.style.setProperty('--accent-green', theme.accentGreen);
      root.style.setProperty('--accent-orange', theme.accentOrange);
      root.style.setProperty('--accent-red', theme.accentRed);
    }
    
    function saveCustomTheme() {
      const theme = {
        bgBody: getEl('customBgBody').value,
        bgCard: getEl('customBgCard').value,
        bgInput: getEl('customBgInput').value,
        textPrimary: getEl('customTextPrimary').value,
        textSecondary: getEl('customTextSecondary').value,
        accentBlue: getEl('customAccentBlue').value,
        accentGreen: getEl('customAccentGreen').value,
        accentOrange: getEl('customAccentOrange').value,
        accentRed: getEl('customAccentRed').value
      };
      
      localStorage.setItem('customTheme', JSON.stringify(theme));
      applyCustomTheme();
      showToast('✨ Custom theme applied!');
    }

    let timerInterval;
    function toggleTimer() {
      const btn = getEl('startTimerBtn');
      if (state.timer.isRunning) {
        clearInterval(timerInterval); state.timer.isRunning = false; btn.innerText = "Resume"; btn.style.background = "var(--accent-green)";
      } else {
        if (state.timer.timeLeft === undefined) state.timer.timeLeft = state.timer.duration * 60;
        state.timer.isRunning = true; btn.innerText = "Pause"; btn.style.background = "var(--accent-orange)";
        timerInterval = setInterval(() => {
          if (state.timer.timeLeft > 0) {
            state.timer.timeLeft--; getEl('timerDisplay').innerText = formatTime(state.timer.timeLeft);
          } else {
            clearInterval(timerInterval); state.timer.isRunning = false;
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
            alert("Focus Session Complete!"); resetTimer();
          }
        }, 1000);
      }
    }
    function resetTimer() {
      clearInterval(timerInterval); state.timer.isRunning = false; state.timer.timeLeft = state.timer.duration * 60;
      getEl('timerDisplay').innerText = formatTime(state.timer.timeLeft);
      const btn = getEl('startTimerBtn'); btn.innerText = "Start Focus"; btn.style.background = "var(--text-primary)";
    }
    function showToast(msg) {getEl('toastMsg').innerText = msg; getEl('toast').classList.add('active'); setTimeout(hideToast, 4000);}
    function hideToast() {getEl('toast').classList.remove('active'); setTimeout(() => {state.lastUndo = null;}, 600);}

    init();
  </script>
</body>

</html>
