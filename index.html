<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <meta name="theme-color" content="#F5F5F7">
    <title>Study Spark | Ultimate Workspace</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <style>
        /* -------------------------------------------------------------------------- */
        /* VARIABLES                                                                  */
        /* -------------------------------------------------------------------------- */
        :root {
            /* Light Mode */
            --bg-body: #F5F5F7;
            --bg-sidebar: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-glass: rgba(255, 255, 255, 0.75);
            --bg-glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --bg-input: rgba(0, 0, 0, 0.04);
            --bg-hover: rgba(0, 0, 0, 0.03);
            
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --text-tertiary: #B0B0B5;
            
            --border-color: rgba(0,0,0,0.06);

            /* Accents */
            --accent-blue: #0071e3;
            --accent-blue-soft: rgba(0, 113, 227, 0.15);
            --accent-purple: #5e5ce6;
            --accent-green: #34c759;
            --accent-green-soft: rgba(52, 199, 89, 0.15);
            --accent-orange: #ff9f0a;
            --accent-red: #ff3b30;

            /* Shadows & Effects */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.12);
            --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.05);
            
            /* Dimensions */
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --sidebar-width: 400px;
            
            /* Animations */
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* -------------------------------------------------------------------------- */
        /* DARK MODE                                                                  */
        /* -------------------------------------------------------------------------- */
        body.dark-mode {
            --bg-body: #050505; 
            --bg-sidebar: #121212;
            --bg-card: #18181A;
            --bg-glass: rgba(20, 20, 20, 0.85);
            --bg-glass-border: 1px solid rgba(255, 255, 255, 0.15);
            
            --bg-input: #262626;
            --bg-hover: #333333;
            
            --text-primary: #FFFFFF;
            --text-secondary: #E5E5E5; 
            --text-tertiary: #A0A0A0; 
            
            --border-color: #333333;
            
            --accent-blue: #409CFF;
            --accent-blue-soft: rgba(64, 156, 255, 0.25);
            --accent-green: #30D158;
            --accent-green-soft: rgba(48, 209, 88, 0.25);
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.7);
        }

        /* -------------------------------------------------------------------------- */
        /* RESET & BASE                                                               */
        /* -------------------------------------------------------------------------- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            overflow: hidden; /* CRITICAL: Prevents body scroll */
        }

        button { font-family: inherit; cursor: pointer; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Typography */
        .text-h1 { font-size: 2.5rem; font-weight: 800; letter-spacing: -0.03em; line-height: 1.1; }
        .text-h2 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; }
        .text-h3 { font-size: 1.2rem; font-weight: 600; letter-spacing: -0.01em; }
        .text-body { font-size: 1rem; line-height: 1.5; color: var(--text-secondary); }
        .text-xs { font-size: 0.75rem; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; }

        /* Animations */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes expandHeight { from { max-height: 0; opacity: 0; } to { max-height: 600px; opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .animate-in { animation: fadeInUp 0.5s var(--ease-spring) forwards; }
        .animate-spin { animation: spin 1s linear infinite; }

        /* -------------------------------------------------------------------------- */
        /* LAYOUT (GRID)                                                              */
        /* -------------------------------------------------------------------------- */
        .app-layout {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            transition: grid-template-columns 0.4s var(--ease-spring);
        }
        .app-layout.collapsed { grid-template-columns: 0px 1fr; }

        /* -------------------------------------------------------------------------- */
        /* SIDEBAR                                                                    */
        /* -------------------------------------------------------------------------- */
        .sidebar {
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            height: 100%;
            display: flex; flex-direction: column;
            padding: 32px;
            z-index: 50; /* Base Z-Index */
            transition: transform 0.4s var(--ease-spring), opacity 0.3s;
            overflow: hidden;
        }

        .app-layout.collapsed .sidebar {
            transform: translateX(-50px);
            opacity: 0; pointer-events: none;
        }

        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }

        /* Random Task Button */
        .btn-random {
            background: var(--bg-input); color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 6px 12px; border-radius: 8px; font-size: 0.8rem;
            font-weight: 600; display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .btn-random:hover { background: var(--text-primary); color: var(--bg-body); border-color: var(--text-primary); }

        /* Task Input */
        .task-input-container {
            background: var(--bg-body); padding: 16px;
            border-radius: var(--radius-md); border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm); margin-bottom: 24px;
            transition: all 0.3s ease;
        }
        .task-input-container:focus-within {
            background: var(--bg-card); border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px var(--accent-blue-soft);
        }
        .task-main-input {
            width: 100%; border: none; background: transparent;
            font-size: 1rem; color: var(--text-primary); padding: 8px 0; margin-bottom: 12px;
        }
        .task-meta-row { display: flex; justify-content: space-between; align-items: center; }
        
        .days-input-wrapper {
            display: flex; align-items: center; gap: 8px; background: var(--bg-input);
            padding: 6px 12px; border-radius: var(--radius-sm);
        }
        .days-input { width: 40px; background: transparent; border: none; text-align: center; font-weight: 600; color: var(--text-primary); }

        .color-picker { display: flex; gap: 8px; margin-top: 12px; }
        .color-dot {
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent; transition: transform 0.2s;
        }
        .color-dot.active { transform: scale(1.25); border-color: var(--text-primary); }

        /* Task List */
        .task-list-wrapper { flex: 1; overflow-y: auto; padding-right: 4px; }
        
        .task-item {
            display: flex; align-items: center; gap: 12px;
            background: var(--bg-card); padding: 16px; margin-bottom: 12px;
            border-radius: var(--radius-md); border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm); position: relative; overflow: hidden;
            transition: all 0.2s ease; cursor: grab;
        }
        .task-item:hover { transform: translateX(4px); box-shadow: var(--shadow-md); border-color: var(--text-tertiary); }
        .task-item::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: var(--task-color, var(--accent-blue));
        }

        .checkbox {
            width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--text-tertiary);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0; color: white; transition: all 0.2s;
        }
        .checkbox.checked { background: var(--accent-green); border-color: var(--accent-green); }
        .task-content { flex: 1; min-width: 0; }
        .task-text { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .completed-section { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 16px; }
        .completed-header { display: flex; justify-content: space-between; cursor: pointer; color: var(--text-secondary); }

        /* -------------------------------------------------------------------------- */
        /* MAIN CONTENT (FIXED SCROLL LAYOUT)                                         */
        /* -------------------------------------------------------------------------- */
        .main-content {
            background: var(--bg-body);
            height: 100vh; /* Full Height */
            overflow: hidden; /* No Global Scroll */
            display: flex;
            flex-direction: column;
            padding: 48px 64px 0 64px; /* Bottom padding 0 to let list touch edge */
            position: relative;
        }

        /* Top Header */
        .top-bar {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 32px; flex-shrink: 0;
        }
        .toggle-sidebar-btn {
            background: var(--bg-sidebar); border: 1px solid var(--border-color);
            width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin-right: 20px; color: var(--text-primary);
        }
        .auth-btn {
            background: var(--text-primary); color: var(--bg-body);
            padding: 10px 24px; border-radius: 50px; font-weight: 600;
            border: none; display: flex; align-items: center; gap: 8px;
        }

        /* Hero & Bento (Static Content) */
        .dashboard-widgets {
            flex-shrink: 0; /* Do not shrink */
        }

        .focus-hero {
            background: var(--bg-glass); backdrop-filter: blur(40px);
            border: var(--bg-glass-border); border-radius: var(--radius-lg);
            padding: 32px; margin-bottom: 24px; box-shadow: var(--shadow-glass);
            display: flex; flex-direction: column; align-items: center;
            text-align: center; min-height: 200px;
        }
        .focus-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 8px; }

        .bento-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px; margin-bottom: 32px;
        }
        .bento-card {
            background: var(--bg-sidebar); border-radius: var(--radius-lg);
            padding: 24px; border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm); display: flex; flex-direction: column;
        }

        /* COURSES SECTION (THE SCROLLABLE PART) */
        .courses-section-wrapper {
            flex: 1; /* Takes all remaining height */
            min-height: 0; /* Allows flex child to shrink below content size */
            display: flex;
            flex-direction: column;
            padding-bottom: 24px;
        }

        .courses-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 16px; padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        /* SCROLLABLE CONTAINER */
        #coursesContainer {
            flex: 1; /* Grow to fill section */
            overflow-y: auto; /* Scroll internally */
            padding-right: 8px; /* Space for scrollbar */
            padding-bottom: 40px; /* Space at bottom */
        }

        .btn-new-course {
            background: transparent; border: 2px dashed var(--border-color);
            color: var(--text-secondary); padding: 8px 16px;
            border-radius: var(--radius-md); font-weight: 600;
        }
        .btn-new-course:hover { border-color: var(--accent-blue); color: var(--accent-blue); }

        /* Course Cards */
        .course-card {
            background: var(--bg-card); border-radius: var(--radius-md);
            margin-bottom: 16px; box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color); position: relative;
            overflow: hidden; flex-shrink: 0;
        }
        .course-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            background: var(--course-color, var(--accent-blue));
        }
        .course-header { padding: 16px 20px; display: flex; align-items: center; cursor: pointer; }
        .course-body { display: none; background: var(--bg-body); border-top: 1px solid var(--border-color); }
        .course-card.open .course-body { display: block; }
        
        .category-section { padding: 20px; border-bottom: 1px dashed var(--border-color); }
        .goal-item {
            display: flex; align-items: flex-start; gap: 12px; padding: 8px;
            border-radius: var(--radius-sm); position: relative;
        }
        .goal-item:hover { background: var(--bg-card); }
        .goal-actions { opacity: 0; position: absolute; right: 8px; top: 8px; }
        .goal-item:hover .goal-actions { opacity: 1; }

        /* -------------------------------------------------------------------------- */
        /* MODALS & UTILS                                                             */
        /* -------------------------------------------------------------------------- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);
            z-index: 1000; /* High Z-Index for overlay */
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal {
            background: var(--bg-card); width: 400px; padding: 32px;
            border-radius: var(--radius-lg); transform: scale(0.95);
            transition: transform 0.3s var(--ease-spring);
        }
        .modal-overlay.active .modal { transform: scale(1); }

        .btn-primary { background: var(--text-primary); color: var(--bg-body); padding: 12px 24px; border-radius: 12px; font-weight: 600; border: none; }
        .btn-ghost { background: transparent; color: var(--text-secondary); padding: 8px 16px; border-radius: 8px; font-weight: 500; border: none; }
        .hidden { display: none !important; }

        #toast {
            position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--text-primary); color: var(--bg-body);
            padding: 12px 24px; border-radius: 50px; z-index: 2000;
            display: flex; gap: 12px; transition: transform 0.4s var(--ease-spring);
        }
        #toast.active { transform: translateX(-50%) translateY(0); }

        /* -------------------------------------------------------------------------- */
        /* RESPONSIVE (MOBILE FIXES)                                                  */
        /* -------------------------------------------------------------------------- */
        @media (max-width: 900px) {
            .app-layout { grid-template-columns: 1fr; }
            
            /* Sidebar Mobile Fix */
            .sidebar { 
                position: fixed; 
                transform: translateX(-100%); 
                width: 85%; 
                max-width: 350px;
                z-index: 1001; /* Strictly above overlay (1000) */
                box-shadow: 20px 0 50px rgba(0,0,0,0.3);
            }
            .sidebar.open { transform: translateX(0); }
            
            .main-content { padding: 24px 24px 0 24px; }
            .toggle-sidebar-btn { display: flex !important; }

            /* Sidebar Overlay (Mobile Only) */
            .sidebar-overlay {
                position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
                z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            }
            .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
        }
    </style>
</head>
<body>

    <div id="loader" style="position:fixed; inset:0; background:var(--bg-body); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div class="animate-spin" style="width:50px; height:50px; border:4px solid var(--bg-input); border-top-color:var(--accent-blue); border-radius:50%;"></div>
    </div>

    <div id="toast">
        <span id="toastMsg">Action Completed</span>
        <button id="toastUndo" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem;">UNDO</button>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-layout" id="appLayout">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center; gap:12px;">
                    <h2 class="text-h2">Tasks</h2>
                    <button type="button" class="btn-random" id="btnRandomTask">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 8h.01"></path><path d="M8 8h.01"></path><path d="M8 16h.01"></path><path d="M16 16h.01"></path><path d="M12 12h.01"></path></svg>
                        Pick
                    </button>
                </div>
                <button class="btn-ghost" id="sidebarClose" style="display:none; color:var(--text-tertiary);">✕</button>
            </div>

            <div class="task-input-container">
                <form id="addTaskForm">
                    <input type="text" id="taskInput" class="task-main-input" placeholder="What needs focusing?" autocomplete="off">
                    <div class="task-meta-row">
                        <div class="days-input-wrapper">
                            <span class="text-xs" style="color:var(--text-tertiary)">DUE</span>
                            <input type="number" id="taskDays" class="days-input" placeholder="0">
                            <span class="text-xs" style="color:var(--text-tertiary)">D</span>
                        </div>
                        <button type="submit" class="btn-primary" style="padding: 6px 14px; font-size:0.85rem;">Add</button>
                    </div>
                    <div class="color-picker">
                        <div class="color-dot active" style="background: var(--accent-blue);" data-color="blue"></div>
                        <div class="color-dot" style="background: var(--accent-purple);" data-color="purple"></div>
                        <div class="color-dot" style="background: var(--accent-green);" data-color="green"></div>
                        <div class="color-dot" style="background: var(--accent-orange);" data-color="orange"></div>
                        <div class="color-dot" style="background: var(--accent-red);" data-color="red"></div>
                    </div>
                </form>
            </div>

            <div class="task-list-wrapper" id="taskScroll">
                <div id="taskList"></div>
                <div id="emptyState" class="hidden" style="text-align:center; padding:40px 0; opacity:0.5;">
                    <p>All caught up!</p>
                </div>
                <div class="completed-section">
                    <div class="completed-header" onclick="toggleCompleted()">
                        <span class="text-xs">HISTORY</span>
                        <span id="completedArrow">▼</span>
                    </div>
                    <div id="completedList" style="display:none; margin-top:12px;"></div>
                </div>
            </div>

            <div style="margin-top:auto; padding-top:20px; border-top:1px solid var(--border-color); display:flex; justify-content:center;">
                <button type="button" class="btn-ghost" id="themeToggle">◐ Switch Theme</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div style="display:flex; align-items:center;">
                    <button type="button" class="toggle-sidebar-btn" id="sidebarToggle">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <div>
                        <p class="text-xs" style="color:var(--text-tertiary); margin-bottom:4px;" id="currentDate">DATE</p>
                        <h1 class="text-h1" id="greeting">Hello</h1>
                    </div>
                </div>
                <button type="button" class="auth-btn" id="loginBtn">Sign In</button>
            </header>

            <div class="dashboard-widgets">
                <section class="focus-hero" id="focusHero"></section>
                <div class="bento-grid">
                    <div class="bento-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="text-xs" style="color:var(--text-tertiary)">TIMER</span>
                            <button type="button" class="btn-ghost" style="padding:4px;" onclick="toggleModal('timerModal')">⚙️</button>
                        </div>
                        <div style="text-align:center; margin:16px 0;">
                            <div style="font-size:3.5rem; font-weight:800; font-variant-numeric:tabular-nums;" id="timerDisplay">25:00</div>
                            <div style="display:flex; gap:12px; justify-content:center;">
                                <button type="button" id="startTimerBtn" class="btn-primary">Start</button>
                                <button type="button" id="resetTimerBtn" class="btn-ghost">Reset</button>
                            </div>
                        </div>
                    </div>
                    <div class="bento-card">
                        <span class="text-xs" style="color:var(--text-tertiary)">PROGRESS</span>
                        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; gap:16px;">
                            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                                <span class="text-h1" id="progressPercent">0%</span>
                                <span class="text-body" id="progressText">0/0 Tasks</span>
                            </div>
                            <div style="width:100%; height:8px; background:var(--bg-input); border-radius:10px; overflow:hidden;">
                                <div id="progressBar" style="width:0%; height:100%; background:var(--accent-green); transition: width 0.8s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <section class="courses-section-wrapper">
                <div class="courses-header">
                    <div>
                        <h2 class="text-h2">Courses</h2>
                        <p class="text-body">Your academic tracker.</p>
                    </div>
                    <button type="button" class="btn-new-course" onclick="addCourse()">+ New</button>
                </div>

                <div id="coursesContainer"></div>
                
                <div id="emptyCourses" class="hidden" style="text-align:center; padding: 60px; color:var(--text-tertiary); border:2px dashed var(--bg-input); border-radius:var(--radius-lg);">
                    <p>No courses yet. Add one to start.</p>
                </div>
            </section>
        </main>
    </div>

    <div class="modal-overlay" id="timerModal">
        <div class="modal">
            <h3 class="text-h3" style="margin-bottom:24px;">Timer Settings</h3>
            <div style="margin-bottom:20px;">
                <label class="text-xs" style="color:var(--text-secondary); display:block; margin-bottom:8px;">DURATION (MIN)</label>
                <input type="number" id="customWorkDur" value="25" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--bg-input); background:var(--bg-body); color:var(--text-primary); font-size:1.1rem;">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:12px;">
                <button type="button" class="btn-ghost" onclick="toggleModal('timerModal')">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveTimerSettings()">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCu6cbaEw4BzXvF8rGx94h6WHarEFH9Z-k",
          authDomain: "coursesprogress-5658f.firebaseapp.com",
          projectId: "coursesprogress-5658f",
          storageBucket: "coursesprogress-5658f.firebasestorage.app",
          messagingSenderId: "572695866101",
          appId: "1:572695866101:web:bb6dc8058387358b7773bc",
          measurementId: "G-XD8W9V1XPE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let state = {
            user: null, todos: [], courses: [], focusId: null,
            timer: { isRunning: false, timeLeft: 1500, duration: 25 },
            lastUndo: null, isLocalUpdate: false
        };

        const colors = {
            blue: '#0071e3', purple: '#5e5ce6', green: '#34c759',
            orange: '#ff9f0a', red: '#ff3b30', gray: '#8e8e93'
        };

        let activeColor = 'blue';
        let focusTarget = null;
        const getEl = (id) => document.getElementById(id);
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function init() {
            setTimeout(() => getEl('loader').style.display = 'none', 500);
            
            // Date
            const updateTime = () => {
                const now = new Date();
                getEl('currentDate').innerText = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }).toUpperCase();
                const hr = now.getHours();
                getEl('greeting').innerText = hr < 12 ? 'Good Morning' : hr < 18 ? 'Good Afternoon' : 'Good Evening';
            };
            updateTime();

            // Mobile Sidebar Logic
            const toggleSidebar = () => {
                const sidebar = getEl('sidebar');
                const overlay = getEl('sidebarOverlay');
                const layout = getEl('appLayout');
                const closeBtn = getEl('sidebarClose');

                // Check if mobile (width check)
                if (window.innerWidth <= 900) {
                    sidebar.classList.toggle('open');
                    overlay.classList.toggle('active');
                    // Toggle Close Button visibility
                    if(sidebar.classList.contains('open')) closeBtn.style.display = 'block';
                    else closeBtn.style.display = 'none';
                } else {
                    // Desktop toggle
                    layout.classList.toggle('collapsed');
                }
            };

            getEl('sidebarToggle').onclick = toggleSidebar;
            getEl('sidebarClose').onclick = toggleSidebar;
            getEl('sidebarOverlay').onclick = toggleSidebar;

            getEl('themeToggle').onclick = () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            };
            if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

            getEl('addTaskForm').onsubmit = (e) => {
                e.preventDefault();
                const text = getEl('taskInput').value.trim();
                const days = parseInt(getEl('taskDays').value) || 0;
                if(text) addTask(text, days);
            };

            getEl('btnRandomTask').onclick = () => {
                const active = state.todos.filter(t => !t.completed);
                if(active.length === 0) return showToast("No tasks!");
                const randomTask = active[Math.floor(Math.random() * active.length)];
                setFocus(randomTask.id);
                showToast("Random task picked!");
            };

            document.querySelectorAll('.color-dot').forEach(dot => {
                dot.onclick = () => {
                    document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                    dot.classList.add('active');
                    activeColor = dot.dataset.color;
                };
            });

            getEl('startTimerBtn').onclick = toggleTimer;
            getEl('resetTimerBtn').onclick = resetTimer;
            getEl('toastUndo').onclick = () => {
                if(state.lastUndo && state.lastUndo.type === 'task') {
                    state.todos.push(state.lastUndo.data);
                    saveData(); renderTasks(); hideToast();
                }
            };

            new Sortable(getEl('taskList'), { animation: 150, onEnd: (evt) => reorderTasks(evt.oldIndex, evt.newIndex) });
        }

        /* FIREBASE & STATE */
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                getEl('loginBtn').innerHTML = `<img src="${user.photoURL}" style="width:20px; height:20px; border-radius:50%; margin-right:8px;"> Sign Out`;
                getEl('loginBtn').onclick = () => signOut(auth);
                onSnapshot(doc(db, 'users', user.uid), (docSnap) => {
                    if (docSnap.exists() && !state.isLocalUpdate) {
                        const d = docSnap.data();
                        state.todos = d.todos || [];
                        state.courses = d.courses || [];
                        state.focusId = d.focusId || null;
                        renderAll();
                    } else if (!docSnap.exists()) {
                        renderAll();
                    }
                    state.isLocalUpdate = false;
                });
            } else {
                getEl('loginBtn').innerHTML = 'Sign In';
                getEl('loginBtn').onclick = () => signInWithPopup(auth, provider);
                renderAll();
            }
        });

        function saveData(shouldRender = true) {
            if (shouldRender) renderAll();
            if (state.user) {
                state.isLocalUpdate = true;
                setDoc(doc(db, 'users', state.user.uid), {
                    todos: state.todos, courses: state.courses, focusId: state.focusId, lastUpdated: new Date().toISOString()
                }, { merge: true });
            }
        }

        /* RENDERERS */
        function renderAll() { renderTasks(); renderFocus(); renderCourses(); renderStats(); }

        function renderTasks() {
            const list = getEl('taskList'); list.innerHTML = '';
            const active = state.todos.filter(t => !t.completed);
            getEl('emptyState').classList.toggle('hidden', active.length > 0);

            active.forEach(t => {
                const el = document.createElement('div');
                el.className = 'task-item animate-in';
                el.style.setProperty('--task-color', colors[t.color] || colors.blue);
                el.innerHTML = `
                    <div class="checkbox"></div>
                    <div class="task-content">
                        <div class="task-text">${t.text}</div>
                        <div class="task-meta" style="font-size:0.75rem; color:var(--text-tertiary);">${t.days ? t.days + 'd left' : ''}</div>
                    </div>
                    <button type="button" class="btn-ghost" style="padding:4px;">✕</button>
                `;
                el.onclick = (e) => { if(!e.target.closest('.checkbox') && !e.target.closest('button')) setFocus(t.id); };
                el.querySelector('.checkbox').onclick = (e) => { e.stopPropagation(); toggleTask(t.id); };
                el.querySelector('button').onclick = (e) => { e.stopPropagation(); deleteTask(t.id); };
                list.appendChild(el);
            });

            const compList = getEl('completedList'); compList.innerHTML = '';
            state.todos.filter(t => t.completed).forEach(t => {
                const div = document.createElement('div');
                div.style.cssText = 'display:flex; align-items:center; gap:8px; margin-bottom:8px; opacity:0.6;';
                div.innerHTML = `<div class="checkbox checked" style="width:16px;height:16px;font-size:10px;">✓</div><div style="text-decoration:line-through; font-size:0.9rem;">${t.text}</div>`;
                div.querySelector('.checkbox').onclick = () => toggleTask(t.id);
                compList.appendChild(div);
            });
        }

        function renderFocus() {
            const hero = getEl('focusHero');
            const task = state.todos.find(t => t.id === state.focusId && !t.completed);
            if(!task) {
                hero.innerHTML = `<div style="opacity:0.5;">Target</div><h2 class="text-h2" style="margin-top:8px;">No Active Focus</h2>`;
                return;
            }
            const color = colors[task.color] || colors.blue;
            hero.innerHTML = `
                <div style="color:${color}; font-weight:700; font-size:0.8rem; letter-spacing:0.1em; margin-bottom:12px;">PRIORITY</div>
                <h2 class="focus-title animate-in">${task.text}</h2>
                <button type="button" class="btn-primary" style="margin-top:24px; background:${color}; box-shadow:0 8px 20px -4px ${color}80;">Complete</button>
            `;
            hero.querySelector('button').onclick = () => { confetti(); toggleTask(task.id); };
        }

        function renderStats() {
            const total = state.todos.length, done = state.todos.filter(t => t.completed).length;
            const pct = total === 0 ? 0 : Math.round((done/total)*100);
            getEl('progressPercent').innerText = `${pct}%`;
            getEl('progressText').innerText = `${done}/${total} Tasks`;
            getEl('progressBar').style.width = `${pct}%`;
        }

        function renderCourses() {
            const container = getEl('coursesContainer'); container.innerHTML = '';
            getEl('emptyCourses').classList.toggle('hidden', state.courses.length > 0);

            state.courses.forEach(course => {
                const cColor = colors[course.color] || colors.blue;
                const card = document.createElement('div');
                card.className = `course-card ${course.isOpen ? 'open' : ''}`;
                card.style.setProperty('--course-color', cColor);

                const header = document.createElement('div');
                header.className = 'course-header';
                header.innerHTML = `
                    <div style="flex:1;">
                        <input value="${course.name}" style="font-size:1.1rem; font-weight:700; border:none; background:transparent; width:100%; color:var(--text-primary);" placeholder="Course Name">
                    </div>
                    <div style="transform:${course.isOpen ? 'rotate(180deg)' : 'rotate(0)'}; transition:transform 0.3s;">▼</div>
                `;
                
                // Event Bindings
                const input = header.querySelector('input');
                input.onblur = () => updateCourse(course.id, { name: input.value }, false);
                input.onclick = (e) => e.stopPropagation();
                header.onclick = (e) => { if(e.target !== input) updateCourse(course.id, { isOpen: !course.isOpen }); };

                const body = document.createElement('div');
                body.className = 'course-body';
                
                // Categories
                course.categories.forEach(cat => {
                    const sec = document.createElement('div');
                    sec.className = 'category-section';
                    sec.innerHTML = `
                        <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                            <div style="font-weight:800; font-size:0.8rem; text-transform:uppercase; color:var(--text-tertiary);">${cat.name}</div>
                            <button class="btn-ghost" style="padding:0; font-size:1.2rem; line-height:1;">+</button>
                        </div>
                        <div class="goals-container"></div>
                    `;
                    sec.querySelector('button').onclick = () => addGoal(course.id, cat.id);
                    
                    const gCont = sec.querySelector('.goals-container');
                    cat.goals.forEach(goal => {
                        const gItem = document.createElement('div');
                        gItem.className = 'goal-item';
                        gItem.innerHTML = `
                            <div class="checkbox ${goal.completed ? 'checked' : ''}">${goal.completed ? '✓' : ''}</div>
                            <input value="${goal.title}" style="flex:1; border:none; background:transparent; font-weight:500;" placeholder="Goal...">
                            <div class="goal-actions">
                                <button class="btn-ghost" style="padding:0; color:var(--accent-red);">✕</button>
                            </div>
                        `;
                        gItem.querySelector('.checkbox').onclick = () => toggleGoal(course.id, cat.id, goal.id);
                        const gInput = gItem.querySelector('input');
                        gInput.onblur = () => updateGoal(course.id, cat.id, goal.id, { title: gInput.value }, false);
                        if(focusTarget && focusTarget.id === goal.id) setTimeout(() => gInput.focus(), 50);
                        gItem.querySelector('button').onclick = () => deleteGoal(course.id, cat.id, goal.id);
                        gCont.appendChild(gItem);
                    });
                    body.appendChild(sec);
                });

                // Footer (Add Category / Color)
                const footer = document.createElement('div');
                footer.style.padding = "16px";
                footer.innerHTML = `
                    <button class="btn-ghost" style="width:100%; border:1px dashed var(--border-color); margin-bottom:12px;">+ Add Category</button>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; gap:6px;">${Object.keys(colors).map(k => `<div class="color-dot ${course.color===k?'active':''}" style="width:16px;height:16px;background:${colors[k]};border-radius:4px;" onclick="window.setCourseColor('${course.id}','${k}')"></div>`).join('')}</div>
                        <button class="btn-ghost" style="color:var(--accent-red); font-size:0.8rem;" onclick="window.delCourse('${course.id}')">Delete</button>
                    </div>
                `;
                footer.querySelector('button').onclick = () => {
                    const n = prompt("Category Name:"); if(n) addCategory(course.id, n);
                };

                body.appendChild(footer);
                card.appendChild(header);
                card.appendChild(body);
                container.appendChild(card);
            });
            focusTarget = null;
        }

        /* ACTIONS */
        function addTask(text, days) {
            state.todos.push({ id: generateId(), text, days, color: activeColor, completed: false });
            getEl('taskInput').value = ''; getEl('taskDays').value = '';
            if(!state.focusId) state.focusId = state.todos[state.todos.length-1].id;
            saveData();
        }
        function toggleTask(id) {
            const t = state.todos.find(x => x.id === id);
            if(t) { t.completed = !t.completed; if(t.completed) { confetti(); if(state.focusId===id) state.focusId=null; } saveData(); }
        }
        function deleteTask(id) {
            const idx = state.todos.findIndex(x => x.id === id);
            if(idx > -1) { state.lastUndo = { type: 'task', data: state.todos[idx] }; state.todos.splice(idx, 1); if(state.focusId===id) state.focusId=null; showToast("Task deleted"); saveData(); }
        }
        window.setFocus = (id) => { state.focusId = id; saveData(); if(window.innerWidth < 900) getEl('sidebar').classList.remove('open'); };
        function reorderTasks(o, n) {
            const a = state.todos.filter(t => !t.completed); const i = a.splice(o, 1)[0]; a.splice(n, 0, i);
            state.todos = [...a, ...state.todos.filter(t => t.completed)]; saveData();
        }

        window.addCourse = () => { state.courses.push({ id: generateId(), name: 'New Course', color: 'blue', isOpen: true, categories: [{id: generateId(), name: 'Lectures', goals:[]}] }); saveData(); };
        function updateCourse(id, u, r=true) { const c = state.courses.find(x => x.id === id); if(c) { Object.assign(c, u); saveData(r); } }
        window.setCourseColor = (id, c) => updateCourse(id, { color: c });
        window.delCourse = (id) => { if(confirm("Delete course?")) { state.courses = state.courses.filter(x => x.id !== id); saveData(); } };
        
        function addCategory(cid, name) { state.courses.find(x=>x.id===cid).categories.push({id:generateId(), name, goals:[]}); saveData(); }
        function addGoal(cid, catId) { 
            const cat = state.courses.find(x=>x.id===cid).categories.find(x=>x.id===catId);
            const nid = generateId(); cat.goals.push({id:nid, title:'', completed:false}); focusTarget={id:nid}; saveData();
        }
        function toggleGoal(cid, catId, gid) { const g = state.courses.find(x=>x.id===cid).categories.find(x=>x.id===catId).goals.find(x=>x.id===gid); g.completed = !g.completed; if(g.completed) confetti(); saveData(); }
        function updateGoal(cid, catId, gid, u, r=true) { const g = state.courses.find(x=>x.id===cid).categories.find(x=>x.id===catId).goals.find(x=>x.id===gid); Object.assign(g, u); saveData(r); }
        function deleteGoal(cid, catId, gid) { const c = state.courses.find(x=>x.id===cid).categories.find(x=>x.id===catId); c.goals = c.goals.filter(x=>x.id!==gid); saveData(); }

        /* TIMER */
        window.toggleModal = (id) => getEl(id).classList.toggle('active');
        window.toggleCompleted = () => { const l = getEl('completedList'); l.style.display = l.style.display==='none'?'block':'none'; getEl('completedArrow').innerText = l.style.display==='none'?'▼':'▲'; };
        window.saveTimerSettings = () => { state.timer.duration = parseInt(getEl('customWorkDur').value) || 25; resetTimer(); window.toggleModal('timerModal'); };
        let tInt;
        function toggleTimer() {
            const btn = getEl('startTimerBtn');
            if(state.timer.isRunning) { clearInterval(tInt); state.timer.isRunning=false; btn.innerText="Resume"; } 
            else {
                state.timer.isRunning=true; btn.innerText="Pause";
                tInt = setInterval(() => {
                    if(state.timer.timeLeft>0) { state.timer.timeLeft--; getEl('timerDisplay').innerText=formatTime(state.timer.timeLeft); }
                    else { clearInterval(tInt); state.timer.isRunning=false; alert("Focus Complete!"); resetTimer(); }
                }, 1000);
            }
        }
        function resetTimer() { clearInterval(tInt); state.timer.isRunning=false; state.timer.timeLeft=state.timer.duration*60; getEl('timerDisplay').innerText=formatTime(state.timer.timeLeft); getEl('startTimerBtn').innerText="Start"; }
        function showToast(msg) { getEl('toastMsg').innerText=msg; getEl('toast').classList.add('active'); setTimeout(hideToast, 3000); }
        function hideToast() { getEl('toast').classList.remove('active'); setTimeout(()=>state.lastUndo=null, 500); }

        init();
    </script>
</body>
</html>
