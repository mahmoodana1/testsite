<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <title>Study Spark | Workspace</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* =========================================
           CSS VARIABLES (Apple System Colors)
           ========================================= */
        :root {
            --bg-body: #F5F5F7;
            --bg-sidebar: #FFFFFF;
            
            /* Glassmorphism */
            --glass-material: rgba(255, 255, 255, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
            --blur-strength: 30px;

            /* Text */
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --text-tertiary: #C7C7CC;

            /* Accents */
            --blue: #0071e3;
            --purple: #5e5ce6;
            --green: #34c759;
            --orange: #ff9f0a;
            --red: #ff3b30;

            /* Dimensions */
            --radius-md: 14px;
            --radius-lg: 24px;
        }

        body.dark-mode {
            --bg-body: #000000;
            --bg-sidebar: #1C1C1E;
            --glass-material: rgba(28, 28, 30, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-primary: #F5F5F7;
            --text-secondary: #98989D;
            --text-tertiary: #48484A;
        }

        /* =========================================
           RESET & BASE
           ========================================= */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-body); color: var(--text-primary);
            transition: background 0.3s ease, color 0.2s ease;
            min-height: 100vh; overflow-x: hidden;
        }

        /* =========================================
           LAYOUT
           ========================================= */
        .app-layout {
            display: grid;
            grid-template-columns: 1fr;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Desktop: Sidebar + Content */
        @media (min-width: 900px) {
            .app-layout { grid-template-columns: 380px 1fr; }
        }

        /* =========================================
           SIDEBAR (Tasks)
           ========================================= */
        .sidebar {
            background: var(--bg-sidebar);
            border-right: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
            padding: 32px 24px; height: 100%; z-index: 100;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .dark-mode .sidebar { border-right: 1px solid rgba(255,255,255,0.08); }

        /* Mobile Drawer */
        @media (max-width: 899px) {
            .sidebar {
                position: fixed; top: 0; left: 0; bottom: 0; width: 85%; max-width: 360px;
                transform: translateX(-100%); box-shadow: 20px 0 50px rgba(0,0,0,0.2);
            }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay {
                position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
                z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            }
            .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
        }

        /* --- Collapsible Sections --- */
        .task-section-header {
            display: flex; align-items: center; justify-content: space-between;
            font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-secondary); margin-top: 24px; margin-bottom: 12px;
            cursor: pointer; user-select: none;
        }
        .task-section-header:hover { color: var(--text-primary); }
        .rotate-icon { transition: transform 0.2s; }
        .collapsed .rotate-icon { transform: rotate(-90deg); }
        .collapsed + .task-list-group { display: none; }

        /* =========================================
           MAIN DASHBOARD
           ========================================= */
        .main-content {
            padding: 24px; overflow-y: auto; height: 100vh; position: relative;
            padding-bottom: 120px;
        }
        @media (min-width: 900px) { .main-content { padding: 48px; } }

        /* Glass Container */
        .glass-box {
            background: var(--glass-material);
            backdrop-filter: blur(var(--blur-strength));
            -webkit-backdrop-filter: blur(var(--blur-strength));
            border: var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--glass-shadow);
            padding: 24px; margin-bottom: 24px;
            transition: transform 0.2s;
        }

        /* =========================================
           COMPONENTS
           ========================================= */
        /* Typography */
        h1 { font-size: 2rem; font-weight: 700; margin: 0; }
        h2 { font-size: 1.25rem; font-weight: 600; margin: 0; }
        
        /* Inputs (The "No Popup" Solution) */
        .input-inline {
            width: 100%; padding: 10px 14px;
            background: rgba(125,125,125,0.08);
            border: 1px solid transparent; border-radius: 10px;
            font-family: inherit; font-size: 0.95rem; color: var(--text-primary);
            transition: all 0.2s;
        }
        .input-inline:focus {
            background: var(--bg-sidebar); border-color: var(--blue);
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
        }
        
        /* Hidden Input Rows */
        .input-row { 
            display: none; padding: 10px 0; animation: slideDown 0.2s ease;
        }
        .input-row.visible { display: block; }

        /* Buttons */
        .btn {
            border: none; padding: 8px 16px; border-radius: 10px;
            font-size: 0.9rem; font-weight: 600; cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--text-primary); color: var(--bg-body); }
        .btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid rgba(125,125,125,0.2); }
        .btn-icon { width: 32px; height: 32px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: transparent; border: none; cursor: pointer; color: var(--text-secondary); }
        .btn-icon:hover { background: rgba(125,125,125,0.1); color: var(--text-primary); }

        /* Tasks */
        .task-item {
            background: var(--bg-body); padding: 14px; margin-bottom: 8px;
            border-radius: var(--radius-md); display: flex; align-items: center; gap: 12px;
            transition: transform 0.2s; border: 1px solid transparent;
        }
        .dark-mode .task-item { background: rgba(255,255,255,0.05); }
        .task-item:hover { transform: translateX(4px); border-color: rgba(125,125,125,0.1); }
        
        .check-circle {
            width: 22px; height: 22px; border-radius: 50%;
            border: 2px solid var(--text-tertiary); cursor: pointer;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .check-circle.checked { background: var(--green); border-color: var(--green); color: white; font-size: 14px; }

        /* Courses */
        .course-card {
            background: var(--bg-sidebar); border-radius: var(--radius-md);
            overflow: hidden; margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .dark-mode .course-card { border-color: rgba(255,255,255,0.08); }
        
        .course-header {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: background 0.2s;
        }
        .course-header:hover { background: rgba(125,125,125,0.03); }
        .course-body { padding: 0 20px 20px 20px; display: none; }
        .course-card.open .course-body { display: block; animation: slideDown 0.3s ease; }

        /* Categories */
        .cat-block { margin-top: 20px; }
        .cat-header {
            font-size: 0.8rem; font-weight: 700; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* Items within Category */
        .item-row {
            display: flex; flex-direction: column; padding: 10px 0;
            border-bottom: 1px solid rgba(125,125,125,0.1);
        }
        .item-top { display: flex; align-items: center; gap: 10px; width: 100%; }
        .item-name { flex: 1; font-size: 0.95rem; }
        .completed .item-name { text-decoration: line-through; opacity: 0.5; }
        
        /* Note Area */
        .note-wrapper {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
        }
        .note-wrapper.open { max-height: 150px; margin-top: 8px; }
        .note-input {
            width: 100%; border: none; background: rgba(125,125,125,0.05);
            border-radius: 8px; padding: 10px; color: var(--text-primary);
            font-family: inherit; font-size: 0.9rem; resize: none;
        }

        /* FAB */
        .fab {
            position: fixed; bottom: 24px; right: 24px;
            width: 56px; height: 56px; border-radius: 28px;
            background: var(--text-primary); color: var(--bg-body);
            border: none; font-size: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            z-index: 200; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        @media (min-width: 900px) { .fab { display: none; } }

        /* Utils */
        .hidden { display: none !important; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Color Dots */
        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-dot.selected { transform: scale(1.2); border-color: var(--text-primary); }

        /* Loader */
        #loader { position: fixed; inset: 0; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loader"><h3>Loading...</h3></div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-layout">
        
        <aside class="sidebar" id="sidebar">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Tasks</h2>
                <button class="btn-icon" id="sidebarClose" style="display:none;">‚úï</button>
            </div>

            <form id="addTaskForm">
                <input type="text" id="taskInput" class="input-inline" placeholder="Add a new task..." autocomplete="off">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
                    <div style="display:flex; gap:6px;">
                        <div class="color-dot selected" style="background:var(--blue)" onclick="setColor('blue', this)"></div>
                        <div class="color-dot" style="background:var(--purple)" onclick="setColor('purple', this)"></div>
                        <div class="color-dot" style="background:var(--orange)" onclick="setColor('orange', this)"></div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="padding:6px 12px; font-size:0.8rem;">Add</button>
                </div>
                <input type="date" id="taskDate" style="border:none; background:transparent; color:var(--text-secondary); font-family:inherit; margin-top:8px; width:100%;">
            </form>

            <div style="flex:1; overflow-y:auto; margin-top:20px; padding-right:4px;">
                
                <div class="task-section-header" onclick="toggleSection(this)">
                    <span>Active</span>
                    <span class="rotate-icon">‚ñº</span>
                </div>
                <div id="activeTaskList" class="task-list-group"></div>

                <div class="task-section-header collapsed" onclick="toggleSection(this)">
                    <span>Completed</span>
                    <span class="rotate-icon">‚ñº</span>
                </div>
                <div id="completedTaskList" class="task-list-group"></div>

            </div>
            
            <div style="text-align:center; padding-top:20px; border-top:1px solid rgba(125,125,125,0.1);">
                <button class="btn btn-ghost" id="themeToggle" style="font-size:0.8rem;">Switch Appearance üåó</button>
            </div>
        </aside>

        <main class="main-content">
            
            <header style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:32px;">
                <div>
                    <p style="font-size:0.8rem; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:1px;" id="currentDate">TODAY</p>
                    <h1 id="greeting">Hello</h1>
                </div>
                <div id="authArea">
                    <button id="loginBtn" class="btn btn-primary">Sign In</button>
                </div>
            </header>

            <div class="glass-box" id="focusCard" style="min-height:200px; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; position:relative; overflow:hidden;">
                </div>

            <div class="glass-box" style="padding:0; overflow:hidden; background:transparent; box-shadow:none; border:none; backdrop-filter:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h2>Courses</h2>
                    <button class="btn btn-ghost" onclick="toggleInput('newCourseRow')">+ New Course</button>
                </div>

                <div id="newCourseRow" class="input-row glass-box" style="padding:16px; margin-bottom:20px;">
                    <input type="text" id="newCourseInput" class="input-inline" placeholder="Course Name (e.g. Physics 101)" onkeydown="handleEnter(event, addCourse)">
                    <div style="margin-top:8px; display:flex; justify-content:flex-end; gap:8px;">
                        <button class="btn btn-ghost" onclick="toggleInput('newCourseRow')">Cancel</button>
                        <button class="btn btn-primary" onclick="addCourse()">Create Course</button>
                    </div>
                </div>

                <div id="coursesContainer">
                    </div>
            </div>

        </main>
    </div>

    <button class="fab" id="fab">Ôºã</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ============================================
        // üî¥ PASTE FIREBASE CONFIG HERE üî¥
        // ============================================
 const firebaseConfig = {
  apiKey: "AIzaSyCu6cbaEw4BzXvF8rGx94h6WHarEFH9Z-k",
  authDomain: "coursesprogress-5658f.firebaseapp.com",
  projectId: "coursesprogress-5658f",
  storageBucket: "coursesprogress-5658f.firebasestorage.app",
  messagingSenderId: "572695866101",
  appId: "1:572695866101:web:bb6dc8058387358b7773bc",
  measurementId: "G-XD8W9V1XPE"
};


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- STATE ---
        let state = {
            user: null,
            todos: [],
            courses: [],
            focusId: null
        };
        let selectedColor = 'blue';

        // --- DOM HELPER ---
        const getEl = (id) => document.getElementById(id);
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

        // --- INIT ---
        function init() {
            // Update Date
            const d = new Date();
            getEl('currentDate').textContent = d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            const h = d.getHours();
            getEl('greeting').textContent = h < 12 ? 'Good Morning' : h < 18 ? 'Good Afternoon' : 'Good Evening';

            // Mobile Sidebar
            const sidebar = getEl('sidebar');
            const overlay = getEl('sidebarOverlay');
            
            const openSidebar = () => {
                sidebar.classList.add('open');
                overlay.classList.add('active');
                if(window.innerWidth < 900) getEl('sidebarClose').style.display = 'block';
            };
            
            const closeSidebar = () => {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            };

            getEl('fab').onclick = openSidebar;
            getEl('sidebarClose').onclick = closeSidebar;
            overlay.onclick = closeSidebar;

            // Sortable
            new Sortable(getEl('activeTaskList'), { animation: 150, delay: 150, delayOnTouchOnly: true });
        }

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            getEl('loader').style.display = 'none';
            if (user) {
                state.user = user;
                getEl('authArea').innerHTML = `
                    <div style="display:flex; align-items:center; gap:8px;">
                        <img src="${user.photoURL}" style="width:32px; height:32px; border-radius:50%;">
                        <button class="btn btn-ghost" id="logoutBtn" style="padding:6px 12px; font-size:0.8rem;">Exit</button>
                    </div>`;
                getEl('logoutBtn').onclick = () => signOut(auth).then(() => location.reload());

                // Sync
                onSnapshot(doc(db, 'users', user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        state.todos = d.todos || [];
                        state.courses = migrateCourses(d.courses || []);
                        state.focusId = d.focusId || null;
                        renderAll();
                    } else saveData();
                });
            } else {
                getEl('loginBtn').onclick = () => signInWithPopup(auth, provider);
            }
        });

        function migrateCourses(courses) {
            // Ensure compatibility with new structure
            return courses.map(c => {
                if (!c.categories) {
                    c.categories = [];
                    // Migrate old props if they exist
                    if(c.lectures) c.categories.push({ id: generateId(), name: 'Lectures', items: c.lectures.map(l => ({ id: generateId(), name: l.name, completed: l.watched || false }))});
                    if(c.homeworks) c.categories.push({ id: generateId(), name: 'Homework', items: c.homeworks.map(h => ({ id: generateId(), name: h.description, completed: h.completed || false }))});
                }
                return c;
            });
        }

        async function saveData() {
            if (!state.user) return;
            const cleanData = {
                todos: state.todos,
                courses: state.courses,
                focusId: state.focusId || null,
                lastUpdated: new Date().toISOString()
            };
            await setDoc(doc(db, 'users', state.user.uid), cleanData, { merge: true });
        }

        // --- RENDER ---
        function renderAll() {
            renderTasks();
            renderFocus();
            renderCourses();
        }

        // 1. Tasks (Collapsible Split)
        function renderTasks() {
            const activeList = getEl('activeTaskList');
            const completedList = getEl('completedTaskList');
            activeList.innerHTML = '';
            completedList.innerHTML = '';

            const colors = { blue: 'var(--blue)', purple: 'var(--purple)', orange: 'var(--orange)', green: 'var(--green)', red: 'var(--red)' };

            state.todos.forEach(t => {
                const div = document.createElement('div');
                div.className = 'task-item';
                const c = colors[t.color] || colors.blue;
                if(!t.completed) div.style.borderLeft = `4px solid ${c}`;
                
                div.innerHTML = `
                    <div class="check-circle ${t.completed?'checked':''}" style="${t.completed?`background:${c};border-color:${c}`:''}" onclick="window.toggleTask('${t.id}')">
                        ${t.completed?'‚úì':''}
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600; font-size:0.95rem; ${t.completed?'text-decoration:line-through; opacity:0.5;':''}">${t.text}</div>
                        ${t.due ? `<div style="font-size:0.75rem; color:var(--text-secondary);">Due ${new Date(t.due).toLocaleDateString()}</div>` : ''}
                    </div>
                    ${!t.completed ? `<button class="btn-icon" onclick="window.setFocus('${t.id}')">üéØ</button>` : ''}
                    <button class="btn-icon" style="color:var(--red);" onclick="window.deleteTask('${t.id}')">‚úï</button>
                `;

                if (t.completed) completedList.appendChild(div);
                else activeList.appendChild(div);
            });
        }

        // 2. Focus
        function renderFocus() {
            const t = state.todos.find(x => x.id === state.focusId);
            const card = getEl('focusCard');
            
            // Clear styles
            card.style.background = 'var(--glass-material)';
            card.style.color = 'var(--text-primary)';

            if (!t || t.completed) {
                card.innerHTML = `
                    <div style="opacity:0.6;">
                        <h3>No Focus Set</h3>
                        <p>Select a task from the list.</p>
                    </div>`;
            } else {
                const colors = { blue: 'var(--blue)', purple: 'var(--purple)', orange: 'var(--orange)', green: 'var(--green)', red: 'var(--red)' };
                const c = colors[t.color] || colors.blue;
                
                card.style.background = c;
                card.style.color = '#FFF';
                
                card.innerHTML = `
                    <div style="text-align:left; width:100%;">
                        <div style="font-size:0.8rem; font-weight:700; opacity:0.8; letter-spacing:1px; margin-bottom:8px;">CURRENT FOCUS</div>
                        <div style="font-size:2rem; font-weight:700; line-height:1.1;">${t.text}</div>
                        ${t.due ? `<div style="margin-top:8px; opacity:0.9;">Due: ${new Date(t.due).toDateString()}</div>` : ''}
                    </div>
                    <div style="margin-top:20px; width:100%; display:flex; justify-content:flex-end;">
                        <button class="btn" style="background:white; color:${c}; border:none;" onclick="window.toggleTask('${t.id}')">Complete</button>
                    </div>
                `;
            }
        }

        // 3. Dynamic Courses
        function renderCourses() {
            const container = getEl('coursesContainer');
            container.innerHTML = '';

            state.courses.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                
                // Header
                const header = document.createElement('div');
                header.className = 'course-header';
                header.innerHTML = `
                    <span style="font-weight:600; font-size:1.1rem;">${course.name}</span>
                    <span style="opacity:0.4;">‚ñº</span>
                `;
                header.onclick = () => card.classList.toggle('open');

                // Body
                const body = document.createElement('div');
                body.className = 'course-body';

                // Render Categories
                course.categories.forEach(cat => {
                    const block = document.createElement('div');
                    block.className = 'cat-block';
                    
                    block.innerHTML = `
                        <div class="cat-header">
                            <span>${cat.name}</span>
                            <button class="btn-icon" style="width:24px;height:24px;" onclick="window.toggleInput('new-item-${cat.id}')">Ôºã</button>
                        </div>
                        
                        <div id="new-item-${cat.id}" class="input-row">
                            <input type="text" class="input-inline" placeholder="New Item Name..." onkeydown="window.handleItemEnter(event, '${course.id}', '${cat.id}')">
                        </div>
                    `;

                    // Items
                    cat.items.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'item-row';
                        row.innerHTML = `
                            <div class="item-top">
                                <div class="check-circle ${item.completed?'checked':''}" onclick="window.toggleItem('${course.id}', '${cat.id}', '${item.id}')">‚úì</div>
                                <span class="item-name">${item.name}</span>
                                <button class="btn-icon" style="width:24px;height:24px;" onclick="document.getElementById('note-${item.id}').classList.toggle('open')">üìù</button>
                                <button class="btn-icon" style="width:24px;height:24px; color:var(--red);" onclick="window.deleteItem('${course.id}', '${cat.id}', '${item.id}')">‚úï</button>
                            </div>
                            <div id="note-${item.id}" class="note-wrapper ${item.note?'open':''}">
                                <textarea class="note-input" placeholder="Add a note..." onblur="window.saveNote('${course.id}', '${cat.id}', '${item.id}', this.value)">${item.note || ''}</textarea>
                            </div>
                        `;
                        block.appendChild(row);
                    });

                    body.appendChild(block);
                });

                // Footer Actions (Add Category / Delete)
                const footer = document.createElement('div');
                footer.style.marginTop = '24px';
                footer.style.display = 'flex';
                footer.style.justifyContent = 'space-between';
                footer.innerHTML = `
                    <button class="btn btn-ghost" style="padding:6px 12px; font-size:0.8rem;" onclick="window.toggleInput('new-cat-${course.id}')">+ Category</button>
                    <button class="btn-icon" style="color:var(--red);" onclick="window.deleteCourse('${course.id}')">üóë</button>
                `;
                
                // Hidden Category Input
                const catInput = document.createElement('div');
                catInput.id = `new-cat-${course.id}`;
                catInput.className = 'input-row';
                catInput.style.marginBottom = '10px';
                catInput.innerHTML = `<input type="text" class="input-inline" placeholder="Category Name (e.g. Week 1)" onkeydown="window.handleCatEnter(event, '${course.id}')">`;

                body.appendChild(catInput);
                body.appendChild(footer);
                card.appendChild(header);
                card.appendChild(body);
                container.appendChild(card);
            });
        }

        // --- GLOBAL ACTIONS (Window Binding) ---
        window.setColor = (c, el) => {
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            selectedColor = c;
        };

        getEl('addTaskForm').onsubmit = (e) => {
            e.preventDefault();
            const txt = getEl('taskInput').value.trim();
            if(txt) {
                state.todos.unshift({
                    id: generateId(), text: txt, color: selectedColor,
                    completed: false, due: getEl('taskDate').value,
                    createdAt: new Date().toISOString()
                });
                getEl('taskInput').value = '';
                if(!state.focusId) state.focusId = state.todos[0].id;
                saveData(); renderAll();
            }
        };

        // Toggle Sections
        window.toggleSection = (el) => {
            el.classList.toggle('collapsed');
        };

        // Task Ops
        window.toggleTask = (id) => {
            const t = state.todos.find(x => x.id === id);
            t.completed = !t.completed;
            if(t.completed) {
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
                if(state.focusId === id) state.focusId = null;
            }
            saveData(); renderAll();
        };
        window.deleteTask = (id) => { state.todos = state.todos.filter(x=>x.id!==id); saveData(); renderAll(); };
        window.setFocus = (id) => { state.focusId = id; saveData(); renderAll(); 
            if(window.innerWidth < 900) { getEl('sidebar').classList.remove('open'); getEl('sidebarOverlay').classList.remove('active'); }
        };

        // Input Toggles
        window.toggleInput = (id) => {
            const el = getEl(id);
            el.classList.toggle('visible');
            if(el.classList.contains('visible')) el.querySelector('input').focus();
        };

        // Course Ops
        window.addCourse = () => {
            const input = getEl('newCourseInput');
            if(input.value.trim()) {
                state.courses.push({ id: generateId(), name: input.value.trim(), categories: [] });
                input.value = '';
                window.toggleInput('newCourseRow');
                saveData(); renderCourses();
            }
        };
        window.handleEnter = (e, func) => { if(e.key === 'Enter') func(); };

        window.deleteCourse = (cid) => {
            if(confirm("Delete course?")) { state.courses = state.courses.filter(c=>c.id!==cid); saveData(); renderCourses(); }
        };

        // Category Ops
        window.handleCatEnter = (e, cid) => {
            if(e.key === 'Enter' && e.target.value.trim()) {
                state.courses.find(c=>c.id===cid).categories.push({ id: generateId(), name: e.target.value.trim(), items: [] });
                e.target.value = '';
                window.toggleInput(`new-cat-${cid}`);
                saveData(); renderCourses();
            }
        };

        // Item Ops
        window.handleItemEnter = (e, cid, catId) => {
            if(e.key === 'Enter' && e.target.value.trim()) {
                const course = state.courses.find(c=>c.id===cid);
                const cat = course.categories.find(c=>c.id===catId);
                cat.items.push({ id: generateId(), name: e.target.value.trim(), completed: false, note: '' });
                e.target.value = '';
                window.toggleInput(`new-item-${catId}`);
                saveData(); renderCourses();
            }
        };

        window.toggleItem = (cid, catId, itemId) => {
            const cat = state.courses.find(c=>c.id===cid).categories.find(c=>c.id===catId);
            const item = cat.items.find(i=>i.id===itemId);
            item.completed = !item.completed;
            saveData(); renderCourses();
        };

        window.deleteItem = (cid, catId, itemId) => {
            const cat = state.courses.find(c=>c.id===cid).categories.find(c=>c.id===catId);
            cat.items = cat.items.filter(i=>i.id!==itemId);
            saveData(); renderCourses();
        };

        window.saveNote = (cid, catId, itemId, txt) => {
            const cat = state.courses.find(c=>c.id===cid).categories.find(c=>c.id===catId);
            const item = cat.items.find(i=>i.id===itemId);
            if(item.note !== txt) { item.note = txt; saveData(); }
        };

        // Theme
        getEl('themeToggle').onclick = () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('studySparkTheme', document.body.classList.contains('dark-mode')?'dark':'light');
        };
        if(localStorage.getItem('studySparkTheme')==='dark') document.body.classList.add('dark-mode');

        // Start
        init();

    </script>
</body>
</html>
