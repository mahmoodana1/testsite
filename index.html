<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <title>Study Spark | Workspace</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* =========================================
           1. CSS VARIABLES & THEME ENGINE
           ========================================= */
        :root {
            /* --- PALETTE: Apple/Ikea Modern (Light) --- */
            --bg-body: #F5F5F7;       /* System Grey 6 */
            --bg-sidebar: #FFFFFF;
            
            /* Glassmorphism Variables */
            --glass-material: rgba(255, 255, 255, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
            --blur-strength: 30px;

            /* Typography */
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --text-tertiary: #B0B0B5;

            /* Accents (Solid, High Contrast) */
            --accent-blue: #0071e3;
            --accent-purple: #5e5ce6;
            --accent-green: #34c759;
            --accent-orange: #ff9f0a;
            --accent-red: #ff3b30;
            --accent-teal: #30b0c7;

            /* Components */
            --radius-sm: 12px;
            --radius-md: 18px;
            --radius-lg: 28px;
            --card-hover-transform: translateY(-4px);
            --transition-speed: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        body.dark-mode {
            /* --- PALETTE: Apple Dark Mode --- */
            --bg-body: #000000;
            --bg-sidebar: #1C1C1E;

            /* Glassmorphism Variables */
            --glass-material: rgba(28, 28, 30, 0.70);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);

            /* Typography */
            --text-primary: #F5F5F7;
            --text-secondary: #98989D;
            --text-tertiary: #58585E;

            /* Accents (Adjusted for dark mode luminosity) */
            --accent-blue: #0a84ff;
            --accent-purple: #bf5af2;
            --accent-green: #30d158;
            --accent-orange: #ff9f0a;
            --accent-red: #ff453a;
        }

        /* =========================================
           2. GLOBAL RESETS & BASE STYLES
           ========================================= */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none; /* App-like feel */
        }

        /* Allow text selection only in inputs and notes */
        input, textarea { user-select: text; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: background-color 0.4s ease, color 0.2s ease;
            min-height: 100vh;
            overflow-x: hidden;
            /* Prevent rubber-banding on iOS */
            overscroll-behavior-y: none; 
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Typography Helpers */
        h1 { font-size: 2.2rem; font-weight: 700; letter-spacing: -0.02em; margin: 0; line-height: 1.1; }
        h2 { font-size: 1.4rem; font-weight: 600; letter-spacing: -0.01em; margin: 0; }
        h3 { font-size: 1.1rem; font-weight: 600; margin: 0; }
        p { font-size: 1rem; color: var(--text-secondary); margin: 0; line-height: 1.5; }
        
        .text-sm { font-size: 0.85rem; }
        .text-xs { font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; }
        .text-muted { color: var(--text-secondary); }

        /* =========================================
           3. LAYOUT & GRID SYSTEM
           ========================================= */
        .app-layout {
            display: grid;
            grid-template-columns: 1fr; /* Mobile Default */
            height: 100vh;
            overflow: hidden;
        }

        /* Desktop Layout (Sidebar + Main Content) */
        @media (min-width: 900px) {
            .app-layout {
                grid-template-columns: 380px 1fr;
            }
        }

        /* Main Content Area */
        .main-content {
            padding: 24px;
            overflow-y: auto;
            height: 100vh;
            padding-bottom: 120px; /* Space for FAB on mobile */
            position: relative;
        }

        @media (min-width: 900px) {
            .main-content {
                padding: 48px;
            }
        }

        /* Section Container (Glass) */
        .glass-section {
            background: var(--glass-material);
            backdrop-filter: blur(var(--blur-strength));
            -webkit-backdrop-filter: blur(var(--blur-strength));
            border: var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--glass-shadow);
            padding: 24px;
            margin-bottom: 24px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        /* Hover effect for desktop liveliness */
        @media (hover: hover) {
            .glass-section:hover {
                transform: var(--card-hover-transform);
                box-shadow: 0 15px 40px rgba(0,0,0,0.08);
            }
        }

        /* Masonry-style Grid for Courses/Stats */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        /* =========================================
           4. SIDEBAR (TASKS)
           ========================================= */
        .sidebar {
            background: var(--bg-sidebar);
            border-right: 1px solid rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            height: 100%;
            z-index: 100;
            padding: 32px 24px;
            transition: transform var(--transition-speed);
        }

        /* Mobile Drawer Behavior */
        @media (max-width: 899px) {
            .sidebar {
                position: fixed;
                top: 0; left: 0; bottom: 0;
                width: 85%;
                max-width: 360px;
                transform: translateX(-100%);
                box-shadow: 20px 0 50px rgba(0,0,0,0.2);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            /* Overlay for mobile drawer */
            .sidebar-overlay {
                position: fixed; inset: 0;
                background: rgba(0,0,0,0.3);
                backdrop-filter: blur(5px);
                z-index: 90;
                opacity: 0; pointer-events: none;
                transition: opacity 0.3s;
            }
            .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
        }

        .dark-mode .sidebar {
            border-right: 1px solid rgba(255,255,255,0.05);
        }

        /* Task List Container */
        .task-list-container {
            flex: 1;
            overflow-y: auto;
            margin-top: 24px;
            padding-bottom: 20px;
        }

        /* =========================================
           5. UI COMPONENTS: INPUTS & BUTTONS
           ========================================= */
        /* Clean Inputs */
        .input-group {
            background: rgba(125, 125, 125, 0.08);
            border-radius: var(--radius-md);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            border: 1px solid transparent;
        }
        .input-group:focus-within {
            background: var(--bg-sidebar);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
        }
        .input-clean {
            border: none; background: transparent;
            font-size: 1rem; color: var(--text-primary);
            width: 100%; font-family: inherit;
            padding: 8px 0;
        }
        .input-clean::placeholder { color: var(--text-tertiary); }

        /* Date Picker */
        input[type="date"] {
            border: none; background: rgba(125,125,125,0.1);
            color: var(--text-secondary);
            font-family: inherit; font-size: 0.85rem; font-weight: 600;
            padding: 6px 10px; border-radius: 8px;
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            border: none; padding: 12px 24px;
            border-radius: var(--radius-md);
            font-size: 0.95rem; font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.96); }
        
        .btn-primary { background: var(--text-primary); color: var(--bg-body); }
        .btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid rgba(125,125,125,0.2); }
        .btn-ghost:hover { background: rgba(125,125,125,0.1); color: var(--text-primary); }
        
        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .btn-icon:hover { background: rgba(125,125,125,0.1); }

        /* FAB (Mobile Only) */
        .fab {
            position: fixed; bottom: 24px; right: 24px;
            width: 64px; height: 64px; border-radius: 32px;
            background: var(--text-primary); color: var(--bg-body);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: none; font-size: 28px; cursor: pointer; z-index: 200;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }
        @media (min-width: 900px) { .fab { display: none; } }

        /* =========================================
           6. SPECIFIC FEATURES: TASKS & COURSES
           ========================================= */
        
        /* --- Task Item --- */
        .task-item {
            background: var(--bg-body);
            padding: 16px; margin-bottom: 12px;
            border-radius: var(--radius-md);
            display: flex; align-items: center; gap: 16px;
            border: 1px solid rgba(0,0,0,0.03);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab;
        }
        .dark-mode .task-item { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); }
        .task-item:hover { transform: translateX(4px); }
        .task-item.sortable-ghost { opacity: 0.3; }

        /* Custom Checkbox */
        .checkbox-circle {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid var(--text-tertiary);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; flex-shrink: 0;
        }
        .checkbox-circle.checked {
            background: var(--accent-green); border-color: var(--accent-green);
            color: white; font-size: 14px;
        }

        /* --- Current Focus Card (Hero) --- */
        .focus-hero {
            min-height: 240px;
            background: var(--bg-sidebar); /* Solid contrast against glass */
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; overflow: hidden;
        }
        .focus-hero::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            background: var(--accent-blue); /* Dynamic color */
        }
        .focus-title { font-size: 2.5rem; font-weight: 800; line-height: 1.1; margin-bottom: 16px; }
        
        /* --- ENHANCED COURSES SYSTEM --- */
        .course-card {
            background: var(--bg-sidebar);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.05);
            transition: box-shadow 0.2s;
        }
        .dark-mode .course-card { border: 1px solid rgba(255,255,255,0.05); }

        .course-header {
            padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; background: rgba(125,125,125,0.03);
            border-bottom: 1px solid rgba(125,125,125,0.08);
        }
        .course-header:hover { background: rgba(125,125,125,0.06); }

        .course-title-section {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .course-progress-ring {
            width: 40px;
            height: 40px;
            position: relative;
            flex-shrink: 0;
        }

        .progress-ring-circle {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .course-info h3 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .course-stats {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .course-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Dynamic Content Area */
        .course-body { 
            padding: 0;
            display: none; 
            animation: slideDown 0.3s ease; 
        }
        .course-card.open .course-body { display: block; }

        /* Goals Section (Compact) */
        .goals-section {
            padding: 16px 20px;
            background: rgba(125,125,125,0.02);
        }

        .goal-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(125,125,125,0.06);
        }

        .goal-item:last-child {
            border-bottom: none;
        }

        .goal-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .goal-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .goal-subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .goal-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-mini {
            width: 28px;
            height: 28px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
        }

        /* Course Actions Footer */
        .course-footer {
            padding: 16px 20px;
            border-top: 1px solid rgba(125,125,125,0.08);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Color Picker (Compact) */
        .color-selector { display: flex; gap: 8px; margin-top: 12px; }
        .color-dot {
            width: 26px; height: 26px; border-radius: 50%;
            cursor: pointer; transition: transform 0.2s;
            border: 2px solid transparent;
        }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.selected { transform: scale(1.2); border-color: var(--text-primary); }

        /* Animations */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        /* Loading Overlay */
        #loader {
            position: fixed; inset: 0; background: var(--bg-body); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(125,125,125,0.2);
            border-top: 4px solid var(--accent-blue); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 16px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Responsive Adjustments */
        @media (max-width: 899px) {
            .course-progress-ring {
                width: 36px;
                height: 36px;
            }
            
            .course-info h3 {
                font-size: 1rem;
            }
            
            .course-stats {
                font-size: 0.7rem;
            }
            
            .goal-item {
                padding: 8px 0;
            }
            
            .btn-sm {
                padding: 4px 10px;
                font-size: 0.75rem;
            }
        }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <h3 style="font-weight: 500;">Loading Spark...</h3>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-layout">
        
        <aside class="sidebar" id="sidebar">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2>Task Queue</h2>
                <button class="btn-icon btn-ghost" id="sidebarClose" style="display:none;">‚úï</button>
            </div>

            <form id="addTaskForm">
                <div class="input-group">
                    <input type="text" id="taskInput" class="input-clean" placeholder="What needs doing?" autocomplete="off">
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                    <input type="date" id="taskDate">
                    <button type="submit" class="btn btn-primary btn-sm">Add Task</button>
                </div>

                <div class="color-selector">
                    <div class="color-dot selected" style="background: var(--accent-blue);" onclick="setColor('blue', this)"></div>
                    <div class="color-dot" style="background: var(--accent-purple);" onclick="setColor('purple', this)"></div>
                    <div class="color-dot" style="background: var(--accent-green);" onclick="setColor('green', this)"></div>
                    <div class="color-dot" style="background: var(--accent-orange);" onclick="setColor('orange', this)"></div>
                    <div class="color-dot" style="background: var(--accent-red);" onclick="setColor('red', this)"></div>
                </div>
            </form>

            <div class="task-list-container" id="taskListContainer">
                <div id="taskList"></div>
                <div id="emptyTasks" class="hidden" style="text-align:center; margin-top:40px; color:var(--text-tertiary);">
                    <div style="font-size:3rem; margin-bottom:10px;">üçÉ</div>
                    <p>All tasks completed.<br>Enjoy your free time!</p>
                </div>
            </div>
            
            <div style="margin-top:auto; padding-top:20px; border-top:1px solid rgba(125,125,125,0.1); text-align:center;">
                <button class="btn btn-ghost btn-sm" id="themeToggle">Dark Mode üåô</button>
            </div>
        </aside>


        <main class="main-content">
            
            <header style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px;">
                <div>
                    <p class="text-xs text-muted" id="currentDate">FRIDAY, OCT 24</p>
                    <h1 id="greeting">Good Morning</h1>
                </div>
                <div id="authContainer">
                    <button id="loginBtn" class="btn btn-primary">Sign In</button>
                </div>
            </header>

            <section class="glass-section focus-hero" id="focusSection">
                <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; opacity:0.6;">
                    <h3>No Active Focus</h3>
                    <p>Click the üéØ icon on a task to set focus.</p>
                </div>
            </section>

            <div class="bento-grid" style="margin-bottom: 24px;">
                <div class="glass-section" style="text-align: center; margin:0;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span class="text-xs text-muted">POMODORO</span>
                        <button class="btn-icon" style="width:24px;height:24px;" onclick="toggleTimerSettings()">‚öôÔ∏è</button>
                    </div>
                    
                    <div style="font-size: 3.5rem; font-weight: 800; font-variant-numeric: tabular-nums; margin: 10px 0; background: linear-gradient(135deg, var(--text-primary), var(--text-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" id="timerDisplay">25:00</div>
                    
                    <div id="timerSettings" class="hidden" style="margin-bottom:12px;">
                        <input type="number" id="workDur" value="25" style="width:50px; padding:4px; text-align:center; border-radius:6px; border:1px solid rgba(125,125,125,0.2);"> min
                    </div>

                    <div style="display:flex; gap:12px; justify-content:center;">
                        <button id="startTimer" class="btn btn-primary btn-sm">Start</button>
                        <button id="resetTimer" class="btn btn-ghost btn-sm">Reset</button>
                    </div>
                </div>

                <div class="glass-section" style="margin:0; display:flex; flex-direction:column; justify-content:center;">
                    <span class="text-xs text-muted">DAILY PROGRESS</span>
                    <div style="margin-top:16px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span style="font-weight:600;" id="progressText">0/5 Tasks</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div style="width:100%; height:8px; background:rgba(125,125,125,0.1); border-radius:4px; overflow:hidden;">
                            <div id="progressBar" style="width:0%; height:100%; background:var(--accent-green); transition: width 0.5s;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <section>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
                    <h2>Courses & Projects</h2>
                    <button class="btn btn-ghost btn-sm" onclick="addCourse()">+ New Course</button>
                </div>

                <div id="coursesContainer"></div>
                
                <div id="emptyCourses" class="glass-section hidden" style="text-align:center; color:var(--text-secondary); padding:40px;">
                    No courses yet. Add one to organize your lectures and labs!
                </div>
            </section>

        </main>
    </div>

    <button class="fab" id="fab">Ôºã</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ============================================
        // üî¥ PASTE FIREBASE CONFIG HERE üî¥
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCu6cbaEw4BzXvF8rGx94h6WHarEFH9Z-k",
            authDomain: "coursesprogress-5658f.firebaseapp.com",
            projectId: "coursesprogress-5658f",
            storageBucket: "coursesprogress-5658f.firebasestorage.app",
            messagingSenderId: "572695866101",
            appId: "1:572695866101:web:bb6dc8058387358b7773bc",
            measurementId: "G-XD8W9V1XPE"
        };

        // --- INIT FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- APP STATE ---
        let state = {
            user: null,
            todos: [],
            courses: [],
            focusId: null,
            theme: 'light',
            dailyGoal: 5
        };
        let selectedColor = 'blue';

        // --- UTILS ---
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        const getEl = (id) => document.getElementById(id);
        const colorMap = {
            blue: 'var(--accent-blue)',
            purple: 'var(--accent-purple)',
            green: 'var(--accent-green)',
            orange: 'var(--accent-orange)',
            red: 'var(--accent-red)'
        };

        // --- INITIALIZATION ---
        function init() {
            // UI Init
            updateGreeting();
            setInterval(updateGreeting, 60000);
            
            // Sidebar Logic (Mobile)
            const sidebar = getEl('sidebar');
            const overlay = getEl('sidebarOverlay');
            
            const openSidebar = () => {
                sidebar.classList.add('open');
                overlay.classList.add('active');
                if(window.innerWidth < 900) getEl('sidebarClose').style.display = 'flex';
            };
            
            const closeSidebar = () => {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            };

            getEl('fab').onclick = openSidebar;
            getEl('sidebarClose').onclick = closeSidebar;
            overlay.onclick = closeSidebar;

            // Sortable Init
            new Sortable(getEl('taskList'), {
                animation: 150,
                ghostClass: 'sortable-ghost',
                delay: 150,
                delayOnTouchOnly: true,
                onEnd: (evt) => {
                    const item = state.todos.splice(evt.oldIndex, 1)[0];
                    state.todos.splice(evt.newIndex, 0, item);
                    saveData();
                }
            });
        }

        const updateGreeting = () => {
            const d = new Date();
            getEl('currentDate').textContent = d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }).toUpperCase();
            const h = d.getHours();
            getEl('greeting').textContent = h < 12 ? 'Good Morning' : h < 18 ? 'Good Afternoon' : 'Good Evening';
        };

        // --- AUTHENTICATION & SYNC ---
        onAuthStateChanged(auth, (user) => {
            getEl('loader').style.display = 'none';
            if (user) {
                state.user = user;
                getEl('authContainer').innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; background:rgba(125,125,125,0.1); padding:4px 12px 4px 4px; border-radius:50px;">
                        <img src="${user.photoURL}" style="width:28px; height:28px; border-radius:50%;">
                        <span class="text-sm" style="font-weight:600; cursor:pointer;" id="logoutBtn">Sign Out</span>
                    </div>`;
                getEl('logoutBtn').onclick = () => signOut(auth).then(() => location.reload());

                onSnapshot(doc(db, 'users', user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        state.todos = d.todos || [];
                        state.courses = d.courses || [];
                        state.focusId = d.focusId || null;
                        renderAll();
                    } else {
                        saveData();
                    }
                });
            } else {
                getEl('loginBtn').onclick = () => signInWithPopup(auth, provider);
            }
        });

        async function saveData() {
            if (!state.user) return;
            const cleanState = {
                todos: state.todos,
                courses: state.courses,
                focusId: state.focusId || null,
                lastUpdated: new Date().toISOString()
            };
            await setDoc(doc(db, 'users', state.user.uid), cleanState, { merge: true });
        }

        // --- RENDER ENGINE ---
        function renderAll() {
            renderTasks();
            renderFocus();
            renderCourses();
            updateProgress();
        }

        // 1. Task List
        function renderTasks() {
            const container = getEl('taskList');
            container.innerHTML = '';
            
            if (state.todos.length === 0) {
                getEl('emptyTasks').classList.remove('hidden');
            } else {
                getEl('emptyTasks').classList.add('hidden');
                
                state.todos.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'task-item';
                    const c = colorMap[t.color] || colorMap.blue;
                    div.style.borderLeft = `4px solid ${c}`;
                    
                    div.innerHTML = `
                        <div class="checkbox-circle ${t.completed ? 'checked' : ''}" style="${t.completed ? `background:${c}; border-color:${c}` : ''}">
                            ${t.completed ? '‚úì' : ''}
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:600; font-size:0.95rem; ${t.completed ? 'text-decoration:line-through; opacity:0.6;' : ''}">${t.text}</div>
                            ${t.due ? `<div class="text-xs text-muted" style="margin-top:2px;">Due ${new Date(t.due).toLocaleDateString()}</div>` : ''}
                        </div>
                        <button class="btn-icon task-focus-btn" title="Focus">üéØ</button>
                        <button class="btn-icon task-del-btn" style="color:var(--accent-red);">‚úï</button>
                    `;

                    div.querySelector('.checkbox-circle').onclick = () => toggleTask(t.id);
                    div.querySelector('.task-focus-btn').onclick = () => setFocus(t.id);
                    div.querySelector('.task-del-btn').onclick = () => deleteTask(t.id);

                    container.appendChild(div);
                });
            }
        }

        // 2. Focus Hero
        function renderFocus() {
            const t = state.todos.find(x => x.id === state.focusId);
            const section = getEl('focusSection');
            section.style.borderLeft = 'none';

            if (!t || t.completed) {
                section.innerHTML = `
                    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; opacity:0.6;">
                        <h3>No Active Focus</h3>
                        <p>Select a task to focus on.</p>
                    </div>`;
            } else {
                const c = colorMap[t.color] || colorMap.blue;
                section.innerHTML = `
                    <div style="position:absolute; left:0; top:0; bottom:0; width:6px; background:${c};"></div>
                    <div>
                        <div class="text-xs" style="color:${c}; margin-bottom:12px;">CURRENT FOCUS</div>
                        <div class="focus-title">${t.text}</div>
                        ${t.due ? `<div class="text-muted">Due: ${new Date(t.due).toDateString()}</div>` : ''}
                    </div>
                    <div style="text-align:right; margin-top:24px;">
                        <button id="completeFocusBtn" class="btn" style="background:${c}; color:white;">Mark Complete</button>
                    </div>
                `;
                getEl('completeFocusBtn').onclick = () => toggleTask(t.id);
            }
        }

        // 3. Enhanced Courses with Progress
        function renderCourses() {
            const container = getEl('coursesContainer');
            container.innerHTML = '';
            
            if (state.courses.length === 0) {
                getEl('emptyCourses').classList.remove('hidden');
                return;
            }
            getEl('emptyCourses').classList.add('hidden');

            state.courses.forEach(course => {
                // Calculate progress
                const totalGoals = course.goals.length;
                const completedGoals = course.goals.filter(g => g.completed).length;
                const progress = totalGoals > 0 ? (completedGoals / totalGoals) * 100 : 0;
                
                const card = document.createElement('div');
                card.className = 'course-card';
                
                // Header with progress ring
                const header = document.createElement('div');
                header.className = 'course-header';
                header.innerHTML = `
                    <div class="course-title-section">
                        <div class="course-progress-ring">
                            <svg width="100%" height="100%" viewBox="0 0 36 36">
                                <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(125,125,125,0.1)" stroke-width="3"/>
                                <circle class="progress-ring-circle" cx="18" cy="18" r="16" fill="none" 
                                    stroke="${colorMap[course.color] || colorMap.blue}" 
                                    stroke-width="3" 
                                    stroke-dasharray="${progress * 1.005} 100.5"
                                    stroke-linecap="round"/>
                                <text x="18" y="22" text-anchor="middle" font-size="10" font-weight="700" fill="var(--text-primary)">${Math.round(progress)}%</text>
                            </svg>
                        </div>
                        <div class="course-info">
                            <h3>${course.name}</h3>
                            <div class="course-stats">
                                <span class="course-stat">üìö ${totalGoals} goals</span>
                                <span class="course-stat">‚úì ${completedGoals} done</span>
                            </div>
                        </div>
                    </div>
                    <span style="opacity:0.5; transition: transform 0.2s;">‚ñº</span>
                `;
                header.onclick = (e) => {
                    if (!e.target.closest('button')) {
                        card.classList.toggle('open');
                        const arrow = header.querySelector('span:last-child');
                        arrow.style.transform = card.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
                    }
                };

                // Body with goals
                const body = document.createElement('div');
                body.className = 'course-body';

                // Goals section
                const goalsSection = document.createElement('div');
                goalsSection.className = 'goals-section';

                course.goals.forEach(goal => {
                    const goalItem = document.createElement('div');
                    goalItem.className = 'goal-item';
                    goalItem.innerHTML = `
                        <div class="checkbox-circle ${goal.completed ? 'checked' : ''}">
                            ${goal.completed ? '‚úì' : ''}
                        </div>
                        <div class="goal-content">
                            <div class="goal-title ${goal.completed ? 'text-muted' : ''}" style="${goal.completed ? 'text-decoration:line-through;' : ''}">${goal.title}</div>
                            ${goal.subtitle ? `<div class="goal-subtitle">${goal.subtitle}</div>` : ''}
                        </div>
                        <div class="goal-actions">
                            <button class="btn btn-ghost btn-mini" title="Convert to Task">üìã</button>
                            <button class="btn btn-ghost btn-mini" title="Delete" style="color:var(--accent-red);">‚úï</button>
                        </div>
                    `;

                    goalItem.querySelector('.checkbox-circle').onclick = () => toggleGoal(course.id, goal.id);
                    goalItem.querySelectorAll('.btn-mini')[0].onclick = () => convertGoalToTask(course.id, goal.id);
                    goalItem.querySelectorAll('.btn-mini')[1].onclick = () => deleteGoal(course.id, goal.id);

                    goalsSection.appendChild(goalItem);
                });

                body.appendChild(goalsSection);

                // Footer actions
                const footer = document.createElement('div');
                footer.className = 'course-footer';
                footer.innerHTML = `
                    <button class="btn btn-ghost btn-sm">+ Add Goal</button>
                    <button class="btn btn-ghost btn-sm" style="color:var(--accent-red);">Delete Course</button>
                `;
                footer.children[0].onclick = () => addGoal(course.id);
                footer.children[1].onclick = () => deleteCourse(course.id);

                body.appendChild(footer);
                card.appendChild(header);
                card.appendChild(body);
                container.appendChild(card);
            });
        }

        function updateProgress() {
            const total = state.todos.length;
            const completed = state.todos.filter(t => t.completed).length;
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);
            
            getEl('progressText').textContent = `${completed}/${total} Tasks`;
            getEl('progressPercent').textContent = `${percent}%`;
            getEl('progressBar').style.width = `${percent}%`;
        }

        // --- ACTION HANDLERS ---

        // Task Actions
        window.setColor = (c, el) => {
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            selectedColor = c;
        };

        getEl('addTaskForm').onsubmit = (e) => {
            e.preventDefault();
            const input = getEl('taskInput');
            const date = getEl('taskDate');
            if (input.value.trim()) {
                state.todos.unshift({
                    id: generateId(),
                    text: input.value.trim(),
                    color: selectedColor,
                    due: date.value,
                    completed: false,
                    createdAt: new Date().toISOString()
                });
                input.value = '';
                if (!state.focusId) state.focusId = state.todos[0].id;
                saveData();
                renderAll();
            }
        };

        window.toggleTask = (id) => {
            const t = state.todos.find(x => x.id === id);
            if (t) {
                t.completed = !t.completed;
                if (t.completed) {
                    confetti({ particleCount: 60, spread: 70, origin: { y: 0.6 } });
                    if (state.focusId === id) state.focusId = null;
                }
                saveData();
                renderAll();
            }
        };

        window.deleteTask = (id) => {
            state.todos = state.todos.filter(x => x.id !== id);
            saveData();
            renderAll();
        };

        window.setFocus = (id) => {
            state.focusId = id;
            saveData();
            renderAll();
            if(window.innerWidth < 900) {
                getEl('sidebar').classList.remove('open');
                getEl('sidebarOverlay').classList.remove('active');
            }
        };

        // Course Actions
        window.addCourse = () => {
            const name = prompt("Course Name (e.g. Physics 101):");
            if (name) {
                state.courses.push({
                    id: generateId(),
                    name: name,
                    color: 'blue',
                    goals: []
                });
                saveData();
                renderCourses();
            }
        };

        window.deleteCourse = (cid) => {
            if(confirm('Delete this course?')) {
                state.courses = state.courses.filter(c => c.id !== cid);
                saveData();
                renderCourses();
            }
        };

        window.addGoal = (cid) => {
            const title = prompt("Goal title:");
            if (title) {
                const subtitle = prompt("Goal subtitle (optional, e.g., 'Due Friday'):");
                const course = state.courses.find(x => x.id === cid);
                course.goals.push({
                    id: generateId(),
                    title: title,
                    subtitle: subtitle || '',
                    completed: false,
                    createdAt: new Date().toISOString()
                });
                saveData();
                renderCourses();
            }
        };

        window.toggleGoal = (cid, gid) => {
            const course = state.courses.find(x => x.id === cid);
            const goal = course.goals.find(x => x.id === gid);
            goal.completed = !goal.completed;
            if (goal.completed) {
                confetti({ particleCount: 40, spread: 60, origin: { y: 0.6 } });
            }
            saveData();
            renderCourses();
        };

        window.deleteGoal = (cid, gid) => {
            const course = state.courses.find(x => x.id === cid);
            course.goals = course.goals.filter(x => x.id !== gid);
            saveData();
            renderCourses();
        };

        window.convertGoalToTask = (cid, gid) => {
            const course = state.courses.find(x => x.id === cid);
            const goal = course.goals.find(x => x.id === gid);
            
            // Create task from goal
            state.todos.unshift({
                id: generateId(),
                text: `[${course.name}] ${goal.title}${goal.subtitle ? ' - ' + goal.subtitle : ''}`,
                color: course.color,
                due: '',
                completed: false,
                createdAt: new Date().toISOString()
            });
            
            // Remove goal from course
            course.goals = course.goals.filter(x => x.id !== gid);
            
            saveData();
            renderAll();
            
            // Show notification
            alert(`‚úì Moved to Task Queue: ${goal.title}`);
        };

        // --- TIMER LOGIC ---
        let timer, timeLeft, isRunning = false;
        
        window.toggleTimerSettings = () => getEl('timerSettings').classList.toggle('hidden');
        
        getEl('startTimer').onclick = function() {
            if(isRunning) {
                clearInterval(timer); isRunning=false; this.textContent = "Start";
            } else {
                if(!timeLeft) timeLeft = getEl('workDur').value * 60;
                isRunning = true; this.textContent = "Pause";
                timer = setInterval(() => {
                    if(timeLeft > 0) {
                        timeLeft--;
                        const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
                        const s = (timeLeft%60).toString().padStart(2,'0');
                        getEl('timerDisplay').innerText = `${m}:${s}`;
                    } else {
                        clearInterval(timer); isRunning = false; this.textContent = "Start";
                        alert("Timer finished!");
                    }
                }, 1000);
            }
        };
        
        getEl('resetTimer').onclick = () => {
            clearInterval(timer); isRunning = false;
            timeLeft = getEl('workDur').value * 60;
            getEl('timerDisplay').innerText = `${Math.floor(timeLeft/60).toString().padStart(2,'0')}:00`;
            getEl('startTimer').textContent = "Start";
        };

        // --- THEME LOGIC ---
        getEl('themeToggle').onclick = () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('studySparkTheme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        };
        if(localStorage.getItem('studySparkTheme') === 'dark') document.body.classList.add('dark-mode');

        // Start
        init();

    </script>
</body>
</html>
